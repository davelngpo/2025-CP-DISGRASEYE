{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}Dashboard | DisgrasEye{% endblock %}

{% block extra_head %}
<style>
    /* Enhanced mobile styles */
    @media (max-width: 640px) {
        .gradient-bg {
            padding: 1.5rem !important;
        }
        
        .gradient-bg h1 {
            font-size: 1.75rem !important;
        }
        
        .stats-grid {
            gap: 0.75rem !important;
        }
        
        .stat-card {
            padding: 1rem !important;
        }
        
        .stat-card h2 {
            font-size: 1.5rem !important;
        }
        
        .quick-actions-grid {
            gap: 0.5rem !important;
        }
        
        .quick-action-btn {
            padding: 0.75rem !important;
        }
        
        .quick-action-btn i {
            font-size: 1.25rem !important;
        }
    }
    
    /* Loading animations */
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .fade-in {
        animation: fadeIn 0.3s ease-out;
    }
    
    /* Refresh button animation */
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    
    .spinning {
        animation: spin 0.5s linear infinite;
    }
    
    /* Alert priority colors */
    .priority-critical {
        background: linear-gradient(135deg, #ff4444, #ff0000);
        color: white;
    }
    
    .priority-high {
        background: linear-gradient(135deg, #ff8800, #ff5500);
        color: white;
    }
    
    .priority-medium {
        background: linear-gradient(135deg, #ffbb33, #ffaa00);
        color: white;
    }
    
    .priority-low {
        background: linear-gradient(135deg, #00C851, #007E33);
        color: white;
    }
    
    /* Review button pulse */
    .review-pulse {
        animation: reviewPulse 2s infinite;
    }
    
    @keyframes reviewPulse {
        0% { box-shadow: 0 0 0 0 rgba(56, 189, 248, 0.7); }
        70% { box-shadow: 0 0 0 10px rgba(56, 189, 248, 0); }
        100% { box-shadow: 0 0 0 0 rgba(56, 189, 248, 0); }
    }
    
    /* Re-review button */
    .re-review-btn {
        animation: gentlePulse 2s infinite;
    }
    
    @keyframes gentlePulse {
        0% { opacity: 1; }
        50% { opacity: 0.7; }
        100% { opacity: 1; }
    }
    
    /* Modal styles */
    .modal-overlay {
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(5px);
    }
    
    .loading-spinner {
        border: 3px solid rgba(56, 189, 248, 0.3);
        border-radius: 50%;
        border-top: 3px solid #FCD34D;
        width: 24px;
        height: 24px;
        animation: spin 1s linear infinite;
        display: inline-block;
    }
    
    /* Toast notification */
    .toast-notification {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        animation: slideIn 0.3s ease-out;
    }
    
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }

    /* Status badges */
    .status-badge {
        @apply inline-flex items-center px-2 py-1 rounded-full text-xs font-medium;
    }
    
    .status-badge i {
        @apply mr-1 text-xs;
    }

    /* Message type indicators */
    .message-type-initial {
        border-left: 3px solid #38BDF8;
    }
    
    .message-type-confirmed {
        border-left: 3px solid #22C55E;
    }
    
    .message-type-cancelled {
        border-left: 3px solid #EF4444;
    }

    /* Custom Confirm Modal */
    .confirm-modal-overlay {
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(5px);
        animation: fadeIn 0.2s ease-out;
    }
    
    .confirm-modal {
        animation: slideUp 0.3s ease-out;
    }
</style>
{% endblock %}

{% block extra_scripts %}
<script>
// Dashboard specific JavaScript
(function() {
    'use strict';
    
    let dashboardSupabase = null;
    let isRefreshing = false;
    let refreshInterval;

    // Debug Supabase keys at startup
    console.log('=== SUPABASE CONFIG DEBUG ===');
    console.log('URL:', "{{ SUPABASE_URL|escapejs }}");
    console.log('Anon Key exists:', "{{ SUPABASE_ANON_KEY|escapejs }}" ? 'Yes' : 'No');
    console.log('Service Key exists:', "{{ SUPABASE_SERVICE_ROLE_KEY|escapejs }}" ? 'Yes' : 'No');
    console.log('Service Key length:', "{{ SUPABASE_SERVICE_ROLE_KEY|escapejs }}".length);
    console.log('============================');

    // Toast notification function
    function showToast(message, type = 'success') {
        const toastContainer = document.getElementById('toastContainer') || createToastContainer();
        const toast = document.createElement('div');
        const bgColor = type === 'success' ? 'bg-greenlight/20 text-greenlight' : 
                       type === 'error' ? 'bg-alert/20 text-alert' : 
                       'bg-sky/20 text-sky';
        const icon = type === 'success' ? 'fa-check-circle' : 
                    type === 'error' ? 'fa-exclamation-circle' : 
                    'fa-info-circle';
        
        toast.className = `${bgColor} px-4 py-2 rounded-lg flex items-center gap-2 shadow-lg mb-2 animate-slideIn`;
        toast.innerHTML = `<i class="fas ${icon}"></i> ${message}`;
        
        toastContainer.appendChild(toast);
        
        setTimeout(() => {
            toast.remove();
        }, 3000);
    }

    function createToastContainer() {
        const container = document.createElement('div');
        container.id = 'toastContainer';
        container.className = 'fixed top-20 right-4 z-50 space-y-2';
        document.body.appendChild(container);
        return container;
    }

    // Fixed Supabase client function
    function getSupabaseClient(useServiceKey = false) {
        try {
            const supabaseUrl = "{{ SUPABASE_URL|escapejs }}";
            
            if (!supabaseUrl || supabaseUrl === 'None') {
                console.error('Supabase URL is missing');
                return null;
            }
            
            if (useServiceKey) {
                const serviceKey = "{{ SUPABASE_SERVICE_ROLE_KEY|escapejs }}";
                
                if (!serviceKey || serviceKey === 'None' || serviceKey === '') {
                    console.error('Service role key is missing or invalid');
                    showToast('Server configuration error: Service key missing', 'error');
                    return null;
                }
                
                console.log('Creating admin client with service key');
                return supabase.createClient(supabaseUrl, serviceKey);
            }
            
            // Regular client for reads
            if (!dashboardSupabase) {
                const anonKey = "{{ SUPABASE_ANON_KEY|escapejs }}";
                
                if (!anonKey || anonKey === 'None' || anonKey === '') {
                    console.error('Anon key is missing or invalid');
                    showToast('Server configuration error: Anon key missing', 'error');
                    return null;
                }
                
                dashboardSupabase = supabase.createClient(supabaseUrl, anonKey);
            }
            return dashboardSupabase;
            
        } catch (error) {
            console.error('Error creating Supabase client:', error);
            return null;
        }
    }

    // Test function for service key
    async function testServiceKey() {
        console.log('Testing service key connection...');
        const client = getSupabaseClient(true);
        
        if (!client) {
            console.error('❌ Service key client is null');
            return;
        }
        
        const { data, error } = await client
            .from('accident_detections')
            .select('count')
            .limit(1);
        
        if (error) {
            console.error('❌ Service key test failed:', error);
        } else {
            console.log('✅ Service key works!');
        }
    }

    async function loadDashboardData(showLoading = true) {
        if (isRefreshing) return;
        
        isRefreshing = true;
        const refreshBtn = document.querySelector('button[onclick*="loadDashboardData"]');
        if (refreshBtn && showLoading) {
            refreshBtn.innerHTML = '<i class="fas fa-sync-alt spinning"></i> Refreshing...';
            refreshBtn.disabled = true;
        }
        
        try {
            const supabaseClient = getSupabaseClient(false);
            const currentUserRole = "{{ user.role }}";
            const currentUserId = {{ user.user_id }};
            
            if (!supabaseClient) throw new Error('Supabase client not available');
            
            if (showLoading) {
                showLoadingStates();
            }
            
            const { data: alertData, error: alertError } = await supabaseClient
                .from('alerts')
                .select(`
                    alert_id,
                    alert_time,
                    message,
                    response_status,
                    detection_id,
                    accident_detections:detection_id (
                        detection_time,
                        camera_id,
                        status,
                        accident_id,
                        frame_image,
                        video_clip
                    ),
                    users:sent_to (
                        first_name,
                        last_name,
                        role
                    )
                `)
                .eq('sent_to', currentUserId)
                .order('alert_time', { ascending: false })
                .limit(20);
            
            if (alertError) throw alertError;
            
            const { data: accidentData, error: accidentError } = await supabaseClient
                .from('accident_detections')
                .select(`
                    accident_id,
                    detection_time,
                    status
                `)
                .order('detection_time', { ascending: false })
                .limit(100);
            
            if (accidentError) throw accidentError;
            
            const today = new Date().toDateString();
            const accidentsToday = (accidentData || []).filter(d => {
                try {
                    return new Date(d.detection_time).toDateString() === today;
                } catch {
                    return false;
                }
            }).length;
            
            const pendingAccidents = (accidentData || []).filter(d => d.status === 'Pending').length;
            const adminConfirmed = (accidentData || []).filter(d => d.status === 'Admin_Confirmed').length;
            const verifiedCases = (accidentData || []).filter(d => d.status === 'Verified').length;
            const falseAlarms = (accidentData || []).filter(d => d.status === 'False_Alarm').length;
            const totalDetections = (accidentData || []).length;
            const pendingAlerts = (alertData || []).filter(a => a.response_status === 'Unacknowledged').length;
            
            // Response rate = verified / (total - false alarms that never deployed)
            const deployableIncidents = totalDetections - falseAlarms;
            const responseRate = deployableIncidents > 0 ? Math.round((verifiedCases / deployableIncidents) * 100) : 0;
            
            updateStats({
                accidentsToday,
                pendingAccidents,
                adminConfirmed,
                verifiedCases,
                falseAlarms,
                totalDetections,
                pendingAlerts,
                responseRate
            });
            
            updateAlertWorkflow(alertData || [], currentUserRole);
            updateSystemStatus(accidentData || []);
            
            document.getElementById('lastUpdate').textContent = 
                'Last update: ' + new Date().toLocaleTimeString();
            
        } catch (error) {
            console.error('Error loading dashboard data:', error);
            showToast('Error loading data', 'error');
        } finally {
            isRefreshing = false;
            if (refreshBtn && showLoading) {
                refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> <span class="hidden sm:inline">Refresh</span>';
                refreshBtn.disabled = false;
            }
        }
    }

    function showLoadingStates() {
        const tbody = document.querySelector('#recentAlertsTable tbody');
        if (tbody) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="py-8 text-center text-gray-500">
                        <div class="loading-spinner mx-auto mb-2"></div>
                        Loading your alerts...
                    </td>
                </tr>
            `;
        }
        
        ['accidentsToday', 'pendingAccidents', 'adminConfirmed', 'verifiedCases', 'falseAlarms', 'totalDetections', 'pendingAlerts', 'responseRate'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.textContent = '--';
        });
    }

    function updateStats(stats) {
        updateElement('accidentsToday', stats.accidentsToday);
        updateElement('pendingAccidents', stats.pendingAccidents || 0);
        updateElement('adminConfirmed', stats.adminConfirmed || 0);
        updateElement('verifiedCases', stats.verifiedCases || 0);
        updateElement('falseAlarms', stats.falseAlarms || 0);
        updateElement('totalDetections', stats.totalDetections);
        updateElement('pendingAlerts', stats.pendingAlerts);
        updateElement('responseRate', stats.responseRate + '%');
        
        const responseRateBar = document.getElementById('responseRateBar');
        if (responseRateBar) {
            responseRateBar.style.width = stats.responseRate + '%';
        }
    }

    function updateAlertWorkflow(alerts, userRole) {
        const tbody = document.querySelector('#recentAlertsTable tbody');
        if (!tbody) return;
        
        if (alerts && alerts.length > 0) {
            tbody.innerHTML = alerts.map((alert, index) => {
                const accident = alert.accident_detections || {};
                const user = alert.users || {};
                
                let alertTime;
                try {
                    alertTime = new Date(alert.alert_time).toLocaleString();
                } catch {
                    alertTime = 'Invalid Date';
                }
                
                const cameraDisplay = accident.camera_id ? `Camera ${accident.camera_id}` : 'Unknown';
                const isUnacknowledged = alert.response_status === 'Unacknowledged';
                
                let messageTypeClass = '';
                if (alert.message.includes('Possible Accident')) {
                    messageTypeClass = 'message-type-initial';
                } else if (alert.message.includes('CONFIRMED')) {
                    messageTypeClass = 'message-type-confirmed';
                } else if (alert.message.includes('CANCELLED')) {
                    messageTypeClass = 'message-type-cancelled';
                }
                
                // Get status color class
                let statusColorClass = '';
                let statusBgClass = '';
                switch(accident.status) {
                    case 'Pending': 
                        statusColorClass = 'text-gold'; 
                        statusBgClass = 'bg-gold/20';
                        break;
                    case 'Admin_Confirmed': 
                        statusColorClass = 'text-sky'; 
                        statusBgClass = 'bg-sky/20';
                        break;
                    case 'Verified': 
                        statusColorClass = 'text-greenlight'; 
                        statusBgClass = 'bg-greenlight/20';
                        break;
                    case 'False_Alarm': 
                        statusColorClass = 'text-alert'; 
                        statusBgClass = 'bg-alert/20';
                        break;
                    default: 
                        statusColorClass = 'text-gray-400';
                        statusBgClass = 'bg-gray-400/20';
                }
                
                let actionButton = '';
                
                // Admin: Show Review button ONLY on Pending accidents
                if (userRole === 'admin' && 
                    alert.message.includes('Possible Accident') && 
                    accident.status === 'Pending') {
                    actionButton = `
                        <button onclick="reviewAccident(${accident.accident_id})" 
                                class="bg-sky hover:bg-sky/80 text-white px-3 py-1 rounded text-xs transition flex items-center gap-1 review-pulse">
                            <i class="fas fa-eye"></i> Review
                        </button>
                    `;
                }
                
                // Admin: Show Re-review button for accidents that were already decided (in case of misclick)
                else if (userRole === 'admin' && 
                    (accident.status === 'Admin_Confirmed' || accident.status === 'False_Alarm')) {
                    actionButton = `
                        <button onclick="reReviewAccident(${accident.accident_id}, '${accident.status}')" 
                                class="bg-gold hover:bg-yellow-500 text-darkblue px-3 py-1 rounded text-xs transition flex items-center gap-1 re-review-btn"
                                title="Click if you made a wrong decision">
                            <i class="fas fa-undo-alt"></i> Re-review
                        </button>
                    `;
                }
                
                // Tanod: Show Acknowledge button on any unacknowledged alert
                else if (userRole === 'tanod' && isUnacknowledged) {
                    actionButton = `
                        <button onclick="acknowledgeAlert(${alert.alert_id})" 
                                class="bg-gold hover:bg-yellow-500 text-darkblue px-3 py-1 rounded text-xs transition flex items-center gap-1">
                            <i class="fas fa-check"></i> Acknowledge
                        </button>
                    `;
                }
                
                else if (!actionButton && alert.response_status === 'Acknowledged') {
                    actionButton = `<span class="text-gold text-xs"><i class="fas fa-check-circle"></i> Acknowledged</span>`;
                } else if (!actionButton && alert.response_status === 'Resolved') {
                    actionButton = `<span class="text-greenlight text-xs"><i class="fas fa-check-double"></i> Resolved</span>`;
                }
                
                // Format status display
                let statusDisplay = accident.status || 'Unknown';
                if (statusDisplay === 'Admin_Confirmed') {
                    statusDisplay = 'Dispatched';
                } else if (statusDisplay === 'False_Alarm') {
                    statusDisplay = 'False Alarm';
                }
                
                return `
                    <tr class="border-b border-gray-600 hover:bg-gray-600/30 transition-colors fade-in ${messageTypeClass}" 
                        style="animation-delay: ${index * 50}ms">
                        <td class="py-3 px-4">
                            <div class="flex flex-col">
                                <span class="font-medium">${alertTime.split(',')[0]}</span>
                                <span class="text-xs text-gray-400">${alertTime.split(',')[1]?.trim() || ''}</span>
                            </div>
                        </td>
                        <td class="py-3 px-4">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-video text-sky"></i>
                                <span>${cameraDisplay}</span>
                            </div>
                        </td>
                        <td class="py-3 px-4">
                            <div class="flex flex-col">
                                <span class="font-medium">${user.first_name || ''} ${user.last_name || ''}</span>
                                <span class="text-xs text-gray-400 capitalize">${user.role || 'User'}</span>
                            </div>
                        </td>
                        <td class="py-3 px-4">
                            <span class="inline-flex px-2 py-0.5 rounded-full text-xs font-medium 
                                ${isUnacknowledged ? 'bg-alert/20 text-alert' : 
                                  alert.response_status === 'Acknowledged' ? 'bg-gold/20 text-gold' : 
                                  'bg-greenlight/20 text-greenlight'}">
                                <i class="fas ${isUnacknowledged ? 'fa-clock' : 
                                            alert.response_status === 'Acknowledged' ? 'fa-check-circle' : 
                                            'fa-check-double'} mr-1"></i>
                                ${alert.response_status}
                            </span>
                        </td>
                        <td class="py-3 px-4">
                            <span class="inline-flex px-2 py-0.5 rounded-full text-xs font-medium ${statusBgClass} ${statusColorClass}">
                                <i class="fas ${accident.status === 'Pending' ? 'fa-hourglass-half' : 
                                            accident.status === 'Admin_Confirmed' ? 'fa-paper-plane' :
                                            accident.status === 'Verified' ? 'fa-check-double' : 
                                            'fa-times-circle'} mr-1"></i>
                                ${statusDisplay}
                            </span>
                        </td>
                        <td class="py-3 px-4 text-right">
                            ${actionButton}
                        </td>
                    </tr>
                `;
            }).join('');
        } else {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="py-8 text-center text-gray-500">
                        <i class="fas fa-bell-slash text-4xl mb-2"></i>
                        <p class="text-lg">No alerts found</p>
                        <p class="text-sm text-gray-400 mt-1">You don't have any alerts yet</p>
                    </td>
                </tr>
            `;
        }
    }

    function updateSystemStatus(detections) {
        const statusElement = document.getElementById('systemStatus');
        const statusIcon = document.getElementById('statusIcon');
        const statusText = document.getElementById('statusText');
        
        if (!statusElement) return;
        
        const recentDetection = detections[0];
        let message = 'System Active';
        let color = 'greenlight';
        let icon = 'fa-check-circle';
        
        if (recentDetection) {
            try {
                const timeDiff = new Date() - new Date(recentDetection.detection_time);
                const minutesAgo = Math.floor(timeDiff / (1000 * 60));
                
                if (minutesAgo > 30) {
                    message = 'No Recent Data';
                    color = 'alert';
                    icon = 'fa-exclamation-circle';
                }
            } catch {
                // Ignore date errors
            }
        }
        
        statusElement.className = `bg-${color}/20 text-${color} text-sm px-3 py-1 rounded-full flex items-center gap-1`;
        statusIcon.className = `fas ${icon}`;
        statusText.textContent = message;
    }

    function updateElement(id, value) {
        const el = document.getElementById(id);
        if (el) {
            el.classList.add('fade-in');
            el.textContent = value;
            setTimeout(() => el.classList.remove('fade-in'), 300);
        }
    }

    async function acknowledgeAlert(alertId) {
        try {
            const adminClient = getSupabaseClient(true);
            if (!adminClient) throw new Error("Supabase admin client not initialized");
            
            const button = event.target;
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            button.disabled = true;
            
            const { error } = await adminClient
                .from('alerts')
                .update({ response_status: 'Acknowledged' })
                .eq('alert_id', alertId)
                .eq('sent_to', {{ user.user_id }});
            
            if (error) throw error;
            
            showToast('Alert acknowledged successfully');
            await loadDashboardData();
            
        } catch (error) {
            console.error('Error in acknowledgeAlert:', error);
            showToast('Failed to acknowledge alert', 'error');
        }
    }

    // Re-review function for when admin makes a wrong decision
    async function reReviewAccident(accidentId, currentStatus) {
        try {
            const confirmed = await showCustomConfirm(
                'Re-review Accident',
                `This accident is currently marked as "${currentStatus === 'Admin_Confirmed' ? 'Dispatched' : 'False Alarm'}". Do you want to change this decision?`,
                'warning'
            );
            
            if (!confirmed) return;
            
            const adminClient = getSupabaseClient(true);
            if (!adminClient) throw new Error("Supabase admin client not initialized");
            
            // Fetch the accident details
            const supabaseClient = getSupabaseClient(false);
            const { data: accident, error: fetchError } = await supabaseClient
                .from('accident_detections')
                .select('*')
                .eq('accident_id', accidentId)
                .single();
            
            if (fetchError) throw fetchError;
            
            // Show review modal for re-review
            const modalHTML = `
                <div id="reviewModal" class="fixed inset-0 modal-overlay z-50 flex items-center justify-center p-4">
                    <div class="bg-[#1E293B] rounded-xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
                        <div class="p-4 border-b border-gray-600 flex justify-between items-center">
                            <h3 class="text-lg font-bold">Re-review Accident #${accidentId}</h3>
                            <button onclick="document.getElementById('reviewModal').remove()" class="text-gray-400 hover:text-white">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="p-8 text-center">
                            <div class="loading-spinner mx-auto"></div>
                            <p class="mt-4 text-gray-400">Loading accident details for re-review...</p>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Fetch fresh accident details
            const { data: freshAccident, error: freshError } = await supabaseClient
                .from('accident_detections')
                .select(`
                    accident_id,
                    detection_time,
                    camera_id,
                    status,
                    frame_image,
                    video_clip,
                    cctv:camera_id (
                        location_name,
                        status
                    )
                `)
                .eq('accident_id', accidentId)
                .single();
            
            if (freshError) throw freshError;
            
            document.getElementById('reviewModal').remove();
            
            const detectionTime = new Date(freshAccident.detection_time).toLocaleString();
            const locationName = freshAccident.cctv?.location_name || 
                (freshAccident.camera_id ? `Camera ${freshAccident.camera_id}` : 'Unknown Location');
            
            // Create re-review modal with special options
            const reReviewModalHTML = `
                <div id="reviewModal" class="fixed inset-0 modal-overlay z-50 flex items-center justify-center p-4">
                    <div class="bg-[#1E293B] rounded-xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
                        <div class="p-4 md:p-6 border-b border-gray-600 flex justify-between items-center">
                            <div>
                                <h3 class="text-lg md:text-xl font-bold">Re-review Accident #${freshAccident.accident_id}</h3>
                                <p class="text-sm text-gray-400">
                                    <i class="fas fa-map-marker-alt mr-1"></i> ${locationName} • 
                                    <i class="fas fa-clock mr-1"></i> ${detectionTime}
                                </p>
                                <p class="text-xs text-gold mt-1">
                                    <i class="fas fa-exclamation-triangle"></i> 
                                    Current Status: ${freshAccident.status === 'Admin_Confirmed' ? 'Dispatched' : 'False Alarm'}
                                </p>
                            </div>
                            <button onclick="document.getElementById('reviewModal').remove()" 
                                    class="text-gray-400 hover:text-white text-xl">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <div class="p-4 md:p-6 overflow-y-auto" style="max-height: calc(90vh - 120px);">
                            <div class="mb-6 p-4 bg-gold/20 border border-gold/30 rounded-lg">
                                <div class="flex items-center gap-3">
                                    <i class="fas fa-undo-alt text-gold text-xl"></i>
                                    <div>
                                        <p class="font-medium">You are about to change your decision</p>
                                        <p class="text-xs text-gray-400 mt-1">
                                            This will send new notifications to tanods based on your updated decision.
                                        </p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
                                <div>
                                    <h4 class="font-semibold mb-2 flex items-center gap-2">
                                        <i class="fas fa-image text-gold"></i>
                                        Detection Frame
                                    </h4>
                                    ${freshAccident.frame_image ? `
                                        <img src="${freshAccident.frame_image}" alt="Accident frame" 
                                             class="w-full rounded-lg border border-gray-600 cursor-pointer hover:opacity-90 transition"
                                             style="max-height: 200px; object-fit: cover;"
                                             onclick="window.open('${freshAccident.frame_image}', '_blank')"
                                             title="Click to enlarge">
                                    ` : `
                                        <div class="bg-[#112240] rounded-lg p-6 text-center text-gray-500 border border-gray-600">
                                            <i class="fas fa-image text-3xl mb-2 text-gray-600"></i>
                                            <p class="text-sm">No frame image available</p>
                                        </div>
                                    `}
                                </div>
                                
                                <div>
                                    <h4 class="font-semibold mb-2 flex items-center gap-2">
                                        <i class="fas fa-video text-sky"></i>
                                        Video Evidence
                                    </h4>
                                    ${freshAccident.video_clip ? `
                                        <video src="${freshAccident.video_clip}" controls class="w-full rounded-lg border border-gray-600 bg-black"
                                               style="max-height: 200px;">
                                            Your browser does not support the video tag.
                                        </video>
                                    ` : `
                                        <div class="bg-[#112240] rounded-lg p-6 text-center text-gray-500 border border-gray-600">
                                            <i class="fas fa-video-slash text-3xl mb-2 text-gray-600"></i>
                                            <p class="text-sm">No video available</p>
                                        </div>
                                    `}
                                </div>
                            </div>
                            
                            <div class="mb-6 p-4 bg-[#112240] rounded-lg border border-gray-600">
                                <h4 class="font-semibold mb-3 flex items-center gap-2">
                                    <i class="fas fa-info-circle text-sky"></i>
                                    Detection Details
                                </h4>
                                <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                                    <div>
                                        <p class="text-xs text-gray-400">Camera ID</p>
                                        <p class="font-medium">${freshAccident.camera_id || 'Not assigned'}</p>
                                    </div>
                                    <div>
                                        <p class="text-xs text-gray-400">Location</p>
                                        <p class="font-medium">${locationName}</p>
                                    </div>
                                    <div>
                                        <p class="text-xs text-gray-400">Camera Status</p>
                                        <p class="font-medium ${freshAccident.cctv?.status === 'Active' ? 'text-greenlight' : 'text-alert'}">
                                            ${freshAccident.cctv?.status || 'Unknown'}
                                        </p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex flex-col sm:flex-row gap-3 justify-end">
                                <button onclick="document.getElementById('reviewModal').remove()" 
                                        class="bg-gray-600 hover:bg-gray-500 text-white px-6 py-2 rounded-lg transition">
                                    Cancel
                                </button>
                                <button onclick="updateDecision(${freshAccident.accident_id}, ${freshAccident.status === 'Admin_Confirmed' ? 'false' : 'true'}, true)" 
                                        class="bg-gold hover:bg-yellow-500 text-darkblue px-6 py-2 rounded-lg transition flex items-center justify-center gap-2">
                                    <i class="fas fa-undo-alt"></i>
                                    Change to ${freshAccident.status === 'Admin_Confirmed' ? 'False Alarm' : 'Dispatch Tanod'}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', reReviewModalHTML);
            
        } catch (error) {
            console.error('Error in reReviewAccident:', error);
            const modal = document.getElementById('reviewModal');
            if (modal) modal.remove();
            showToast('Failed to load accident details for re-review', 'error');
        }
    }

    // Update decision function for re-review
    async function updateDecision(accidentId, newIsConfirmed, closeModal = false) {
        try {
            const confirmed = await showCustomConfirm(
                'Confirm Decision Change',
                `Are you sure you want to change this accident to ${newIsConfirmed ? 'Dispatch Tanod' : 'False Alarm'}? New notifications will be sent to tanods.`,
                'warning'
            );
            
            if (!confirmed) return;
            
            const adminClient = getSupabaseClient(true);
            if (!adminClient) throw new Error("Supabase admin client not initialized");
            
            showToast('Updating decision...', 'info');
            
            // Set new status based on updated decision
            const newStatus = newIsConfirmed ? 'Admin_Confirmed' : 'False_Alarm';
            
            // Update the accident status
            const { error: updateError } = await adminClient
                .from('accident_detections')
                .update({ status: newStatus })
                .eq('accident_id', accidentId);
            
            if (updateError) throw updateError;
            
            // Send cancellation/confirmation alerts to tanods based on new decision
            const { data: tanods, error: tanodError } = await adminClient
                .from('users')
                .select('user_id')
                .eq('role', 'tanod');
            
            if (!tanodError && tanods && tanods.length > 0) {
                // First, send cancellation for previous decision
                const cancelAlerts = tanods.map(tanod => ({
                    detection_id: accidentId,
                    sent_to: tanod.user_id,
                    message: 'PREVIOUS DECISION CANCELLED - New assessment in progress',
                    response_status: 'Unacknowledged',
                    alert_time: new Date().toISOString()
                }));
                
                await adminClient.from('alerts').insert(cancelAlerts);
                
                // Then send new decision alerts
                const newAlerts = tanods.map(tanod => ({
                    detection_id: accidentId,
                    sent_to: tanod.user_id,
                    message: newIsConfirmed ? 
                        'CONFIRMED ACCIDENT - Please respond to location' :
                        'INCIDENT CANCELLED - False alarm. Stand down.',
                    response_status: 'Unacknowledged',
                    alert_time: new Date().toISOString()
                }));
                
                await adminClient.from('alerts').insert(newAlerts);
                
                showToast(`Decision updated! Tanods notified of change.`, 'success');
            }
            
            if (closeModal) {
                const modal = document.getElementById('reviewModal');
                if (modal) modal.remove();
            }
            
            await loadDashboardData();
            
        } catch (error) {
            console.error('Error in updateDecision:', error);
            showToast('Failed to update decision', 'error');
        }
    }

    function showCustomConfirm(title, message, type = 'confirm') {
        return new Promise((resolve) => {
            const modalId = 'customConfirmModal';
            
            const existingModal = document.getElementById(modalId);
            if (existingModal) existingModal.remove();
            
            let bgColor, icon, buttonText;
            
            if (type === 'warning') {
                bgColor = 'bg-gold';
                icon = 'fa-exclamation-triangle';
                buttonText = 'Yes, Change Decision';
            } else if (type === 'confirm') {
                bgColor = 'bg-greenlight';
                icon = 'fa-check-circle';
                buttonText = 'Confirm & Dispatch Tanod';
            } else {
                bgColor = 'bg-alert';
                icon = 'fa-times-circle';
                buttonText = 'Mark as False Alarm';
            }
            
            const modalHTML = `
                <div id="${modalId}" class="fixed inset-0 confirm-modal-overlay z-[9999] flex items-center justify-center p-4">
                    <div class="confirm-modal bg-[#1E293B] rounded-xl max-w-md w-full border border-gray-600 shadow-2xl">
                        <div class="p-6">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="${bgColor}/20 p-3 rounded-full">
                                    <i class="fas ${icon} ${bgColor} text-2xl"></i>
                                </div>
                                <h3 class="text-xl font-bold text-white">${title}</h3>
                            </div>
                            
                            <p class="text-gray-300 mb-6">${message}</p>
                            
                            <div class="flex gap-3 justify-end">
                                <button id="cancelConfirmBtn" 
                                        class="px-4 py-2 bg-gray-600 hover:bg-gray-500 text-white rounded-lg transition">
                                    Cancel
                                </button>
                                <button id="confirmActionBtn" 
                                        class="px-4 py-2 ${bgColor} hover:opacity-80 text-white rounded-lg transition flex items-center gap-2">
                                    <i class="fas ${icon}"></i>
                                    ${buttonText}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            document.getElementById('cancelConfirmBtn').addEventListener('click', () => {
                document.getElementById(modalId).remove();
                resolve(false);
            });
            
            document.getElementById('confirmActionBtn').addEventListener('click', () => {
                document.getElementById(modalId).remove();
                resolve(true);
            });
        });
    }

    async function reviewAccident(accidentId) {
        try {
            const supabaseClient = getSupabaseClient(false);
            if (!supabaseClient) throw new Error("Supabase client not initialized");
            
            const modalHTML = `
                <div id="reviewModal" class="fixed inset-0 modal-overlay z-50 flex items-center justify-center p-4">
                    <div class="bg-[#1E293B] rounded-xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
                        <div class="p-4 border-b border-gray-600 flex justify-between items-center">
                            <h3 class="text-lg font-bold">Loading Accident Details...</h3>
                            <button onclick="document.getElementById('reviewModal').remove()" class="text-gray-400 hover:text-white">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="p-8 text-center">
                            <div class="loading-spinner mx-auto"></div>
                            <p class="mt-4 text-gray-400">Fetching accident data...</p>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            const { data: accident, error } = await supabaseClient
                .from('accident_detections')
                .select(`
                    accident_id,
                    detection_time,
                    camera_id,
                    status,
                    frame_image,
                    video_clip,
                    cctv:camera_id (
                        location_name,
                        status
                    )
                `)
                .eq('accident_id', accidentId)
                .single();
            
            if (error) throw error;
            
            document.getElementById('reviewModal').remove();
            
            const detectionTime = new Date(accident.detection_time).toLocaleString();
            const locationName = accident.cctv?.location_name || 
                (accident.camera_id ? `Camera ${accident.camera_id}` : 'Unknown Location');
            
            const reviewModalHTML = `
                <div id="reviewModal" class="fixed inset-0 modal-overlay z-50 flex items-center justify-center p-4">
                    <div class="bg-[#1E293B] rounded-xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
                        <div class="p-4 md:p-6 border-b border-gray-600 flex justify-between items-center">
                            <div>
                                <h3 class="text-lg md:text-xl font-bold">Review Accident #${accident.accident_id}</h3>
                                <p class="text-sm text-gray-400">
                                    <i class="fas fa-map-marker-alt mr-1"></i> ${locationName} • 
                                    <i class="fas fa-clock mr-1"></i> ${detectionTime}
                                </p>
                            </div>
                            <button onclick="document.getElementById('reviewModal').remove()" 
                                    class="text-gray-400 hover:text-white text-xl">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <div class="p-4 md:p-6 overflow-y-auto" style="max-height: calc(90vh - 120px);">
                            <div class="mb-6 p-4 ${accident.status === 'Pending' ? 'bg-gold/20 border border-gold/30' : 'bg-gray-700/20 border border-gray-600'} rounded-lg">
                                <div class="flex items-center gap-3">
                                    <i class="fas ${accident.status === 'Pending' ? 'fa-clock text-gold' : 'fa-check-circle text-greenlight'} text-xl"></i>
                                    <div>
                                        <p class="font-medium">Current Status: <span class="${accident.status === 'Pending' ? 'text-gold' : 'text-greenlight'}">${accident.status === 'Pending' ? 'Pending Review' : accident.status}</span></p>
                                        <p class="text-xs text-gray-400 mt-1">
                                            ${accident.status === 'Pending' ? 'Review the footage and decide: Is this a real accident or false alarm?' : 'This accident has been reviewed'}
                                        </p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
                                <div>
                                    <h4 class="font-semibold mb-2 flex items-center gap-2">
                                        <i class="fas fa-image text-gold"></i>
                                        Detection Frame
                                    </h4>
                                    ${accident.frame_image ? `
                                        <img src="${accident.frame_image}" alt="Accident frame" 
                                             class="w-full rounded-lg border border-gray-600 cursor-pointer hover:opacity-90 transition"
                                             style="max-height: 200px; object-fit: cover;"
                                             onclick="window.open('${accident.frame_image}', '_blank')"
                                             title="Click to enlarge">
                                        <p class="text-xs text-gray-400 mt-1">
                                            <i class="fas fa-search-plus"></i> Click image to enlarge
                                        </p>
                                    ` : `
                                        <div class="bg-[#112240] rounded-lg p-6 text-center text-gray-500 border border-gray-600">
                                            <i class="fas fa-image text-3xl mb-2 text-gray-600"></i>
                                            <p class="text-sm">Test Mode: No frame image</p>
                                            <p class="text-xs text-gray-600 mt-1">Image will appear once CCTV is integrated</p>
                                        </div>
                                    `}
                                </div>
                                
                                <div>
                                    <h4 class="font-semibold mb-2 flex items-center gap-2">
                                        <i class="fas fa-video text-sky"></i>
                                        Video Evidence
                                    </h4>
                                    ${accident.video_clip ? `
                                        <video src="${accident.video_clip}" controls class="w-full rounded-lg border border-gray-600 bg-black"
                                               style="max-height: 200px;">
                                            Your browser does not support the video tag.
                                        </video>
                                        <p class="text-xs text-gray-400 mt-1">
                                            <i class="fas fa-info-circle"></i> Video clip from time of detection
                                        </p>
                                    ` : `
                                        <div class="bg-[#112240] rounded-lg p-6 text-center text-gray-500 border border-gray-600">
                                            <i class="fas fa-video-slash text-3xl mb-2 text-gray-600"></i>
                                            <p class="text-sm">Test Mode: No video available</p>
                                            <p class="text-xs text-gray-600 mt-1">Video will appear once CCTV is integrated</p>
                                        </div>
                                    `}
                                </div>
                            </div>
                            
                            <div class="mb-6 p-4 bg-[#112240] rounded-lg border border-gray-600">
                                <h4 class="font-semibold mb-3 flex items-center gap-2">
                                    <i class="fas fa-info-circle text-sky"></i>
                                    Detection Details
                                </h4>
                                <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                                    <div>
                                        <p class="text-xs text-gray-400">Camera ID</p>
                                        <p class="font-medium">${accident.camera_id || 'Not assigned'}</p>
                                    </div>
                                    <div>
                                        <p class="text-xs text-gray-400">Location</p>
                                        <p class="font-medium">${locationName}</p>
                                    </div>
                                    <div>
                                        <p class="text-xs text-gray-400">Camera Status</p>
                                        <p class="font-medium ${accident.cctv?.status === 'Active' ? 'text-greenlight' : 'text-alert'}">
                                            ${accident.cctv?.status || 'Unknown'}
                                        </p>
                                    </div>
                                    <div>
                                        <p class="text-xs text-gray-400">Detection Time</p>
                                        <p class="font-medium text-xs">${detectionTime}</p>
                                    </div>
                                    <div>
                                        <p class="text-xs text-gray-400">Accident ID</p>
                                        <p class="font-medium text-xs">#${accident.accident_id}</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex flex-col sm:flex-row gap-3 justify-end">
                                <button onclick="verifyAccident(${accident.accident_id}, false, true)" 
                                        class="bg-gray-600 hover:bg-gray-500 text-white px-6 py-2 rounded-lg transition flex items-center justify-center gap-2">
                                    <i class="fas fa-times-circle"></i>
                                    False Alarm (Cancel)
                                </button>
                                <button onclick="verifyAccident(${accident.accident_id}, true, true)" 
                                        class="bg-greenlight hover:bg-greenlight/80 text-white px-6 py-2 rounded-lg transition flex items-center justify-center gap-2">
                                    <i class="fas fa-check-circle"></i>
                                    Confirm & Dispatch Tanod
                                </button>
                            </div>
                            
                            <p class="text-xs text-gray-500 text-center mt-4">
                                <i class="fas fa-shield-alt"></i>
                                <strong>Confirm:</strong> Tanod dispatched, they will verify on-site<br>
                                <strong>False Alarm:</strong> Incident cancelled immediately
                            </p>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', reviewModalHTML);
            
        } catch (error) {
            console.error('Error in reviewAccident:', error);
            const modal = document.getElementById('reviewModal');
            if (modal) modal.remove();
            showToast('Failed to load accident details: ' + error.message, 'error');
        }
    }

    async function verifyAccident(accidentId, isConfirmed, closeModal = false) {
        try {
            const confirmed = await showCustomConfirm(
                isConfirmed ? 'Confirm & Dispatch Tanod' : 'Mark as False Alarm',
                isConfirmed ? 
                    'Are you sure you want to dispatch a tanod? They will respond to the location and verify on-site.' : 
                    'Are you sure you want to cancel this incident? No tanod will be dispatched.',
                isConfirmed ? 'confirm' : 'cancel'
            );
            
            if (!confirmed) return;
            
            const adminClient = getSupabaseClient(true);
            if (!adminClient) {
                showToast('Server configuration error. Please contact administrator.', 'error');
                return;
            }
            
            showToast('Processing...', 'info');
            
            // Set new status based on admin decision
            const newStatus = isConfirmed ? 'Admin_Confirmed' : 'False_Alarm';
            
            const { error: updateError } = await adminClient
                .from('accident_detections')
                .update({ status: newStatus })
                .eq('accident_id', accidentId);
            
            if (updateError) {
                console.error('Update error:', updateError);
                throw updateError;
            }
            
            // If confirmed, send alerts to ALL tanods
            if (isConfirmed) {
                const { data: tanods, error: tanodError } = await adminClient
                    .from('users')
                    .select('user_id')
                    .eq('role', 'tanod');
                
                if (!tanodError && tanods && tanods.length > 0) {
                    const alerts = tanods.map(tanod => ({
                        detection_id: accidentId,
                        sent_to: tanod.user_id,
                        message: 'CONFIRMED ACCIDENT - Please respond to location',
                        response_status: 'Unacknowledged',
                        alert_time: new Date().toISOString()
                    }));
                    
                    await adminClient.from('alerts').insert(alerts);
                    showToast(`Tanod dispatched! ${tanods.length} tanod(s) notified.`, 'success');
                }
            } else {
                // If false alarm, send cancellation alerts to tanods
                const { data: tanods, error: tanodError } = await adminClient
                    .from('users')
                    .select('user_id')
                    .eq('role', 'tanod');
                
                if (!tanodError && tanods && tanods.length > 0) {
                    const alerts = tanods.map(tanod => ({
                        detection_id: accidentId,
                        sent_to: tanod.user_id,
                        message: 'INCIDENT CANCELLED - False alarm. Stand down.',
                        response_status: 'Unacknowledged',
                        alert_time: new Date().toISOString()
                    }));
                    
                    await adminClient.from('alerts').insert(alerts);
                    showToast('False alarm! Tanods notified to stand down.', 'success');
                }
            }
            
            if (closeModal) {
                const modal = document.getElementById('reviewModal');
                if (modal) modal.remove();
            }
            
            await loadDashboardData();
            
        } catch (error) {
            console.error('Error in verifyAccident:', error);
            showToast('Failed to process verification: ' + (error.message || 'Unknown error'), 'error');
        }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        loadDashboardData();
        refreshInterval = setInterval(() => loadDashboardData(false), 30000);
        // Test service key after 1 second
        setTimeout(testServiceKey, 1000);
    });

    // Make functions globally available
    window.loadDashboardData = loadDashboardData;
    window.reviewAccident = reviewAccident;
    window.verifyAccident = verifyAccident;
    window.acknowledgeAlert = acknowledgeAlert;
    window.reReviewAccident = reReviewAccident;
    window.updateDecision = updateDecision;
})();
</script>
{% endblock %}

{% block content %}
<!-- Dashboard Section -->
<div id="dashboard">
    <!-- Hero Welcome -->
    <div class="gradient-bg rounded-2xl p-6 md:p-8 mb-6 md:mb-8 text-center relative overflow-hidden">
        <div class="absolute inset-0 opacity-10">
            <div class="absolute w-48 h-48 md:w-64 md:h-64 bg-sky rounded-full -top-12 md:-top-16 -left-12 md:-left-16 pulse-slow"></div>
            <div class="absolute w-48 h-48 md:w-64 md:h-64 bg-alert rounded-full -bottom-12 md:-bottom-16 -right-12 md:-right-16 pulse-slow" style="animation-delay: 1s;"></div>
        </div>
        <div class="relative z-10 slide-up">
            <h1 class="text-2xl md:text-4xl lg:text-5xl font-bold text-white mb-3 md:mb-4">DisgrasEye Dashboard</h1>
            <p class="text-base md:text-xl text-graylight mb-4 md:mb-6">AI-Powered Real-Time Vehicle Crash Detection System</p>
            <div class="flex flex-col sm:flex-row gap-3 md:gap-4 justify-center">
                <a href="{% url 'cctv_monitoring' %}" class="bg-sky hover:bg-sky/80 text-white px-4 py-2 md:px-6 md:py-3 rounded-lg font-semibold transition-all transform hover:scale-105 shadow-lg flex items-center justify-center gap-2 text-sm md:text-base">
                    <i class="fas fa-video"></i> <span class="hidden xs:inline">Monitor CCTV</span>
                </a>
                <a href="{% url 'live_monitoring' %}" class="bg-alert hover:bg-alert/80 text-white px-4 py-2 md:px-6 md:py-3 rounded-lg font-semibold transition-all transform hover:scale-105 shadow-lg flex items-center justify-center gap-2 text-sm md:text-base">
                    <i class="fas fa-broadcast-tower"></i> <span class="hidden xs:inline">Live Detection</span>
                </a>
                <a href="{% url 'reports' %}" class="bg-greenlight hover:bg-greenlight/80 text-white px-4 py-2 md:px-6 md:py-3 rounded-lg font-semibold transition-all transform hover:scale-105 shadow-lg flex items-center justify-center gap-2 text-sm md:text-base">
                    <i class="fas fa-chart-line"></i> <span class="hidden xs:inline">View Reports</span>
                </a>
            </div>
        </div>
    </div>

    <!-- Stats Cards - Original 5 cards restored -->
    <div class="grid grid-cols-2 lg:grid-cols-5 gap-3 md:gap-6 mb-6 md:mb-8 stats-grid">
        <div class="bg-[#1E293B] p-4 md:p-6 rounded-xl shadow hover:shadow-lg transition transform hover:-translate-y-1 border border-sky/20 stat-card">
            <div class="flex justify-between items-center">
                <div>
                    <p class="text-xs md:text-sm text-gray-400">Accidents Today</p>
                    <h2 class="text-xl md:text-3xl font-bold text-sky mt-1 md:mt-2" id="accidentsToday">0</h2>
                </div>
                <div class="bg-sky/20 p-2 md:p-3 rounded-lg">
                    <i class="fas fa-car text-sky text-lg md:text-xl"></i>
                </div>
            </div>
        </div>

        <div class="bg-[#1E293B] p-4 md:p-6 rounded-xl shadow hover:shadow-lg transition transform hover:-translate-y-1 border border-alert/20 stat-card">
            <div class="flex justify-between items-center">
                <div>
                    <p class="text-xs md:text-sm text-gray-400">Pending Alerts</p>
                    <h2 class="text-xl md:text-3xl font-bold text-alert mt-1 md:mt-2 pulse-alert" id="pendingAlerts">0</h2>
                </div>
                <div class="bg-alert/20 p-2 md:p-3 rounded-lg">
                    <i class="fas fa-exclamation-circle text-alert text-lg md:text-xl"></i>
                </div>
            </div>
        </div>

        <div class="bg-[#1E293B] p-4 md:p-6 rounded-xl shadow hover:shadow-lg transition transform hover:-translate-y-1 border border-greenlight/20 stat-card">
            <div class="flex justify-between items-center">
                <div>
                    <p class="text-xs md:text-sm text-gray-400">Responded Cases</p>
                    <h2 class="text-xl md:text-3xl font-bold text-greenlight mt-1 md:mt-2" id="respondedCases">0</h2>
                </div>
                <div class="bg-greenlight/20 p-2 md:p-3 rounded-lg">
                    <i class="fas fa-check-circle text-greenlight text-lg md:text-xl"></i>
                </div>
            </div>
        </div>

        <div class="bg-[#1E293B] p-4 md:p-6 rounded-xl shadow hover:shadow-lg transition transform hover:-translate-y-1 border border-gold/20 stat-card">
            <div class="flex justify-between items-center">
                <div>
                    <p class="text-xs md:text-sm text-gray-400">Total Detections</p>
                    <h2 class="text-xl md:text-3xl font-bold text-gold mt-1 md:mt-2" id="totalDetections">0</h2>
                </div>
                <div class="bg-gold/20 p-2 md:p-3 rounded-lg">
                    <i class="fas fa-camera text-gold text-lg md:text-xl"></i>
                </div>
            </div>
        </div>

        <div class="bg-[#1E293B] p-4 md:p-6 rounded-xl shadow hover:shadow-lg transition transform hover:-translate-y-1 border border-sky/20 stat-card">
            <div class="flex justify-between items-center">
                <div>
                    <p class="text-xs md:text-sm text-gray-400">Response Rate</p>
                    <h2 class="text-xl md:text-3xl font-bold text-sky mt-1 md:mt-2" id="responseRate">0%</h2>
                </div>
                <div class="bg-sky/20 p-2 md:p-3 rounded-lg">
                    <i class="fas fa-bullseye text-sky text-lg md:text-xl"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- System Status and Quick Actions Section -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6 mb-6 md:mb-8">
        <!-- System Status Card -->
        <div class="bg-[#1E293B] rounded-xl shadow overflow-hidden border border-gray-600">
            <div class="p-4 md:p-6 border-b border-gray-600">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <i class="fas fa-heart-pulse text-sky"></i>
                        <h3 class="text-lg md:text-xl font-bold">System Status</h3>
                    </div>
                    <span id="systemStatus" class="bg-greenlight/20 text-greenlight text-sm px-3 py-1 rounded-full flex items-center gap-1">
                        <i id="statusIcon" class="fas fa-check-circle"></i>
                        <span id="statusText">System Active</span>
                    </span>
                </div>
            </div>
            <div class="p-4 md:p-6">
                <div class="space-y-3 md:space-y-4">
                    <div class="flex justify-between items-center">
                        <span class="text-sm md:text-base text-gray-400">Response Rate</span>
                        <span class="text-xl md:text-2xl font-bold text-sky" id="responseRate">0%</span>
                    </div>
                    <div class="w-full bg-gray-600 rounded-full h-2">
                        <div id="responseRateBar" class="bg-sky h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                    <div class="grid grid-cols-3 gap-2 md:gap-4 text-xs md:text-sm">
                        <div class="text-center p-2 md:p-3 bg-sky/10 rounded-lg">
                            <div class="text-sky font-bold text-base md:text-lg" id="respondedCases">0</div>
                            <div class="text-gray-400">Responded</div>
                        </div>
                        <div class="text-center p-2 md:p-3 bg-alert/10 rounded-lg">
                            <div class="text-alert font-bold text-base md:text-lg" id="pendingAlerts">0</div>
                            <div class="text-gray-400">Pending</div>
                        </div>
                        <div class="text-center p-2 md:p-3 bg-gold/10 rounded-lg">
                            <div class="text-gold font-bold text-base md:text-lg" id="totalDetections">0</div>
                            <div class="text-gray-400">Total</div>
                        </div>
                    </div>
                    <div class="pt-2 text-center">
                        <small class="text-gray-400" id="lastUpdate">Last update: --:--</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions Card -->
        <div class="bg-[#1E293B] rounded-xl shadow overflow-hidden border border-gray-600">
            <div class="p-4 md:p-6 border-b border-gray-600">
                <div class="flex items-center gap-2">
                    <i class="fas fa-bolt text-gold"></i>
                    <h3 class="text-lg md:text-xl font-bold">Quick Actions</h3>
                </div>
            </div>
            <div class="p-4 md:p-6">
                <div class="grid grid-cols-2 gap-3 md:gap-4 quick-actions-grid">
                    <a href="{% url 'cctv_monitoring' %}" class="bg-sky hover:bg-sky/80 text-white p-3 md:p-4 rounded-lg text-center transition transform hover:scale-105 quick-action-btn">
                        <i class="fas fa-video text-xl md:text-2xl mb-1 md:mb-2"></i>
                        <div class="font-semibold text-sm md:text-base">Live CCTV</div>
                        <div class="text-xs md:text-sm opacity-80">Monitor Feeds</div>
                    </a>
                    <a href="{% url 'live_monitoring' %}" class="bg-alert hover:bg-alert/80 text-white p-3 md:p-4 rounded-lg text-center transition transform hover:scale-105 quick-action-btn">
                        <i class="fas fa-broadcast-tower text-xl md:text-2xl mb-1 md:mb-2"></i>
                        <div class="font-semibold text-sm md:text-base">Live Detection</div>
                        <div class="text-xs md:text-sm opacity-80">Test System</div>
                    </a>
                    <a href="{% url 'reports' %}" class="bg-greenlight hover:bg-greenlight/80 text-white p-3 md:p-4 rounded-lg text-center transition transform hover:scale-105 quick-action-btn">
                        <i class="fas fa-chart-line text-xl md:text-2xl mb-1 md:mb-2"></i>
                        <div class="font-semibold text-sm md:text-base">Reports</div>
                        <div class="text-xs md:text-sm opacity-80">View Analytics</div>
                    </a>
                    <button onclick="loadDashboardData()" class="bg-gold hover:bg-gold/80 text-gray-900 p-3 md:p-4 rounded-lg text-center transition transform hover:scale-105 quick-action-btn">
                        <i class="fas fa-sync-alt text-xl md:text-2xl mb-1 md:mb-2"></i>
                        <div class="font-semibold text-sm md:text-base">Refresh</div>
                        <div class="text-xs md:text-sm opacity-80">Update Data</div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Alert Workflow Section -->
    <div class="bg-[#1E293B] rounded-xl shadow overflow-hidden border border-gray-600 mb-6 md:mb-8">
        <div class="p-4 md:p-6 border-b border-gray-600 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <i class="fas fa-diagram-project text-sky"></i>
                <h3 class="text-lg md:text-xl font-bold">Alert Workflow</h3>
                <span class="text-sm text-gray-400">({{ user.role|title }} View)</span>
                {% if user.role == 'admin' %}
                <span class="text-xs bg-sky/20 text-sky px-2 py-1 rounded ml-2">Review in-line • Re-review available</span>
                {% endif %}
            </div>
            <div class="flex items-center gap-2">
                <span class="text-xs text-gray-400 hidden sm:inline">Real-time updates</span>
                <button onclick="loadDashboardData()" class="text-xs md:text-sm bg-sky hover:bg-sky/80 text-white px-2 md:px-3 py-1 md:py-1 rounded transition flex items-center gap-1">
                    <i class="fas fa-sync-alt"></i> <span class="hidden sm:inline">Refresh</span>
                </button>
            </div>
        </div>
        
        <!-- Desktop Table View -->
        <div class="hidden md:block overflow-x-auto">
            <table class="w-full text-left" id="recentAlertsTable">
                <thead class="bg-[#112240]">
                    <tr>
                        <th class="py-3 px-4">Alert Time</th>
                        <th class="py-3 px-4">Camera</th>
                        <th class="py-3 px-4">Assigned To</th>
                        <th class="py-3 px-4">Alert Status</th>
                        <th class="py-3 px-4">Incident Status</th>
                        <th class="py-3 px-4 text-right">Action</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="6" class="py-8 text-center text-gray-500">
                            <div class="loading-spinner mx-auto mb-2"></div>
                            Loading your alerts...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Mobile Card View -->
        <div class="md:hidden p-4" id="mobileAlertsView">
            <!-- Mobile view would go here -->
        </div>
        
        <!-- Workflow Legend -->
        <div class="p-4 border-t border-gray-600 bg-[#112240]">
            <div class="flex flex-wrap gap-3 md:gap-4 justify-center text-xs md:text-sm">
                <div class="flex items-center gap-1">
                    <div class="w-3 h-3 rounded-full bg-alert"></div>
                    <span>Unacknowledged</span>
                </div>
                <div class="flex items-center gap-1">
                    <div class="w-3 h-3 rounded-full bg-gold"></div>
                    <span>Acknowledged</span>
                </div>
                <div class="flex items-center gap-1">
                    <div class="w-3 h-3 rounded-full bg-greenlight"></div>
                    <span>Resolved</span>
                </div>
                {% if user.role == 'admin' %}
                <div class="flex items-center gap-1">
                    <div class="w-3 h-3 rounded-full bg-sky"></div>
                    <span class="text-sky">Pending Review</span>
                </div>
                <div class="flex items-center gap-1">
                    <div class="w-3 h-3 rounded-full bg-gold"></div>
                    <span class="text-gold">Re-review available</span>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- User Information Panel -->
    <div class="bg-[#1E293B] rounded-xl shadow overflow-hidden border border-gray-600">
        <div class="p-4 md:p-6 border-b border-gray-600">
            <div class="flex items-center gap-3">
                <div class="bg-sky/20 p-2 md:p-3 rounded-lg">
                    <i class="fas fa-user-circle text-sky text-xl md:text-2xl"></i>
                </div>
                <div>
                    <h3 class="text-lg md:text-xl font-bold">User Information</h3>
                    <p class="text-sm text-gray-400">Your role and system access</p>
                </div>
            </div>
        </div>
        <div class="p-4 md:p-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
                <div class="space-y-3">
                    <div>
                        <p class="text-sm text-gray-400">Name</p>
                        <p class="text-base md:text-lg font-semibold">{{ user.first_name }} {{ user.last_name }}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-400">Email</p>
                        <p class="text-base md:text-lg">{{ user.email }}</p>
                    </div>
                </div>
                <div class="space-y-3">
                    <div>
                        <p class="text-sm text-gray-400">Role</p>
                        <p class="text-base md:text-lg">
                            <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full 
                                {% if user.role == 'admin' %}bg-sky/20 text-sky
                                {% else %}bg-greenlight/20 text-greenlight{% endif %}">
                                <i class="fas {% if user.role == 'admin' %}fa-shield{% else %}fa-user{% endif %}"></i>
                                {{ user.role|title }}
                            </span>
                        </p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-400">Account Status</p>
                        <p class="text-base md:text-lg font-semibold text-greenlight flex items-center gap-1">
                            <i class="fas fa-check-circle"></i> Active
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer note -->
    <div class="mt-6 md:mt-8 text-center text-xs text-gray-500">
        <p>DisgrasEye Dashboard • Real-time updates enabled • Auto-refresh every 30 seconds</p>
        <p class="mt-1">Check the "Alert Workflow" table above for pending reviews • Gold "Re-review" button appears if you need to change a decision</p>
    </div>
</div>
{% endblock %}