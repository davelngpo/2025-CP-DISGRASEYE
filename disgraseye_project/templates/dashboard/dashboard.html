{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}Dashboard | DisgrasEye{% endblock %}

{% block extra_head %}
<!-- Add DataTables CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css">

<style>
    /* ===== BLENDED ICON SYSTEM - ONLY FOR DATATABLES UI ===== */
    :root {
        --blend-light: rgba(255, 255, 255, 0.9);
        --blend-medium: rgba(255, 255, 255, 0.7);
        --blend-subtle: rgba(255, 255, 255, 0.5);
        --blend-muted: rgba(255, 255, 255, 0.3);
        --blend-ultra: rgba(255, 255, 255, 0.1);
    }

    .icon-xs { font-size: 0.75rem; }
    .icon-sm { font-size: 0.875rem; }
    .icon-md { font-size: 1rem; }
    .icon-lg { font-size: 1.25rem; }
    .icon-xl { font-size: 1.5rem; }

    .dataTables_wrapper .dataTables_length i,
    .dataTables_wrapper .dataTables_filter i,
    .dataTables_wrapper .dataTables_paginate i {
        opacity: 0.6;
        transition: opacity 0.2s ease;
    }
    
    .dataTables_wrapper .dataTables_length i:hover,
    .dataTables_wrapper .dataTables_filter i:hover,
    .dataTables_wrapper .dataTables_paginate i:hover {
        opacity: 1;
    }

    .status-icon-pending { color: #FCD34D; }
    .status-icon-unacknowledged { color: #EF4444; }
    .status-icon-acknowledged { color: #FCD34D; }
    .status-icon-resolved { color: #22C55E; }
    .status-icon-dispatched { color: #38BDF8; }
    .status-icon-false-alarm { color: #9CA3AF; }

    .icon-text {
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
    }
    
    .icon-text i {
        width: 1rem;
        text-align: center;
    }

    .status-dot {
        display: inline-block;
        width: 0.5rem;
        height: 0.5rem;
        border-radius: 9999px;
        margin-right: 0.375rem;
    }
    
    .status-dot-pending { background-color: #FCD34D; }
    .status-dot-unacknowledged { background-color: #EF4444; }
    .status-dot-acknowledged { background-color: #FCD34D; }
    .status-dot-resolved { background-color: #22C55E; }
    .status-dot-dispatched { background-color: #38BDF8; }
    .status-dot-false-alarm { background-color: #9CA3AF; }

    .role-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
        padding: 0.125rem 0.5rem;
        border-radius: 9999px;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .role-badge i { font-size: 0.75rem; }
    .role-badge span { font-size: 0.75rem; opacity: 0.9; }

    .location-indicator {
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
    }
    
    .location-indicator i { color: #38BDF8; font-size: 0.75rem; }
    .location-indicator span { opacity: 0.9; font-size: 0.75rem; }

    .action-btn {
        background: transparent;
        padding: 0.25rem 0.5rem;
        border-radius: 0.375rem;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
        font-size: 0.75rem;
        border: none;
        cursor: pointer;
        color: inherit;
    }
    
    .action-btn:hover { background: rgba(255, 255, 255, 0.05); }
    
    .btn-review i { color: #38BDF8; }
    .btn-rereview i { color: #FCD34D; }
    .btn-delete i { color: #EF4444; }
    .btn-acknowledge i { color: #FCD34D; }

    .action-cell {
        display: flex;
        gap: 0.5rem;
        justify-content: flex-end;
        align-items: center;
        flex-wrap: wrap;
        min-width: fit-content;
    }

    .table-container {
        background: #1E293B;
        border-radius: 0.75rem;
        padding: 1rem;
        border: 1px solid rgba(255, 255, 255, 0.1);
        overflow-x: auto;
    }
    
    table.dataTable thead th {
        border-bottom: 1px solid rgba(255, 255, 255, 0.1) !important;
        color: rgba(255, 255, 255, 0.9);
        font-weight: 500;
        padding: 12px !important;
    }
    
    table.dataTable thead th i { margin-right: 0.25rem; color: #38BDF8; }
    
    table.dataTable tbody td {
        border-bottom: 1px solid rgba(255, 255, 255, 0.05) !important;
        padding: 12px !important;
        vertical-align: middle;
    }
    
    table.dataTable tbody tr { transition: background-color 0.2s ease; }
    table.dataTable tbody tr:hover { background-color: rgba(255, 255, 255, 0.02) !important; }

    .severity-high { border-left: 2px solid #EF4444; }
    .severity-medium { border-left: 2px solid #FCD34D; }
    .severity-low { border-left: 2px solid #22C55E; }

    .alert-select, #selectAll {
        width: 16px;
        height: 16px;
        cursor: pointer;
        accent-color: #38BDF8;
    }

    #bulkActionBar {
        animation: slideUp 0.3s ease-out;
        z-index: 9999;
        background: #1E293B;
        border: 1px solid rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(8px);
    }

    .dataTables_wrapper .dataTables_length,
    .dataTables_wrapper .dataTables_filter,
    .dataTables_wrapper .dataTables_info,
    .dataTables_wrapper .dataTables_paginate {
        color: rgba(255, 255, 255, 0.8) !important;
        margin: 10px 0;
    }
    
    .dataTables_wrapper .dataTables_length select {
        background-color: #1E293B;
        color: white;
        border: 1px solid #4B5563;
        border-radius: 0.375rem;
        padding: 0.25rem 1.5rem 0.25rem 0.5rem;
        margin: 0 0.25rem;
        opacity: 1;
    }
    
    .dataTables_wrapper .dataTables_length select option {
        background-color: #1E293B;
        color: white;
    }
    
    .dataTables_wrapper .dataTables_filter input {
        background-color: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: white;
        border-radius: 0.5rem;
        padding: 0.375rem 0.75rem;
        margin-left: 0.5rem;
    }
    
    .dataTables_wrapper .dataTables_filter input:focus {
        outline: none;
        border-color: #38BDF8;
    }
    
    .dataTables_wrapper .dataTables_paginate .paginate_button {
        padding: 0.375rem 0.75rem;
        margin: 0 2px;
        border-radius: 0.375rem;
        background: transparent;
        color: rgba(255, 255, 255, 0.8) !important;
        border: 1px solid transparent;
    }
    
    .dataTables_wrapper .dataTables_paginate .paginate_button:hover {
        background: rgba(255, 255, 255, 0.05) !important;
        color: white !important;
        border-color: rgba(255, 255, 255, 0.1);
    }
    
    .dataTables_wrapper .dataTables_paginate .paginate_button.current {
        background: rgba(56, 189, 248, 0.1) !important;
        color: #38BDF8 !important;
        border-color: rgba(56, 189, 248, 0.3);
    }

    .loading-spinner {
        border: 2px solid rgba(255, 255, 255, 0.1);
        border-radius: 50%;
        border-top: 2px solid #38BDF8;
        width: 24px;
        height: 24px;
        animation: spin 1s linear infinite;
        display: inline-block;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    @keyframes slideUp {
        from { transform: translate(-50%, 100%); opacity: 0; }
        to { transform: translate(-50%, 0); opacity: 1; }
    }
    
    .fade-in {
        animation: fadeIn 0.3s ease-out;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* ===== MODAL STYLES (restored from v1) ===== */
    .modal-overlay {
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(5px);
    }

    .confirm-modal-overlay {
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(5px);
        animation: fadeIn 0.2s ease-out;
    }

    .confirm-modal {
        animation: slideUpModal 0.3s ease-out;
    }

    @keyframes slideUpModal {
        from { transform: translateY(20px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }

    /* Review button pulse */
    .review-pulse {
        animation: reviewPulse 2s infinite;
    }

    @keyframes reviewPulse {
        0% { box-shadow: 0 0 0 0 rgba(56, 189, 248, 0.7); }
        70% { box-shadow: 0 0 0 10px rgba(56, 189, 248, 0); }
        100% { box-shadow: 0 0 0 0 rgba(56, 189, 248, 0); }
    }

    /* Re-review button */
    .re-review-btn {
        animation: gentlePulse 2s infinite;
    }

    @keyframes gentlePulse {
        0% { opacity: 1; }
        50% { opacity: 0.7; }
        100% { opacity: 1; }
    }

    /* Column widths */
    .col-select { width: 40px; }
    .col-time { width: 15%; }
    .col-camera { width: 12%; }
    .col-user { width: 12%; }
    .col-alert-status { width: 12%; }
    .col-incident-status { width: 12%; }
    .col-action { width: 25%; }

    /* Timestamp styling */
    .timestamp {
        display: flex;
        flex-direction: column;
    }
    .timestamp-date {
        font-weight: 500;
        color: rgba(255, 255, 255, 0.9);
    }
    .timestamp-time {
        font-size: 0.7rem;
        opacity: 0.6;
    }
    .timestamp-relative {
        font-size: 0.65rem;
        opacity: 0.4;
        margin-top: 2px;
    }
</style>
{% endblock %}

{% block extra_scripts %}
<!-- DataTables Scripts -->
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js"></script>

<script>
(function() {
    'use strict';
    
    let dashboardSupabase = null;
    let isRefreshing = false;
    let refreshInterval;
    let alertsDataTable = null;
    let selectedAlerts = new Set();

    // ==================== HELPER FUNCTIONS ====================

    function formatDateTime(isoString) {
        try {
            if (!isoString) return { display: 'N/A', sortValue: 0 };
            
            const date = new Date(isoString);
            if (isNaN(date.getTime())) return { display: 'Invalid Date', sortValue: 0 };
            
            // Format for display
            const options = { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric',
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit',
                hour12: true
            };
            
            const displayDate = date.toLocaleDateString('en-US', options);
            
            // Get relative time
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            let relativeTime = '';
            if (diffMins < 1) relativeTime = 'just now';
            else if (diffMins < 60) relativeTime = `${diffMins} min ago`;
            else if (diffHours < 24) relativeTime = `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
            else if (diffDays < 7) relativeTime = `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
            else relativeTime = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            
            // Sort value: timestamp in milliseconds (descending = newest first)
            const sortValue = date.getTime();
            
            return {
                display: displayDate,
                relative: relativeTime,
                sortValue: sortValue,
                date: date
            };
        } catch (e) {
            console.error('Date formatting error:', e);
            return { display: 'Error', sortValue: 0 };
        }
    }

    // ==================== TOAST ====================

    function showToast(message, type = 'success') {
        const toastContainer = document.getElementById('toastContainer') || createToastContainer();
        const toast = document.createElement('div');
        const bgColor = type === 'success' ? 'bg-greenlight/20 text-greenlight' : 
                       type === 'error' ? 'bg-alert/20 text-alert' : 
                       'bg-sky/20 text-sky';
        const icon = type === 'success' ? 'fa-check-circle' : 
                    type === 'error' ? 'fa-exclamation-circle' : 
                    'fa-info-circle';
        
        toast.className = `${bgColor} px-4 py-2 rounded-lg flex items-center gap-2 shadow-lg mb-2`;
        toast.innerHTML = `<i class="fas ${icon} icon-xs"></i> ${message}`;
        toastContainer.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }

    function createToastContainer() {
        const container = document.createElement('div');
        container.id = 'toastContainer';
        container.className = 'fixed top-20 right-4 z-50 space-y-2';
        document.body.appendChild(container);
        return container;
    }

    // ==================== SUPABASE ====================

    function getSupabaseClient(useServiceKey = false) {
        try {
            const supabaseUrl = "{{ SUPABASE_URL|escapejs }}";
            if (!supabaseUrl || supabaseUrl === 'None') { console.error('Supabase URL is missing'); return null; }
            
            if (useServiceKey) {
                const serviceKey = "{{ SUPABASE_SERVICE_ROLE_KEY|escapejs }}";
                if (!serviceKey || serviceKey === 'None' || serviceKey === '') {
                    showToast('Server configuration error: Service key missing', 'error');
                    return null;
                }
                return supabase.createClient(supabaseUrl, serviceKey);
            }
            
            if (!dashboardSupabase) {
                const anonKey = "{{ SUPABASE_ANON_KEY|escapejs }}";
                if (!anonKey || anonKey === 'None' || anonKey === '') {
                    showToast('Server configuration error: Anon key missing', 'error');
                    return null;
                }
                dashboardSupabase = supabase.createClient(supabaseUrl, anonKey);
            }
            return dashboardSupabase;
        } catch (error) {
            console.error('Error creating Supabase client:', error);
            return null;
        }
    }

    // ==================== DATATABLE ====================

    function initDataTable() {
        if (alertsDataTable) {
            alertsDataTable.destroy();
        }
        
        alertsDataTable = $('#alertsTable').DataTable({
            responsive: true,
            pageLength: 10,
            lengthMenu: [[5, 10, 25, 50, -1], [5, 10, 25, 50, "All"]],
            order: [[1, 'desc']], // Sort by date column descending (newest first)
            language: {
                search: "<i class='fas fa-search icon-xs'></i>",
                lengthMenu: "Show _MENU_ entries",
                info: "Showing _START_ to _END_ of _TOTAL_ alerts",
                infoEmpty: "Showing 0 to 0 of 0 alerts",
                infoFiltered: "(filtered from _MAX_ total alerts)",
                paginate: { first: "«", previous: "‹", next: "›", last: "»" }
            },
            columnDefs: [
                { targets: 0, orderable: false, searchable: false, width: "40px", className: "text-center" },
                { targets: 1, type: 'num', render: function(data, type, row) {
                    // For sorting, use the data-sort attribute
                    if (type === 'sort') {
                        return $(row[1]).data('sort') || 0;
                    }
                    return data;
                }},
                { targets: 6, orderable: false, searchable: false, className: "text-right" }
            ]
        });
    }

    // ==================== SELECTION ====================

    function toggleAlertSelection(alertId, checkbox) {
        if (checkbox.checked) selectedAlerts.add(alertId);
        else selectedAlerts.delete(alertId);
        updateBulkActionBar();
    }

    function toggleAllAlerts(checkbox) {
        document.querySelectorAll('.alert-select').forEach(cb => {
            cb.checked = checkbox.checked;
            const alertId = parseInt(cb.dataset.alertId);
            if (checkbox.checked) selectedAlerts.add(alertId);
            else selectedAlerts.delete(alertId);
        });
        updateBulkActionBar();
    }

    function getSelectedAlertIds() { return Array.from(selectedAlerts); }

    function clearSelection() {
        selectedAlerts.clear();
        const selectAll = document.getElementById('selectAll');
        if (selectAll) selectAll.checked = false;
        document.querySelectorAll('.alert-select').forEach(cb => cb.checked = false);
        updateBulkActionBar();
    }

    function updateBulkActionBar() {
        const bar = document.getElementById('bulkActionBar');
        const count = document.getElementById('selectedCount');
        if (bar && count) {
            if (selectedAlerts.size > 0) { bar.classList.remove('hidden'); count.textContent = selectedAlerts.size; }
            else bar.classList.add('hidden');
        }
    }

    // ==================== CUSTOM CONFIRM MODAL ====================

    function showCustomConfirm(title, message, type = 'confirm') {
        return new Promise((resolve) => {
            const modalId = 'customConfirmModal';
            const existing = document.getElementById(modalId);
            if (existing) existing.remove();
            
            let bgColor, icon, buttonText;
            if (type === 'warning') {
                bgColor = 'bg-gold'; icon = 'fa-exclamation-triangle'; buttonText = 'Yes, Change Decision';
            } else if (type === 'delete') {
                bgColor = 'bg-alert'; icon = 'fa-trash-alt'; buttonText = 'Yes, Delete';
            } else if (type === 'cancel') {
                bgColor = 'bg-alert'; icon = 'fa-times-circle'; buttonText = 'Mark as False Alarm';
            } else {
                bgColor = 'bg-greenlight'; icon = 'fa-check-circle'; buttonText = 'Confirm & Dispatch Tanod';
            }
            
            document.body.insertAdjacentHTML('beforeend', `
                <div id="${modalId}" class="fixed inset-0 confirm-modal-overlay z-[9999] flex items-center justify-center p-4">
                    <div class="confirm-modal bg-[#1E293B] rounded-xl max-w-md w-full border border-gray-600 shadow-2xl">
                        <div class="p-6">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="${bgColor}/20 p-3 rounded-full">
                                    <i class="fas ${icon} text-2xl icon-md"></i>
                                </div>
                                <h3 class="text-xl font-bold text-white">${title}</h3>
                            </div>
                            <p class="text-gray-300 mb-6">${message}</p>
                            <div class="flex gap-3 justify-end">
                                <button id="cancelConfirmBtn" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 text-white rounded-lg transition">Cancel</button>
                                <button id="confirmActionBtn" class="px-4 py-2 ${bgColor} hover:opacity-80 text-white rounded-lg transition flex items-center gap-2">
                                    <i class="fas ${icon} icon-xs"></i> ${buttonText}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `);
            
            document.getElementById('cancelConfirmBtn').addEventListener('click', () => { document.getElementById(modalId).remove(); resolve(false); });
            document.getElementById('confirmActionBtn').addEventListener('click', () => { document.getElementById(modalId).remove(); resolve(true); });
        });
    }

    // ==================== REVIEW ACCIDENT MODAL ====================

    async function reviewAccident(accidentId) {
        try {
            const supabaseClient = getSupabaseClient(false);
            if (!supabaseClient) throw new Error("Supabase client not initialized");
            
            // Show loading modal first
            document.body.insertAdjacentHTML('beforeend', `
                <div id="reviewModal" class="fixed inset-0 modal-overlay z-50 flex items-center justify-center p-4">
                    <div class="bg-[#1E293B] rounded-xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
                        <div class="p-4 border-b border-gray-600 flex justify-between items-center">
                            <h3 class="text-lg font-bold">Loading Accident Details...</h3>
                            <button onclick="document.getElementById('reviewModal').remove()" class="text-gray-400 hover:text-white">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="p-8 text-center">
                            <div class="loading-spinner mx-auto"></div>
                            <p class="mt-4 text-gray-400">Fetching accident data...</p>
                        </div>
                    </div>
                </div>
            `);
            
            const { data: accident, error } = await supabaseClient
                .from('accident_detections')
                .select(`
                    accident_id,
                    detection_time,
                    status,
                    frame_image,
                    video_clip,
                    camera_id,
                    cctv:camera_id (
                        location_name,
                        status
                    )
                `)
                .eq('accident_id', accidentId)
                .single();
            
            if (error) throw error;
            
            // Remove loading modal
            document.getElementById('reviewModal').remove();
            
            const detectionTime = new Date(accident.detection_time).toLocaleString();
            const locationName = accident.cctv?.location_name || 
                (accident.camera_id ? `Camera ${accident.camera_id}` : 'Unknown Location');
            
            document.body.insertAdjacentHTML('beforeend', `
                <div id="reviewModal" class="fixed inset-0 modal-overlay z-50 flex items-center justify-center p-4">
                    <div class="bg-[#1E293B] rounded-xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
                        <div class="p-4 md:p-6 border-b border-gray-600 flex justify-between items-center">
                            <div>
                                <h3 class="text-lg md:text-xl font-bold">Review Accident #${accident.accident_id}</h3>
                                <p class="text-sm text-gray-400">
                                    <i class="fas fa-map-marker-alt mr-1"></i> ${locationName} &bull;
                                    <i class="fas fa-clock mr-1"></i> ${detectionTime}
                                </p>
                            </div>
                            <button onclick="document.getElementById('reviewModal').remove()" 
                                    class="text-gray-400 hover:text-white text-xl">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <div class="p-4 md:p-6 overflow-y-auto" style="max-height: calc(90vh - 120px);">
                            <!-- Status Banner -->
                            <div class="mb-6 p-4 ${accident.status === 'Pending' ? 'bg-gold/20 border border-gold/30' : 'bg-gray-700/20 border border-gray-600'} rounded-lg">
                                <div class="flex items-center gap-3">
                                    <i class="fas ${accident.status === 'Pending' ? 'fa-clock text-gold' : 'fa-check-circle text-greenlight'} text-xl"></i>
                                    <div>
                                        <p class="font-medium">Current Status: <span class="${accident.status === 'Pending' ? 'text-gold' : 'text-greenlight'}">${accident.status === 'Pending' ? 'Pending Review' : accident.status}</span></p>
                                        <p class="text-xs text-gray-400 mt-1">
                                            ${accident.status === 'Pending' ? 'Review the footage and decide: Is this a real accident or false alarm?' : 'This accident has already been reviewed.'}
                                        </p>
                                    </div>
                                </div>
                            </div>

                        
                                <!-- Media Grid -->
<div class="grid grid-cols-1 gap-4">
    <div>
        <h4 class="font-semibold mb-2 flex items-center gap-2">
            <i class="fas fa-video text-sky"></i> Video Evidence
        </h4>
        ${accident.video_clip ? `
            <div class="w-full">
                <video src="${accident.video_clip}" controls
                       class="w-full rounded-lg border border-gray-600 bg-black"
                       style="max-height: 300px; width: 100%; object-fit: contain;">
                    Your browser does not support the video tag.
                </video>
                <p class="text-xs text-gray-400 mt-2"><i class="fas fa-info-circle"></i> Video clip from time of detection</p>
            </div>
        ` : `
            <div class="bg-[#112240] rounded-lg p-8 text-center text-gray-500 border border-gray-600">
                <i class="fas fa-video-slash text-4xl mb-3 text-gray-600"></i>
                <p class="text-base">No video available</p>
                <p class="text-sm text-gray-600 mt-2">Video will appear once CCTV is integrated</p>
            </div>
        `}
    </div>
</div>

                            <!-- Detection Details -->
                            <div class="mb-6 p-4 bg-[#112240] rounded-lg border border-gray-600">
                                <h4 class="font-semibold mb-3 flex items-center gap-2">
                                    <i class="fas fa-info-circle text-sky"></i> Detection Details
                                </h4>
                                <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                                    <div>
                                        <p class="text-xs text-gray-400">Camera ID</p>
                                        <p class="font-medium">${accident.camera_id || 'Not assigned'}</p>
                                    </div>
                                    <div>
                                        <p class="text-xs text-gray-400">Location</p>
                                        <p class="font-medium">${locationName}</p>
                                    </div>
                                    <div>
                                        <p class="text-xs text-gray-400">Camera Status</p>
                                        <p class="font-medium ${accident.cctv?.status === 'Active' ? 'text-greenlight' : 'text-alert'}">
                                            ${accident.cctv?.status || 'Unknown'}
                                        </p>
                                    </div>
                                    <div>
                                        <p class="text-xs text-gray-400">Detection Time</p>
                                        <p class="font-medium text-xs">${detectionTime}</p>
                                    </div>
                                    <div>
                                        <p class="text-xs text-gray-400">Accident ID</p>
                                        <p class="font-medium text-xs">#${accident.accident_id}</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="flex flex-col sm:flex-row gap-3 justify-end">
                                <button onclick="verifyAccident(${accident.accident_id}, false, true)"
                                        class="bg-gray-600 hover:bg-gray-500 text-white px-6 py-2 rounded-lg transition flex items-center justify-center gap-2">
                                    <i class="fas fa-times-circle"></i> False Alarm (Cancel)
                                </button>
                                <button onclick="verifyAccident(${accident.accident_id}, true, true)"
                                        class="bg-greenlight hover:bg-greenlight/80 text-white px-6 py-2 rounded-lg transition flex items-center justify-center gap-2">
                                    <i class="fas fa-check-circle"></i> Confirm &amp; Dispatch Tanod
                                </button>
                            </div>

                            <p class="text-xs text-gray-500 text-center mt-4">
                                <i class="fas fa-shield-alt"></i>
                                <strong>Confirm:</strong> Tanod dispatched, they will verify on-site &nbsp;&bull;&nbsp;
                                <strong>False Alarm:</strong> Incident cancelled immediately
                            </p>
                        </div>
                    </div>
                </div>
            `);
            
        } catch (error) {
            console.error('Error in reviewAccident:', error);
            const modal = document.getElementById('reviewModal');
            if (modal) modal.remove();
            showToast('Failed to load accident details: ' + error.message, 'error');
        }
    }

    // ==================== RE-REVIEW MODAL ====================

    async function reReviewAccident(accidentId, currentStatus) {
        try {
            const confirmed = await showCustomConfirm(
                'Re-review Accident',
                `This accident is currently marked as "${currentStatus === 'Admin_Confirmed' ? 'Dispatched' : 'False Alarm'}". Do you want to change this decision?`,
                'warning'
            );
            if (!confirmed) return;
            
            // Show loading modal
            document.body.insertAdjacentHTML('beforeend', `
                <div id="reviewModal" class="fixed inset-0 modal-overlay z-50 flex items-center justify-center p-4">
                    <div class="bg-[#1E293B] rounded-xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
                        <div class="p-4 border-b border-gray-600 flex justify-between items-center">
                            <h3 class="text-lg font-bold">Re-review Accident #${accidentId}</h3>
                            <button onclick="document.getElementById('reviewModal').remove()" class="text-gray-400 hover:text-white">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="p-8 text-center">
                            <div class="loading-spinner mx-auto"></div>
                            <p class="mt-4 text-gray-400">Loading accident details for re-review...</p>
                        </div>
                    </div>
                </div>
            `);
            
            const supabaseClient = getSupabaseClient(false);
            const { data: accident, error } = await supabaseClient
                .from('accident_detections')
                .select(`
                    accident_id,
                    detection_time,
                    status,
                    frame_image,
                    video_clip,
                    camera_id,
                    cctv:camera_id (
                        location_name,
                        status
                    )
                `)
                .eq('accident_id', accidentId)
                .single();
            
            if (error) throw error;
            
            document.getElementById('reviewModal').remove();
            
            const detectionTime = new Date(accident.detection_time).toLocaleString();
            const locationName = accident.cctv?.location_name ||
                (accident.camera_id ? `Camera ${accident.camera_id}` : 'Unknown Location');
            
            document.body.insertAdjacentHTML('beforeend', `
                <div id="reviewModal" class="fixed inset-0 modal-overlay z-50 flex items-center justify-center p-4">
                    <div class="bg-[#1E293B] rounded-xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
                        <div class="p-4 md:p-6 border-b border-gray-600 flex justify-between items-center">
                            <div>
                                <h3 class="text-lg md:text-xl font-bold">Re-review Accident #${accident.accident_id}</h3>
                                <p class="text-sm text-gray-400">
                                    <i class="fas fa-map-marker-alt mr-1"></i> ${locationName} &bull;
                                    <i class="fas fa-clock mr-1"></i> ${detectionTime}
                                </p>
                                <p class="text-xs text-gold mt-1">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    Current Status: ${accident.status === 'Admin_Confirmed' ? 'Dispatched' : 'False Alarm'}
                                </p>
                            </div>
                            <button onclick="document.getElementById('reviewModal').remove()"
                                    class="text-gray-400 hover:text-white text-xl">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <div class="p-4 md:p-6 overflow-y-auto" style="max-height: calc(90vh - 120px);">
                            <!-- Warning Banner -->
                            <div class="mb-6 p-4 bg-gold/20 border border-gold/30 rounded-lg">
                                <div class="flex items-center gap-3">
                                    <i class="fas fa-undo-alt text-gold text-xl"></i>
                                    <div>
                                        <p class="font-medium">You are about to change your decision</p>
                                        <p class="text-xs text-gray-400 mt-1">
                                            This will send new notifications to tanods based on your updated decision.
                                        </p>
                                    </div>
                                </div>
                            </div>

                          
                                <!-- Media Grid -->
<div class="grid grid-cols-1 gap-4">
    <div>
        <h4 class="font-semibold mb-2 flex items-center gap-2">
            <i class="fas fa-video text-sky"></i> Video Evidence
        </h4>
        ${accident.video_clip ? `
            <div class="w-full">
                <video src="${accident.video_clip}" controls
                       class="w-full rounded-lg border border-gray-600 bg-black"
                       style="max-height: 300px; width: 100%; object-fit: contain;">
                    Your browser does not support the video tag.
                </video>
                <p class="text-xs text-gray-400 mt-2"><i class="fas fa-info-circle"></i> Video clip from time of detection</p>
            </div>
        ` : `
            <div class="bg-[#112240] rounded-lg p-8 text-center text-gray-500 border border-gray-600">
                <i class="fas fa-video-slash text-4xl mb-3 text-gray-600"></i>
                <p class="text-base">No video available</p>
                <p class="text-sm text-gray-600 mt-2">Video will appear once CCTV is integrated</p>
            </div>
        `}
    </div>
</div>

                            <!-- Detection Details -->
                            <div class="mb-6 p-4 bg-[#112240] rounded-lg border border-gray-600">
                                <h4 class="font-semibold mb-3 flex items-center gap-2">
                                    <i class="fas fa-info-circle text-sky"></i> Detection Details
                                </h4>
                                <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                                    <div>
                                        <p class="text-xs text-gray-400">Camera ID</p>
                                        <p class="font-medium">${accident.camera_id || 'Not assigned'}</p>
                                    </div>
                                    <div>
                                        <p class="text-xs text-gray-400">Location</p>
                                        <p class="font-medium">${locationName}</p>
                                    </div>
                                    <div>
                                        <p class="text-xs text-gray-400">Camera Status</p>
                                        <p class="font-medium ${accident.cctv?.status === 'Active' ? 'text-greenlight' : 'text-alert'}">
                                            ${accident.cctv?.status || 'Unknown'}
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="flex flex-col sm:flex-row gap-3 justify-end">
                                <button onclick="document.getElementById('reviewModal').remove()"
                                        class="bg-gray-600 hover:bg-gray-500 text-white px-6 py-2 rounded-lg transition">
                                    Cancel
                                </button>
                                <button onclick="updateDecision(${accident.accident_id}, ${accident.status === 'Admin_Confirmed' ? 'false' : 'true'}, true)"
                                        class="bg-gold hover:bg-yellow-500 text-darkblue px-6 py-2 rounded-lg transition flex items-center justify-center gap-2">
                                    <i class="fas fa-undo-alt"></i>
                                    Change to ${accident.status === 'Admin_Confirmed' ? 'False Alarm' : 'Dispatch Tanod'}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `);
            
        } catch (error) {
            console.error('Error in reReviewAccident:', error);
            const modal = document.getElementById('reviewModal');
            if (modal) modal.remove();
            showToast('Failed to load accident details for re-review', 'error');
        }
    }

    // ==================== VERIFY ACCIDENT ====================

    async function verifyAccident(accidentId, isConfirmed, closeModal = false) {
        try {
            const confirmed = await showCustomConfirm(
                isConfirmed ? 'Confirm & Dispatch Tanod' : 'Mark as False Alarm',
                isConfirmed
                    ? 'Are you sure you want to dispatch a tanod? They will respond to the location and verify on-site.'
                    : 'Are you sure you want to cancel this incident? No tanod will be dispatched.',
                isConfirmed ? 'confirm' : 'cancel'
            );
            if (!confirmed) return;
            
            const adminClient = getSupabaseClient(true);
            if (!adminClient) { showToast('Server configuration error. Please contact administrator.', 'error'); return; }
            
            showToast('Processing...', 'info');
            
            const newStatus = isConfirmed ? 'Admin_Confirmed' : 'False_Alarm';
            
            const { error: updateError } = await adminClient
                .from('accident_detections')
                .update({ status: newStatus })
                .eq('accident_id', accidentId);
            
            if (updateError) throw updateError;
            
            const { data: tanods, error: tanodError } = await adminClient
                .from('users').select('user_id').eq('role', 'tanod');
            
            if (!tanodError && tanods && tanods.length > 0) {
                const alerts = tanods.map(tanod => ({
                    detection_id: accidentId,
                    sent_to: tanod.user_id,
                    message: isConfirmed
                        ? 'CONFIRMED ACCIDENT - Please respond to location'
                        : 'INCIDENT CANCELLED - False alarm. Stand down.',
                    response_status: isConfirmed ? 'Unacknowledged' : 'Resolved',
                    alert_time: new Date().toISOString()
                }));
                await adminClient.from('alerts').insert(alerts);
                showToast(isConfirmed
                    ? `Tanod dispatched! ${tanods.length} tanod(s) notified.`
                    : 'False alarm! Tanods notified to stand down.', 'success');
            }
            
            if (closeModal) {
                const modal = document.getElementById('reviewModal');
                if (modal) modal.remove();
            }
            
            await loadDashboardData();
            
        } catch (error) {
            console.error('Error in verifyAccident:', error);
            showToast('Failed to process verification: ' + (error.message || 'Unknown error'), 'error');
        }
    }

    // ==================== UPDATE DECISION (re-review) ====================

    async function updateDecision(accidentId, newIsConfirmed, closeModal = false) {
        try {
            const adminClient = getSupabaseClient(true);
            if (!adminClient) throw new Error("Supabase admin client not initialized");
            
            showToast('Updating decision...', 'info');
            
            const newStatus = newIsConfirmed ? 'Admin_Confirmed' : 'False_Alarm';
            
            const { error: updateError } = await adminClient
                .from('accident_detections')
                .update({ status: newStatus })
                .eq('accident_id', accidentId);
            if (updateError) throw updateError;
            
            const { data: tanods } = await adminClient.from('users').select('user_id').eq('role', 'tanod');
            
            if (tanods && tanods.length > 0) {
                // Cancel old alerts
                const cancelAlerts = tanods.map(tanod => ({
                    detection_id: accidentId,
                    sent_to: tanod.user_id,
                    message: 'PREVIOUS DECISION CANCELLED - New assessment in progress',
                    response_status: 'Unacknowledged',
                    alert_time: new Date().toISOString()
                }));
                await adminClient.from('alerts').insert(cancelAlerts);
                
                // Send new decision alerts
                const newAlerts = tanods.map(tanod => ({
                    detection_id: accidentId,
                    sent_to: tanod.user_id,
                    message: newIsConfirmed
                        ? 'CONFIRMED ACCIDENT - Please respond to location'
                        : 'INCIDENT CANCELLED - False alarm. Stand down.',
                    response_status: 'Unacknowledged',
                    alert_time: new Date().toISOString()
                }));
                await adminClient.from('alerts').insert(newAlerts);
                showToast('Decision updated! Tanods notified of change.', 'success');
            }
            
            if (closeModal) {
                const modal = document.getElementById('reviewModal');
                if (modal) modal.remove();
            }
            
            await loadDashboardData();
            
        } catch (error) {
            console.error('Error in updateDecision:', error);
            showToast('Failed to update decision', 'error');
        }
    }

    // ==================== ACKNOWLEDGE ALERT ====================

    async function acknowledgeAlert(alertId) {
        try {
            const adminClient = getSupabaseClient(true);
            if (!adminClient) throw new Error("Supabase admin client not initialized");
            
            const { error } = await adminClient
                .from('alerts')
                .update({ response_status: 'Acknowledged' })
                .eq('alert_id', alertId)
                .eq('sent_to', {{ user.user_id }});
            
            if (error) throw error;
            showToast('Alert acknowledged successfully');
            await loadDashboardData();
        } catch (error) {
            console.error('Error in acknowledgeAlert:', error);
            showToast('Failed to acknowledge alert', 'error');
        }
    }

    // ==================== DELETE ====================

    async function deleteAlert(alertId) {
        try {
            const confirmed = await showCustomConfirm('Delete Alert', 'Are you sure you want to delete this alert? This action cannot be undone.', 'delete');
            if (!confirmed) return;
            
            const adminClient = getSupabaseClient(true);
            await adminClient.from('alerts').delete().eq('alert_id', alertId);
            showToast('Alert deleted successfully', 'success');
            await loadDashboardData();
        } catch (error) {
            console.error('Error deleting alert:', error);
            showToast('Failed to delete alert', 'error');
        }
    }

    async function bulkDeleteAlerts() {
        const list = getSelectedAlertIds();
        if (list.length === 0) { showToast('No alerts selected', 'info'); return; }
        
        try {
            const confirmed = await showCustomConfirm('Bulk Delete Alerts', `Are you sure you want to delete ${list.length} selected alert(s)? This action cannot be undone.`, 'delete');
            if (!confirmed) return;
            
            const adminClient = getSupabaseClient(true);
            await adminClient.from('alerts').delete().in('alert_id', list);
            showToast(`${list.length} alert(s) deleted`, 'success');
            clearSelection();
            await loadDashboardData();
        } catch (error) {
            console.error('Error bulk deleting:', error);
            showToast('Failed to delete alerts', 'error');
        }
    }

    // ==================== TABLE UPDATE ====================

    function updateAlertsTable(alerts, userRole) {
        const tbody = document.getElementById('alertsTableBody');
        if (!tbody) return;
        
        if (alertsDataTable) { alertsDataTable.destroy(); alertsDataTable = null; }
        
        if (alerts && alerts.length > 0) {
            let tableHtml = '';
            
            // Sort alerts by timestamp (newest first) - just to be sure
            const sortedAlerts = [...alerts].sort((a, b) => {
                const timeA = a.alert_time ? new Date(a.alert_time).getTime() : 0;
                const timeB = b.alert_time ? new Date(b.alert_time).getTime() : 0;
                return timeB - timeA; // Descending (newest first)
            });
            
            sortedAlerts.forEach((alert) => {
                const accident = alert.accident_detections || {};
                const user = alert.users || {};
                
                // Format the timestamp properly
                const timestamp = formatDateTime(alert.alert_time);
                
                const cameraDisplay = accident.camera_id ? `Camera ${accident.camera_id}` : 'Unknown';
                const isUnacknowledged = alert.response_status === 'Unacknowledged';
                const assignedRole = user.role || 'User';
                
                let severityClass = '';
                if (accident.status === 'Pending') severityClass = 'severity-high';
                else if (accident.status === 'Admin_Confirmed') severityClass = 'severity-medium';
                else if (accident.status === 'Verified') severityClass = 'severity-low';
                
                const statusDotClass = alert.response_status === 'Unacknowledged' ? 'status-dot-unacknowledged' :
                    alert.response_status === 'Acknowledged' ? 'status-dot-acknowledged' : 'status-dot-resolved';
                
                const incidentDotClass = accident.status === 'Pending' ? 'status-dot-pending' :
                    accident.status === 'Admin_Confirmed' ? 'status-dot-dispatched' :
                    accident.status === 'Verified' ? 'status-dot-resolved' :
                    accident.status === 'False_Alarm' ? 'status-dot-false-alarm' : 'status-dot-pending';
                
                let incidentDisplay = accident.status || 'Unknown';
                if (incidentDisplay === 'Admin_Confirmed') incidentDisplay = 'Dispatched';
                else if (incidentDisplay === 'False_Alarm') incidentDisplay = 'False Alarm';
                
                let actionButtons = '<div class="action-cell">';
                
                if (userRole === 'admin') {
                    if (alert.message && alert.message.includes('Possible Accident') && accident.status === 'Pending') {
                        actionButtons += `
                            <button onclick="reviewAccident(${accident.accident_id})"
                                    class="action-btn btn-review review-pulse" title="Review this accident">
                                <i class="fas fa-eye"></i><span>Review</span>
                            </button>`;
                    } else if (accident.status === 'Admin_Confirmed' || accident.status === 'False_Alarm') {
                        actionButtons += `
                            <button onclick="reReviewAccident(${accident.accident_id}, '${accident.status}')"
                                    class="action-btn btn-rereview re-review-btn" title="Change your decision">
                                <i class="fas fa-undo-alt"></i><span>Re-review</span>
                            </button>`;
                    }
                    actionButtons += `
                        <button onclick="deleteAlert(${alert.alert_id})"
                                class="action-btn btn-delete" title="Delete this alert">
                            <i class="fas fa-trash-alt"></i><span>Delete</span>
                        </button>`;
                } else if (userRole === 'tanod' && isUnacknowledged) {
                    actionButtons += `
                        <button onclick="acknowledgeAlert(${alert.alert_id})"
                                class="action-btn btn-acknowledge" title="Acknowledge this alert">
                            <i class="fas fa-check"></i><span>Acknowledge</span>
                        </button>`;
                }
                
                if (actionButtons === '<div class="action-cell">') {
                    if (alert.response_status === 'Acknowledged') actionButtons += `<span class="text-gold text-xs">Acknowledged</span>`;
                    else if (alert.response_status === 'Resolved') actionButtons += `<span class="text-greenlight text-xs">Resolved</span>`;
                    else actionButtons += `<span class="text-gray-500 text-xs">—</span>`;
                }
                
                actionButtons += '</div>';
                
                // Create the timestamp cell with sort data
                const timeCell = `
                    <div class="timestamp" data-sort="${timestamp.sortValue}">
                        <span class="timestamp-date">${timestamp.display}</span>
                        <span class="timestamp-time">${timestamp.relative}</span>
                    </div>
                `;
                
                tableHtml += `
                    <tr class="${severityClass}">
                        <td class="text-center">
                            <input type="checkbox" class="alert-select" data-alert-id="${alert.alert_id}" onchange="toggleAlertSelection(${alert.alert_id}, this)">
                        </td>
                        <td>${timeCell}</td>
                        <td>
                            <span class="location-indicator">
                                <i class="fas fa-video"></i>
                                <span class="text-xs">${cameraDisplay}</span>
                            </span>
                        </td>
                        <td>
                            <span class="role-badge">
                                <i class="fas ${assignedRole === 'admin' ? 'fa-shield-alt' : 'fa-user-shield'}"></i>
                                <span>${assignedRole}</span>
                            </span>
                        </td>
                        <td>
                            <span class="icon-text">
                                <span class="status-dot ${statusDotClass}"></span>
                                <span class="text-xs">${alert.response_status || 'Unknown'}</span>
                            </span>
                        </td>
                        <td>
                            <span class="icon-text">
                                <span class="status-dot ${incidentDotClass}"></span>
                                <span class="text-xs">${incidentDisplay}</span>
                            </span>
                        </td>
                        <td class="text-right">${actionButtons}</td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = tableHtml;
            initDataTable();
            document.getElementById('tableUpdateTime').textContent = new Date().toLocaleTimeString();
            
            // Re-attach select all event
            const selectAll = document.getElementById('selectAll');
            if (selectAll) {
                selectAll.addEventListener('change', function() { toggleAllAlerts(this); });
            }
            
        } else {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center py-8">
                        <div class="flex flex-col items-center opacity-50">
                            <i class="fas fa-bell-slash text-4xl mb-3"></i>
                            <p class="text-sm">No alerts found</p>
                        </div>
                    </td>
                </tr>
            `;
            if (alertsDataTable) { alertsDataTable.destroy(); alertsDataTable = null; }
        }
    }

    // ==================== LOAD DATA ====================

    async function loadDashboardData(showLoading = true) {
        if (isRefreshing) return;
        isRefreshing = true;
        
        try {
            const supabaseClient = getSupabaseClient(false);
            const currentUserRole = "{{ user.role }}";
            const currentUserId = {{ user.user_id }};
            
            if (!supabaseClient) throw new Error('Supabase client not available');
            
            // Log the current time for debugging
            console.log('Loading data at:', new Date().toISOString());
            
            const { data: alertData, error: alertError } = await supabaseClient
                .from('alerts')
                .select(`
                    alert_id, alert_time, message, response_status, detection_id,
                    accident_detections:detection_id (
                        detection_time, camera_id, status, accident_id, frame_image, video_clip
                    ),
                    users:sent_to ( first_name, last_name, role )
                `)
                .eq('sent_to', currentUserId)
                .order('alert_time', { ascending: false })
                .limit(50); // Increased limit to see more alerts
            
            if (alertError) throw alertError;
            
            // Log the first few alerts to debug
            if (alertData && alertData.length > 0) {
                console.log('First alert time:', alertData[0].alert_time);
                console.log('Total alerts loaded:', alertData.length);
            }
            
            const { data: accidentData, error: accidentError } = await supabaseClient
                .from('accident_detections')
                .select('accident_id, detection_time, status')
                .order('detection_time', { ascending: false })
                .limit(100);
            
            if (accidentError) throw accidentError;
            
            const today = new Date().toDateString();
            const accidentsToday = (accidentData || []).filter(d => { try { return new Date(d.detection_time).toDateString() === today; } catch { return false; } }).length;
            const pendingAccidents = (accidentData || []).filter(d => d.status === 'Pending').length;
            const adminConfirmed = (accidentData || []).filter(d => d.status === 'Admin_Confirmed').length;
            const verifiedCases = (accidentData || []).filter(d => d.status === 'Verified').length;
            const falseAlarms = (accidentData || []).filter(d => d.status === 'False_Alarm').length;
            const totalDetections = (accidentData || []).length;
            const pendingAlerts = (alertData || []).filter(a => a.response_status === 'Unacknowledged').length;
            const deployableIncidents = totalDetections - falseAlarms;
            const responseRate = deployableIncidents > 0 ? Math.round((verifiedCases / deployableIncidents) * 100) : 0;
            
            updateStats({ accidentsToday, pendingAccidents, adminConfirmed, verifiedCases, falseAlarms, totalDetections, pendingAlerts, responseRate });
            updateAlertsTable(alertData || [], currentUserRole);
            updateSystemStatus(accidentData || []);
            document.getElementById('lastUpdate').textContent = 'Last update: ' + new Date().toLocaleTimeString();
            
        } catch (error) {
            console.error('Error loading dashboard data:', error);
            showToast('Error loading data', 'error');
        } finally {
            isRefreshing = false;
        }
    }

    function updateStats(stats) {
        updateElement('accidentsToday', stats.accidentsToday);
        updateElement('pendingAccidents', stats.pendingAccidents || 0);
        updateElement('adminConfirmed', stats.adminConfirmed || 0);
        updateElement('verifiedCases', stats.verifiedCases || 0);
        updateElement('falseAlarms', stats.falseAlarms || 0);
        updateElement('totalDetections', stats.totalDetections);
        updateElement('pendingAlerts', stats.pendingAlerts);
        updateElement('responseRate', stats.responseRate + '%');
        const bar = document.getElementById('responseRateBar');
        if (bar) bar.style.width = stats.responseRate + '%';
    }

    function updateSystemStatus(detections) {
        const statusElement = document.getElementById('systemStatus');
        const statusIcon = document.getElementById('statusIcon');
        const statusText = document.getElementById('statusText');
        if (!statusElement) return;
        
        let message = 'System Active';
        let icon = 'fa-check-circle';
        const recentDetection = detections[0];
        
        if (recentDetection) {
            try {
                const minutesAgo = Math.floor((new Date() - new Date(recentDetection.detection_time)) / 60000);
                if (minutesAgo > 30) { message = 'No Recent Data'; icon = 'fa-exclamation-circle'; }
            } catch { /* ignore */ }
        }
        
        statusIcon.className = `fas ${icon} icon-xs`;
        statusText.textContent = message;
    }

    function updateElement(id, value) {
        const el = document.getElementById(id);
        if (el) {
            el.classList.add('fade-in');
            el.textContent = value;
            setTimeout(() => el.classList.remove('fade-in'), 300);
        }
    }

    // ==================== INIT ====================

    document.addEventListener('DOMContentLoaded', function() {
        loadDashboardData();
        refreshInterval = setInterval(() => loadDashboardData(false), 30000);
    });

    // Global exposure
    window.loadDashboardData = loadDashboardData;
    window.reviewAccident = reviewAccident;
    window.verifyAccident = verifyAccident;
    window.reReviewAccident = reReviewAccident;
    window.updateDecision = updateDecision;
    window.acknowledgeAlert = acknowledgeAlert;
    window.deleteAlert = deleteAlert;
    window.bulkDeleteAlerts = bulkDeleteAlerts;
    window.toggleAlertSelection = toggleAlertSelection;
    window.toggleAllAlerts = toggleAllAlerts;
    window.clearSelection = clearSelection;
})();
</script>
{% endblock %}

{% block content %}
<!-- Dashboard Section -->
<div id="dashboard">
    <!-- Hero Welcome -->
    <div class="gradient-bg rounded-2xl p-6 md:p-8 mb-6 md:mb-8 text-center relative overflow-hidden">
        <div class="absolute inset-0 opacity-10">
            <div class="absolute w-48 h-48 md:w-64 md:h-64 bg-sky rounded-full -top-12 md:-top-16 -left-12 md:-left-16 pulse-slow"></div>
            <div class="absolute w-48 h-48 md:w-64 md:h-64 bg-alert rounded-full -bottom-12 md:-bottom-16 -right-12 md:-right-16 pulse-slow" style="animation-delay: 1s;"></div>
        </div>
        <div class="relative z-10 slide-up">
            <h1 class="text-2xl md:text-4xl lg:text-5xl font-bold text-white mb-3 md:mb-4">DisgrasEye Dashboard</h1>
            <p class="text-base md:text-xl opacity-80 mb-4 md:mb-6">AI-Powered Real-Time Vehicle Crash Detection System</p>
            <div class="flex flex-col sm:flex-row gap-3 md:gap-4 justify-center">
                <a href="{% url 'cctv_monitoring' %}" class="bg-sky/10 hover:bg-sky/20 text-white px-4 py-2 md:px-6 md:py-3 rounded-lg font-semibold transition-all flex items-center justify-center gap-2 text-sm md:text-base border border-sky/20">
                    <i class="fas fa-video icon-sm text-sky"></i> <span>Monitor CCTV</span>
                </a>
                <a href="{% url 'live_monitoring' %}" class="bg-alert/10 hover:bg-alert/20 text-white px-4 py-2 md:px-6 md:py-3 rounded-lg font-semibold transition-all flex items-center justify-center gap-2 text-sm md:text-base border border-alert/20">
                    <i class="fas fa-broadcast-tower icon-sm text-alert"></i> <span>Live Detection</span>
                </a>
                <a href="{% url 'reports' %}" class="bg-greenlight/10 hover:bg-greenlight/20 text-white px-4 py-2 md:px-6 md:py-3 rounded-lg font-semibold transition-all flex items-center justify-center gap-2 text-sm md:text-base border border-greenlight/20">
                    <i class="fas fa-chart-line icon-sm text-greenlight"></i> <span>View Reports</span>
                </a>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-2 lg:grid-cols-5 gap-3 md:gap-6 mb-6 md:mb-8 stats-grid">
        <div class="bg-[#1E293B] p-4 md:p-6 rounded-xl shadow hover:shadow-lg transition border border-white/5 stat-card">
            <div class="flex justify-between items-center">
                <div>
                    <p class="text-xs md:text-sm opacity-50">Accidents Today</p>
                    <h2 class="text-xl md:text-3xl font-bold text-sky mt-1 md:mt-2" id="accidentsToday">0</h2>
                </div>
                <i class="fas fa-car text-sky text-lg md:text-xl"></i>
            </div>
        </div>
        <div class="bg-[#1E293B] p-4 md:p-6 rounded-xl shadow hover:shadow-lg transition border border-white/5 stat-card">
            <div class="flex justify-between items-center">
                <div>
                    <p class="text-xs md:text-sm opacity-50">Pending Alerts</p>
                    <h2 class="text-xl md:text-3xl font-bold text-alert mt-1 md:mt-2" id="pendingAlerts">0</h2>
                </div>
                <i class="fas fa-exclamation-circle text-alert text-lg md:text-xl"></i>
            </div>
        </div>
        <div class="bg-[#1E293B] p-4 md:p-6 rounded-xl shadow hover:shadow-lg transition border border-white/5 stat-card">
            <div class="flex justify-between items-center">
                <div>
                    <p class="text-xs md:text-sm opacity-50">Responded Cases</p>
                    <h2 class="text-xl md:text-3xl font-bold text-greenlight mt-1 md:mt-2" id="verifiedCases">0</h2>
                </div>
                <i class="fas fa-check-circle text-greenlight text-lg md:text-xl"></i>
            </div>
        </div>
        <div class="bg-[#1E293B] p-4 md:p-6 rounded-xl shadow hover:shadow-lg transition border border-white/5 stat-card">
            <div class="flex justify-between items-center">
                <div>
                    <p class="text-xs md:text-sm opacity-50">Total Detections</p>
                    <h2 class="text-xl md:text-3xl font-bold text-gold mt-1 md:mt-2" id="totalDetections">0</h2>
                </div>
                <i class="fas fa-camera text-gold text-lg md:text-xl"></i>
            </div>
        </div>
        <div class="bg-[#1E293B] p-4 md:p-6 rounded-xl shadow hover:shadow-lg transition border border-white/5 stat-card">
            <div class="flex justify-between items-center">
                <div>
                    <p class="text-xs md:text-sm opacity-50">Response Rate</p>
                    <h2 class="text-xl md:text-3xl font-bold text-sky mt-1 md:mt-2" id="responseRate">0%</h2>
                </div>
                <i class="fas fa-bullseye text-sky text-lg md:text-xl"></i>
            </div>
        </div>
    </div>

    <!-- System Status and Quick Actions -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6 mb-6 md:mb-8">
        <div class="bg-[#1E293B] rounded-xl shadow overflow-hidden border border-white/5">
            <div class="p-4 md:p-6 border-b border-white/5">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <i class="fas fa-heart-pulse text-sky"></i>
                        <h3 class="text-lg md:text-xl font-bold">System Status</h3>
                    </div>
                    <span id="systemStatus" class="text-sm px-3 py-1 rounded-full flex items-center gap-1 bg-white/5 border border-white/10">
                        <i id="statusIcon" class="fas fa-check-circle text-greenlight"></i>
                        <span id="statusText" class="opacity-80">System Active</span>
                    </span>
                </div>
            </div>
            <div class="p-4 md:p-6">
                <div class="space-y-3 md:space-y-4">
                    <div class="flex justify-between items-center">
                        <span class="text-sm md:text-base opacity-50">Response Rate</span>
                        <span class="text-xl md:text-2xl font-bold text-sky" id="responseRate">0%</span>
                    </div>
                    <div class="w-full bg-white/5 rounded-full h-2">
                        <div id="responseRateBar" class="bg-sky h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                    <div class="grid grid-cols-3 gap-2 md:gap-4 text-xs md:text-sm">
                        <div class="text-center p-2 md:p-3 bg-white/5 rounded-lg">
                            <div class="font-bold text-base md:text-lg" id="verifiedCases">0</div>
                            <div class="opacity-50">Responded</div>
                        </div>
                        <div class="text-center p-2 md:p-3 bg-white/5 rounded-lg">
                            <div class="font-bold text-base md:text-lg" id="pendingAlerts">0</div>
                            <div class="opacity-50">Pending</div>
                        </div>
                        <div class="text-center p-2 md:p-3 bg-white/5 rounded-lg">
                            <div class="font-bold text-base md:text-lg" id="totalDetections">0</div>
                            <div class="opacity-50">Total</div>
                        </div>
                    </div>
                    <div class="pt-2 text-center">
                        <small class="opacity-30" id="lastUpdate">Last update: --:--</small>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-[#1E293B] rounded-xl shadow overflow-hidden border border-white/5">
            <div class="p-4 md:p-6 border-b border-white/5">
                <div class="flex items-center gap-2">
                    <i class="fas fa-bolt text-gold"></i>
                    <h3 class="text-lg md:text-xl font-bold">Quick Actions</h3>
                </div>
            </div>
            <div class="p-4 md:p-6">
                <div class="grid grid-cols-2 gap-3 md:gap-4">
                    <a href="{% url 'cctv_monitoring' %}" class="bg-white/5 hover:bg-white/10 p-3 md:p-4 rounded-lg text-center transition border border-white/5">
                        <i class="fas fa-video text-xl md:text-2xl mb-1 md:mb-2 text-sky"></i>
                        <div class="font-semibold text-sm md:text-base">Live CCTV</div>
                        <div class="text-xs md:text-sm opacity-40">Monitor Feeds</div>
                    </a>
                    <a href="{% url 'live_monitoring' %}" class="bg-white/5 hover:bg-white/10 p-3 md:p-4 rounded-lg text-center transition border border-white/5">
                        <i class="fas fa-broadcast-tower text-xl md:text-2xl mb-1 md:mb-2 text-alert"></i>
                        <div class="font-semibold text-sm md:text-base">Live Detection</div>
                        <div class="text-xs md:text-sm opacity-40">Test System</div>
                    </a>
                    <a href="{% url 'reports' %}" class="bg-white/5 hover:bg-white/10 p-3 md:p-4 rounded-lg text-center transition border border-white/5">
                        <i class="fas fa-chart-line text-xl md:text-2xl mb-1 md:mb-2 text-greenlight"></i>
                        <div class="font-semibold text-sm md:text-base">Reports</div>
                        <div class="text-xs md:text-sm opacity-40">View Analytics</div>
                    </a>
                    <button onclick="loadDashboardData()" class="bg-white/5 hover:bg-white/10 p-3 md:p-4 rounded-lg text-center transition border border-white/5">
                        <i class="fas fa-sync-alt text-xl md:text-2xl mb-1 md:mb-2 text-gold"></i>
                        <div class="font-semibold text-sm md:text-base">Refresh</div>
                        <div class="text-xs md:text-sm opacity-40">Update Data</div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Alert Management Section -->
    <div class="bg-[#1E293B] rounded-xl shadow overflow-hidden border border-white/5 mb-6 md:mb-8">
        <div class="p-4 md:p-6 border-b border-white/5 flex items-center justify-between flex-wrap gap-3">
            <div class="flex items-center gap-3">
                <div class="bg-white/5 p-2 rounded-lg">
                    <i class="fas fa-table text-sky"></i>
                </div>
                <div>
                    <h3 class="text-lg md:text-xl font-bold">Alert Management</h3>
                    <p class="text-xs opacity-40">View and manage all alerts &bull; Search &bull; Sort &bull; Filter</p>
                </div>
                {% if user.role == 'admin' %}
                <span class="text-xs bg-white/5 px-2 py-1 rounded-full ml-2 hidden sm:inline border border-white/10">
                    <i class="fas fa-shield-alt text-sky mr-1"></i>Admin Controls
                </span>
                {% endif %}
            </div>
            <button onclick="loadDashboardData()" class="text-xs bg-white/5 hover:bg-white/10 px-3 py-1.5 rounded-lg transition flex items-center gap-1 border border-white/10">
                <i class="fas fa-sync-alt icon-xs text-sky"></i> Refresh
            </button>
        </div>
        
        <div class="p-4">
            <div class="table-container">
                <table id="alertsTable" class="table table-dark table-hover w-full" style="width:100%">
                    <thead>
                        <tr>
                            <th class="col-select"><input type="checkbox" id="selectAll" class="alert-select"></th>
                            <th class="col-time"><i class="fas fa-calendar text-sky"></i> Date &amp; Time</th>
                            <th class="col-camera"><i class="fas fa-video text-sky"></i> Camera</th>
                            <th class="col-user"><i class="fas fa-user text-sky"></i> Assigned To</th>
                            <th class="col-alert-status"><i class="fas fa-bell text-sky"></i> Alert Status</th>
                            <th class="col-incident-status"><i class="fas fa-exclamation-triangle text-sky"></i> Incident Status</th>
                            <th class="col-action">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="alertsTableBody">
                        <tr>
                            <td colspan="7" class="text-center py-8">
                                <div class="flex flex-col items-center justify-center">
                                    <div class="loading-spinner mb-3"></div>
                                    <p class="text-sm opacity-50">Loading your alerts...</p>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="p-4 border-t border-white/5 bg-black/20">
            <div class="flex flex-wrap items-center justify-between gap-3">
                <div class="flex flex-wrap gap-3">
                    <div class="flex items-center gap-1"><span class="status-dot status-dot-unacknowledged"></span><span class="text-xs opacity-50">Unacknowledged</span></div>
                    <div class="flex items-center gap-1"><span class="status-dot status-dot-acknowledged"></span><span class="text-xs opacity-50">Acknowledged</span></div>
                    <div class="flex items-center gap-1"><span class="status-dot status-dot-resolved"></span><span class="text-xs opacity-50">Resolved</span></div>
                    {% if user.role == 'admin' %}
                    <div class="flex items-center gap-1"><span class="status-dot status-dot-pending"></span><span class="text-xs opacity-50">Pending Review</span></div>
                    {% endif %}
                </div>
                <div class="text-xs opacity-30">
                    <i class="far fa-clock mr-1"></i> Updated: <span id="tableUpdateTime">--:--:--</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Action Bar -->
    <div id="bulkActionBar" class="hidden fixed bottom-4 left-1/2 transform -translate-x-1/2 px-4 py-3 flex items-center gap-4 z-50 rounded-lg shadow-xl">
        <span class="text-sm"><span id="selectedCount" class="font-bold text-sky">0</span> alert(s) selected</span>
        <div class="flex gap-2">
            <button onclick="bulkDeleteAlerts()" class="hover:bg-white/10 px-4 py-2 rounded-lg text-sm transition flex items-center gap-2">
                <i class="fas fa-trash-alt text-alert icon-xs"></i> Delete Selected
            </button>
            <button onclick="clearSelection()" class="hover:bg-white/10 px-4 py-2 rounded-lg text-sm transition">Cancel</button>
        </div>
    </div>

    <!-- User Information Panel -->
    <div class="bg-[#1E293B] rounded-xl shadow overflow-hidden border border-white/5">
        <div class="p-4 md:p-6 border-b border-white/5">
            <div class="flex items-center gap-3">
                <div class="bg-white/5 p-2 md:p-3 rounded-lg">
                    <i class="fas fa-user-circle text-sky text-xl md:text-2xl"></i>
                </div>
                <div>
                    <h3 class="text-lg md:text-xl font-bold">User Information</h3>
                    <p class="text-sm opacity-40">Your role and system access</p>
                </div>
            </div>
        </div>
        <div class="p-4 md:p-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
                <div class="space-y-3">
                    <div>
                        <p class="text-sm opacity-40">Name</p>
                        <p class="text-base md:text-lg font-semibold">{{ user.first_name }} {{ user.last_name }}</p>
                    </div>
                    <div>
                        <p class="text-sm opacity-40">Email</p>
                        <p class="text-base md:text-lg">{{ user.email }}</p>
                    </div>
                </div>
                <div class="space-y-3">
                    <div>
                        <p class="text-sm opacity-40">Role</p>
                        <p class="text-base md:text-lg">
                            <span class="role-badge">
                                <i class="fas {% if user.role == 'admin' %}fa-shield-alt text-sky{% else %}fa-user-shield text-greenlight{% endif %}"></i>
                                <span>{{ user.role|title }}</span>
                            </span>
                        </p>
                    </div>
                    <div>
                        <p class="text-sm opacity-40">Account Status</p>
                        <p class="text-base md:text-lg font-semibold text-greenlight flex items-center gap-1">
                            <i class="fas fa-check-circle icon-xs"></i> Active
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div class="mt-6 md:mt-8 text-center text-xs opacity-30">
        <p>DisgrasEye Dashboard &bull; Real-time updates enabled &bull; Auto-refresh every 30 seconds</p>
    </div>
</div>
{% endblock %}