{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}Dashboard | DisgrasEye{% endblock %}

{% block extra_head %}
<style>
    /* Enhanced mobile styles */
    @media (max-width: 640px) {
        .gradient-bg {
            padding: 1.5rem !important;
        }
        
        .gradient-bg h1 {
            font-size: 1.75rem !important;
        }
        
        .stats-grid {
            gap: 0.75rem !important;
        }
        
        .stat-card {
            padding: 1rem !important;
        }
        
        .stat-card h2 {
            font-size: 1.5rem !important;
        }
        
        .quick-actions-grid {
            gap: 0.5rem !important;
        }
        
        .quick-action-btn {
            padding: 0.75rem !important;
        }
        
        .quick-action-btn i {
            font-size: 1.25rem !important;
        }
    }
    
    /* Loading animations */
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .fade-in {
        animation: fadeIn 0.3s ease-out;
    }
    
    /* Refresh button animation */
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    
    .spinning {
        animation: spin 0.5s linear infinite;
    }
    
    /* Alert priority colors */
    .priority-critical {
        background: linear-gradient(135deg, #ff4444, #ff0000);
        color: white;
    }
    
    .priority-high {
        background: linear-gradient(135deg, #ff8800, #ff5500);
        color: white;
    }
    
    .priority-medium {
        background: linear-gradient(135deg, #ffbb33, #ffaa00);
        color: white;
    }
    
    .priority-low {
        background: linear-gradient(135deg, #00C851, #007E33);
        color: white;
    }
</style>
{% endblock %}

{% block extra_scripts %}
<script>
// Dashboard specific JavaScript - wrapped in IIFE to avoid conflicts
(function() {
    'use strict';
    
    let dashboardData = {};
    let dashboardSupabase = null;
    let isRefreshing = false;
    let refreshInterval;

    function getSupabaseClient() {
        if (!dashboardSupabase) {
            // Try to get from window (set by base.html)
            if (window._supabase) {
                dashboardSupabase = window._supabase;
            } else {
                // Initialize directly if needed
                const supabaseUrl = "{{ SUPABASE_URL }}";
                const supabaseAnonKey = "{{ SUPABASE_ANON_KEY }}";
                
                dashboardSupabase = supabase.createClient(supabaseUrl, supabaseAnonKey);
            }
        }
        return dashboardSupabase;
    }

    async function loadDashboardData(showLoading = true) {
        if (isRefreshing) return;
        
        isRefreshing = true;
        const refreshBtn = document.querySelector('button[onclick*="loadDashboardData"]');
        if (refreshBtn && showLoading) {
            refreshBtn.innerHTML = '<i class="bi bi-arrow-clockwise spinning"></i> Refreshing...';
            refreshBtn.disabled = true;
        }
        
        try {
            const supabaseClient = getSupabaseClient();
            const currentUserRole = "{{ user.role }}";
            const currentUserId = {{ user.user_id }};
            
            if (!supabaseClient) {
                console.error('Supabase client not available');
                return;
            }
            
            // Show loading states
            if (showLoading) {
                showLoadingStates();
            }
            
            // Fetch data based on user role
            const [accidentResponse, alertResponse] = await Promise.allSettled([
                // Get accident detections
                supabaseClient
                    .from('accident_detections')
                    .select(`
                        accident_id,
                        detection_time,
                        camera_id,
                        status
                    `)
                    .order('detection_time', { ascending: false })
                    .limit(50),
                    
                // Get alerts FOR CURRENT USER ONLY
                supabaseClient
                    .from('alerts')
                    .select(`
                        alert_id,
                        alert_time,
                        message,
                        response_status,
                        detection_id,
                        sent_to,
                        accident_detections: detection_id (
                            detection_time,
                            camera_id,
                            status
                        ),
                        users: sent_to (
                            first_name,
                            last_name,
                            role
                        )
                    `)
                    .eq('sent_to', currentUserId)  // Only current user's alerts
                    .order('alert_time', { ascending: false })
                    .limit(20)
            ]);
            
            const accidentData = accidentResponse.status === 'fulfilled' && !accidentResponse.value.error 
                ? accidentResponse.value.data 
                : [];
                
            const alertData = alertResponse.status === 'fulfilled' && !alertResponse.value.error 
                ? alertResponse.value.data 
                : [];
            
            // Process the data
            processDashboardData(accidentData, alertData, currentUserRole);
            
            // Update last update time
            const lastUpdateElement = document.getElementById('lastUpdate');
            if (lastUpdateElement) {
                lastUpdateElement.textContent = 'Last update: ' + new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            }
            
            // Add fade-in animation
            document.querySelectorAll('#accidentsToday, #pendingAlerts, #respondedCases, #totalDetections, #responseRate')
                .forEach(el => {
                    el.classList.add('fade-in');
                    setTimeout(() => el.classList.remove('fade-in'), 300);
                });
            
        } catch (error) {
            console.error('Error loading dashboard data:', error);
        } finally {
            isRefreshing = false;
            if (refreshBtn && showLoading) {
                refreshBtn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> <span class="hidden sm:inline">Refresh</span>';
                refreshBtn.disabled = false;
            }
        }
    }

    function showLoadingStates() {
        // Show loading animation in tables
        const tbody = document.querySelector('#recentAlertsTable tbody');
        const mobileView = document.getElementById('mobileAlertsView');
        
        if (tbody) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="py-8 text-center text-gray-500">
                        <div class="animate-spin h-8 w-8 border-2 border-sky border-t-transparent rounded-full mx-auto mb-2"></div>
                        Loading your alerts...
                    </td>
                </tr>
            `;
        }
        
        if (mobileView) {
            mobileView.innerHTML = `
                <div class="text-center py-8 text-gray-500">
                    <div class="animate-spin h-8 w-8 border-2 border-sky border-t-transparent rounded-full mx-auto mb-2"></div>
                    <p>Loading your alerts...</p>
                </div>
            `;
        }
        
        // Show skeleton loading for stats
        ['accidentsToday', 'pendingAlerts', 'respondedCases', 'totalDetections', 'responseRate'].forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.textContent = '--';
            }
        });
    }

    function processDashboardData(accidentDetections, alerts, userRole) {
        const today = new Date().toDateString();
        
        // Calculate statistics with workflow connections
        const accidentsToday = accidentDetections.filter(d => {
            try {
                const detectionDate = new Date(d.detection_time).toDateString();
                return detectionDate === today;
            } catch {
                return false;
            }
        }).length;
        
        // Pending alerts (Unacknowledged) - ONLY YOUR ALERTS
        const pendingAlerts = alerts.filter(a => a.response_status === 'Unacknowledged').length;
        
        // Responded cases (Verified detections)
        const respondedCases = accidentDetections.filter(d => d.status === 'Verified').length;
        
        // Total detections
        const totalDetections = accidentDetections.length;
        
        // Calculate response rate (percentage of detections that have been verified)
        const responseRate = totalDetections > 0 ? 
            Math.round((respondedCases / totalDetections) * 100) : 0;

        // Update UI elements with animation
        updateElementWithAnimation('accidentsToday', accidentsToday);
        updateElementWithAnimation('pendingAlerts', pendingAlerts);
        updateElementWithAnimation('respondedCases', respondedCases);
        updateElementWithAnimation('totalDetections', totalDetections);
        updateElementWithAnimation('responseRate', responseRate + '%');
        
        const responseRateBar = document.getElementById('responseRateBar');
        if (responseRateBar) {
            responseRateBar.style.width = responseRate + '%';
        }

        // Show alert workflow - ONLY YOUR ALERTS
        updateAlertWorkflow(alerts, userRole);
        updateSystemStatus(accidentDetections);

        // Store data for later use
        dashboardData = {
            accidentsToday, 
            pendingAlerts, 
            respondedCases, 
            totalDetections, 
            responseRate,
            recentDetections: accidentDetections,
            alerts: alerts
        };
    }

    function updateAlertWorkflow(alerts, userRole) {
        const tbody = document.querySelector('#recentAlertsTable tbody');
        const mobileView = document.getElementById('mobileAlertsView');
        
        if (!tbody || !mobileView) return;
        
        if (alerts.length > 0) {
            // Desktop table view - Show YOUR alerts
            tbody.innerHTML = alerts.map((alert, index) => {
                const accident = alert.accident_detections || {};
                const user = alert.users || {};
                let alertTime, detectionTime;
                
                try {
                    alertTime = new Date(alert.alert_time).toLocaleString();
                    detectionTime = accident.detection_time ? new Date(accident.detection_time).toLocaleString() : 'N/A';
                } catch {
                    alertTime = 'Invalid Date';
                    detectionTime = 'N/A';
                }
                
                // Determine camera display
                const cameraDisplay = accident.camera_id ? 
                    `Camera ${accident.camera_id}` : 'Unknown Camera';
                
                // Determine alert priority based on response status
                const priorityClass = alert.response_status === 'Unacknowledged' ? 'priority-critical' :
                                    alert.response_status === 'Acknowledged' ? 'priority-high' : 'priority-low';
                
                const priorityText = alert.response_status === 'Unacknowledged' ? 'Critical' :
                                   alert.response_status === 'Acknowledged' ? 'High' : 'Low';
                
                // Show appropriate action button based on role
                let actionButton = '';
                if (userRole === 'admin' && accident.status === 'Pending') {
                    actionButton = `
                        <button onclick="reviewAccident(${accident.accident_id})" 
                                class="text-xs bg-sky hover:bg-sky/80 text-white px-3 py-1 rounded transition">
                            Review
                        </button>
                    `;
                } else if (userRole === 'tanod' && alert.response_status === 'Unacknowledged') {
                    actionButton = `
                        <button onclick="acknowledgeAlert(${alert.alert_id})" 
                                class="text-xs bg-greenlight hover:bg-greenlight/80 text-white px-3 py-1 rounded transition">
                            Acknowledge
                        </button>
                    `;
                }
                
                return `
                    <tr class="border-b border-gray-600 hover:bg-gray-600/30 transition-colors fade-in" style="animation-delay: ${index * 50}ms">
                        <td class="py-3 px-4">
                            <div class="flex flex-col">
                                <span class="font-medium">${alertTime.split(',')[0]}</span>
                                <span class="text-xs text-gray-400">${alertTime.split(',')[1]?.trim() || ''}</span>
                            </div>
                        </td>
                        <td class="py-3 px-4">
                            <div class="flex items-center gap-2">
                                <i class="bi bi-camera-video text-sky"></i>
                                <span>${cameraDisplay}</span>
                            </div>
                        </td>
                        <td class="py-3 px-4">
                            <div class="flex flex-col">
                                <span class="font-medium">${user.first_name || ''} ${user.last_name || ''}</span>
                                <span class="text-xs text-gray-400 capitalize">${user.role || 'User'}</span>
                            </div>
                        </td>
                        <td class="py-3 px-4">
                            <span class="inline-flex px-2 py-0.5 rounded-full text-xs font-medium ${priorityClass}">
                                <i class="bi ${alert.response_status === 'Unacknowledged' ? 'bi-exclamation-triangle' : 
                                            alert.response_status === 'Acknowledged' ? 'bi-exclamation-circle' : 
                                            'bi-check-circle'} mr-1"></i>
                                ${priorityText}
                            </span>
                        </td>
                        <td class="py-3 px-4 ${alert.response_status === 'Unacknowledged' ? 'text-alert' : 
                                            alert.response_status === 'Acknowledged' ? 'text-gold' : 
                                            'text-greenlight'} flex items-center gap-1">
                            <i class="bi ${alert.response_status === 'Unacknowledged' ? 'bi-clock' : 
                                        alert.response_status === 'Acknowledged' ? 'bi-person-check' : 
                                        'bi-check-circle'}"></i>
                            ${alert.response_status || 'Unknown'}
                        </td>
                        <td class="py-3 px-4 text-right">
                            <div class="flex items-center justify-end gap-2">
                                ${actionButton}
                                <span class="text-xs text-gray-400">Alert #${alert.alert_id}</span>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            // Mobile card view - Show YOUR alerts
            mobileView.innerHTML = alerts.map((alert, index) => {
                const accident = alert.accident_detections || {};
                const user = alert.users || {};
                let alertTime;
                
                try {
                    alertTime = new Date(alert.alert_time).toLocaleString();
                } catch {
                    alertTime = 'Invalid Date';
                }
                
                const cameraDisplay = accident.camera_id ? 
                    `Camera ${accident.camera_id}` : 'Unknown Camera';
                    
                const priorityClass = alert.response_status === 'Unacknowledged' ? 'priority-critical' :
                                    alert.response_status === 'Acknowledged' ? 'priority-high' : 'priority-low';
                
                return `
                <div class="bg-[#112240] rounded-lg p-4 border border-gray-600 mb-3 fade-in" style="animation-delay: ${index * 50}ms">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex items-center gap-2">
                            <i class="bi ${alert.response_status === 'Unacknowledged' ? 'bi-bell text-alert' : 
                                        alert.response_status === 'Acknowledged' ? 'bi-bell text-gold' : 
                                        'bi-bell-check text-greenlight'}"></i>
                            <div>
                                <div class="font-semibold text-white">Your Alert #${alert.alert_id}</div>
                                <div class="text-xs text-gray-400">${alertTime.split(',')[0]}</div>
                            </div>
                        </div>
                        <span class="inline-flex px-2 py-0.5 rounded-full text-xs font-medium ${priorityClass}">
                            ${user.role === 'admin' ? 'Admin' : 'Tanod'}
                        </span>
                    </div>
                    <div class="space-y-2">
                        <div class="text-sm">
                            <p class="font-medium">${alert.message}</p>
                        </div>
                        <div class="flex items-center justify-between text-sm">
                            <span class="text-gray-400">Camera</span>
                            <span class="flex items-center gap-1">
                                <i class="bi bi-camera-video"></i>
                                ${cameraDisplay}
                            </span>
                        </div>
                        <div class="flex items-center justify-between text-sm">
                            <span class="text-gray-400">Accident Status</span>
                            <span class="${accident.status === 'Pending' ? 'text-alert' : 
                                       accident.status === 'Verified' ? 'text-greenlight' : 
                                       'text-gold'}">
                                ${accident.status || 'Unknown'}
                            </span>
                        </div>
                        <div class="pt-2">
                            ${userRole === 'admin' && accident.status === 'Pending' ? `
                            <button onclick="reviewAccident(${accident.accident_id})" 
                                    class="w-full bg-sky hover:bg-sky/80 text-white py-2 rounded-lg text-sm transition">
                                Review Accident
                            </button>
                            ` : userRole === 'tanod' && alert.response_status === 'Unacknowledged' ? `
                            <button onclick="acknowledgeAlert(${alert.alert_id})" 
                                    class="w-full bg-greenlight hover:bg-greenlight/80 text-white py-2 rounded-lg text-sm transition">
                                Acknowledge Alert
                            </button>
                            ` : ''}
                            <div class="text-center text-xs text-gray-400 mt-2">
                                Alert Time: ${alertTime.split(',')[1]?.trim() || ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            }).join('');
        } else {
            // No alerts found for this user
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="py-8 text-center text-gray-500 fade-in">
                        <i class="bi ${userRole === 'admin' ? 'bi-eye text-sky' : 'bi-shield-check text-greenlight'} text-2xl mb-2"></i>
                        <p class="text-lg">No ${userRole} alerts found</p>
                        <p class="text-sm text-gray-400 mt-1">You'll be notified when ${userRole === 'admin' ? 'an accident needs review' : 'action is required'}</p>
                    </td>
                </tr>
            `;
            mobileView.innerHTML = `
                <div class="text-center py-8 text-gray-500 fade-in">
                    <i class="bi ${userRole === 'admin' ? 'bi-eye text-sky' : 'bi-shield-check text-greenlight'} text-2xl mb-2"></i>
                    <p class="text-lg">No ${userRole} alerts found</p>
                    <p class="text-sm text-gray-400 mt-1">You'll be notified when ${userRole === 'admin' ? 'an accident needs review' : 'action is required'}</p>
                </div>
            `;
        }
    }

    async function acknowledgeAlert(alertId) {
        try {
            const supabaseClient = getSupabaseClient();
            const { error } = await supabaseClient
                .from('alerts')
                .update({ 
                    response_status: 'Acknowledged'
                })
                .eq('alert_id', alertId);
            
            if (error) throw error;
            
            // Show success message
            alert('‚úÖ Alert acknowledged successfully!');
            
            // Refresh dashboard data
            loadDashboardData();
        } catch (error) {
            console.error('Error acknowledging alert:', error);
            alert('‚ùå Failed to acknowledge alert. Please try again.');
        }
    }

    function updateSystemStatus(detections) {
        const statusElement = document.getElementById('systemStatus');
        const statusIcon = document.getElementById('statusIcon');
        const statusText = document.getElementById('statusText');
        
        if (!statusElement || !statusIcon || !statusText) return;
        
        // Check for recent detections
        const recentDetection = detections[0];
        let status = 'normal';
        let message = 'System Active';
        let color = 'greenlight';
        let icon = 'bi-check-circle';
        
        if (recentDetection) {
            try {
                const timeDiff = new Date() - new Date(recentDetection.detection_time);
                const minutesAgo = Math.floor(timeDiff / (1000 * 60));
                
                if (minutesAgo < 5) {
                    status = 'active';
                    message = 'System Active';
                    color = 'greenlight';
                    icon = 'bi-check-circle';
                } else if (minutesAgo < 30) {
                    status = 'warning';
                    message = 'Delayed Data';
                    color = 'gold';
                    icon = 'bi-exclamation-triangle';
                } else {
                    status = 'inactive';
                    message = 'No Recent Data';
                    color = 'alert';
                    icon = 'bi-exclamation-circle';
                }
            } catch {
                status = 'warning';
                message = 'Data Error';
                color = 'gold';
                icon = 'bi-exclamation-triangle';
            }
        } else {
            status = 'inactive';
            message = 'No Data';
            color = 'alert';
            icon = 'bi-exclamation-circle';
        }
        
        // Update UI
        statusElement.className = `bg-${color}/20 text-${color} text-sm px-3 py-1 rounded-full flex items-center gap-1 fade-in`;
        statusIcon.className = `bi ${icon}`;
        statusText.textContent = message;
    }

    function updateElementWithAnimation(elementId, text) {
        const element = document.getElementById(elementId);
        if (element) {
            // Only animate if value changed
            if (element.textContent !== text.toString()) {
                element.classList.add('fade-in');
                element.textContent = text;
                setTimeout(() => element.classList.remove('fade-in'), 300);
            } else {
                element.textContent = text;
            }
        }
    }

    // ========== ADMIN WORKFLOW FUNCTIONS ==========
    
    async function loadAdminActions() {
        if ("{{ user.role }}" !== 'admin') return;
        
        try {
            const supabaseClient = getSupabaseClient();
            
            // Get pending accidents that need review (camera_id can be null)
            const { data: pendingData, error: pendingError } = await supabaseClient
                .from('accident_detections')
                .select(`
                    accident_id,
                    detection_time,
                    video_clip,
                    camera_id,
                    cctv: camera_id (location_name)
                `)
                .eq('status', 'Pending')
                .order('detection_time', { ascending: false })
                .limit(5);
            
            if (pendingError) throw pendingError;
            
            // Update pending review section
            const pendingList = document.getElementById('pendingList');
            const pendingCount = document.getElementById('pendingCount');
            
            if (pendingList) {
                if (pendingData && pendingData.length > 0) {
                    pendingCount.textContent = pendingData.length;
                    
                    pendingList.innerHTML = pendingData.map(accident => {
                        // Handle null camera_id
                        const cameraDisplay = accident.camera_id ? 
                            `Camera ${accident.camera_id}` : 'Unknown Camera';
                        const locationName = accident.cctv?.location_name || 
                            (accident.camera_id ? `Camera ${accident.camera_id}` : 'Unknown Location');
                        
                        return `
                            <div class="bg-[#0A192F] rounded p-3 border border-gray-600">
                                <div class="flex justify-between items-start mb-2">
                                    <div>
                                        <p class="font-medium text-sm">${cameraDisplay}</p>
                                        <p class="text-xs text-gray-400">
                                            ${locationName} ‚Ä¢ 
                                            ${new Date(accident.detection_time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                                        </p>
                                    </div>
                                    <span class="text-xs bg-gold/20 text-gold px-2 py-1 rounded">Pending</span>
                                </div>
                                <div class="flex gap-2 mt-2">
                                    <button onclick="reviewAccident(${accident.accident_id})" 
                                            class="flex-1 bg-sky hover:bg-sky/80 text-white py-1.5 text-xs rounded transition">
                                        <i class="bi bi-eye"></i> Review
                                    </button>
                                    <button onclick="verifyAccident(${accident.accident_id}, true)" 
                                            class="flex-1 bg-greenlight hover:bg-greenlight/80 text-white py-1.5 text-xs rounded transition">
                                        <i class="bi bi-check"></i> Confirm
                                    </button>
                                    <button onclick="verifyAccident(${accident.accident_id}, false)" 
                                            class="flex-1 bg-alert hover:bg-alert/80 text-white py-1.5 text-xs rounded transition">
                                        <i class="bi bi-x"></i> False Alarm
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    pendingCount.textContent = '0';
                    pendingList.innerHTML = `
                        <div class="text-center py-4 text-gray-500">
                            <i class="bi bi-check-circle text-lg text-greenlight mb-1"></i>
                            <p class="text-sm">No pending reviews</p>
                        </div>
                    `;
                }
            }
            
            // Get recently verified accidents
            const { data: verifiedData, error: verifiedError } = await supabaseClient
                .from('accident_detections')
                .select(`
                    accident_id,
                    detection_time,
                    status,
                    camera_id,
                    cctv: camera_id (location_name)
                `)
                .in('status', ['Verified', 'False Alarm'])
                .order('detection_time', { ascending: false })
                .limit(5);
            
            if (verifiedError) throw verifiedError;
            
            // Update verified section
            const verifiedList = document.getElementById('verifiedList');
            const verifiedCount = document.getElementById('verifiedCount');
            
            if (verifiedList) {
                if (verifiedData && verifiedData.length > 0) {
                    verifiedCount.textContent = verifiedData.length;
                    
                    verifiedList.innerHTML = verifiedData.map(accident => {
                        const cameraDisplay = accident.camera_id ? 
                            `Camera ${accident.camera_id}` : 'Unknown Camera';
                        const locationName = accident.cctv?.location_name || 
                            (accident.camera_id ? `Camera ${accident.camera_id}` : 'Unknown Location');
                        
                        return `
                            <div class="bg-[#0A192F] rounded p-3 border border-gray-600">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="font-medium text-sm">${cameraDisplay}</p>
                                        <p class="text-xs text-gray-400">
                                            ${locationName} ‚Ä¢ 
                                            ${new Date(accident.detection_time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                                        </p>
                                    </div>
                                    <span class="text-xs ${accident.status === 'Verified' ? 'bg-greenlight/20 text-greenlight' : 'bg-alert/20 text-alert'} px-2 py-1 rounded">
                                        ${accident.status === 'Verified' ? 'Confirmed' : 'False Alarm'}
                                    </span>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    verifiedCount.textContent = '0';
                    verifiedList.innerHTML = `
                        <div class="text-center py-4 text-gray-500">
                            <i class="bi bi-clock-history text-lg text-gray-400 mb-1"></i>
                            <p class="text-sm">No verifications yet</p>
                        </div>
                    `;
                }
            }
            
        } catch (error) {
            console.error('Error loading admin actions:', error);
        }
    }

    async function reviewAccident(accidentId) {
        try {
            const supabaseClient = getSupabaseClient();
            
            const { data: accident, error } = await supabaseClient
                .from('accident_detections')
                .select(`
                    accident_id,
                    detection_time,
                    video_clip,
                    frame_image,
                    camera_id,
                    cctv: camera_id (location_name)
                `)
                .eq('accident_id', accidentId)
                .single();
            
            if (error) throw error;
            
            // Handle null camera
            const cameraDisplay = accident.camera_id ? 
                `Camera ${accident.camera_id}` : 'Unknown Camera';
            const locationName = accident.cctv?.location_name || 
                (accident.camera_id ? `Camera ${accident.camera_id}` : 'Unknown Location');
            
            // Create review modal
            const modalHTML = `
                <div id="reviewModal" class="fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4">
                    <div class="bg-[#1E293B] rounded-xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
                        <div class="p-4 md:p-6 border-b border-gray-600 flex justify-between items-center">
                            <div>
                                <h3 class="text-lg md:text-xl font-bold">Review Accident #${accident.accident_id}</h3>
                                <p class="text-sm text-gray-400">
                                    ${locationName} ‚Ä¢ 
                                    ${new Date(accident.detection_time).toLocaleString()}
                                </p>
                            </div>
                            <button onclick="document.getElementById('reviewModal').remove()" 
                                    class="text-gray-400 hover:text-white text-xl">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                        
                        <div class="p-4 md:p-6">
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6">
                                <div>
                                    <h4 class="font-semibold mb-2">Video Evidence</h4>
                                    ${accident.video_clip ? `
                                    <video src="${accident.video_clip}" controls class="w-full rounded-lg" style="max-height: 300px;"></video>
                                    ` : `
                                    <div class="bg-[#112240] rounded-lg p-8 text-center text-gray-500">
                                        <i class="bi bi-file-earmark-play text-3xl mb-2"></i>
                                        <p>No video available</p>
                                    </div>
                                    `}
                                </div>
                                
                                <div>
                                    <h4 class="font-semibold mb-2">Verification Actions</h4>
                                    <div class="space-y-3">
                                        <button onclick="verifyAccident(${accident.accident_id}, true, true)" 
                                                class="w-full bg-greenlight hover:bg-greenlight/80 text-white py-3 rounded-lg font-semibold transition flex items-center justify-center gap-2">
                                            <i class="bi bi-check-circle"></i> Confirm as Real Accident
                                        </button>
                                        <p class="text-xs text-gray-400 text-center">
                                            Tanods will receive immediate alert
                                        </p>
                                        
                                        <button onclick="verifyAccident(${accident.accident_id}, false, true)" 
                                                class="w-full bg-alert hover:bg-alert/80 text-white py-3 rounded-lg font-semibold transition flex items-center justify-center gap-2">
                                            <i class="bi bi-x-circle"></i> Mark as False Alarm
                                        </button>
                                        <p class="text-xs text-gray-400 text-center">
                                            Tanods will be notified to stand down
                                        </p>
                                        
                                        <button onclick="document.getElementById('reviewModal').remove()" 
                                                class="w-full bg-gray-600 hover:bg-gray-500 text-white py-2 rounded transition">
                                            Cancel Review
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
        } catch (error) {
            console.error('Error loading accident for review:', error);
            alert('‚ùå Failed to load accident details');
        }
    }

    async function verifyAccident(accidentId, isConfirmed, closeModal = false) {
        if (!confirm(isConfirmed ? 
            "Confirm this as a real accident?\nTanods will receive emergency alert!" : 
            "Mark this as false alarm?\nTanods will be notified to stand down.")) {
            return;
        }
        
        try {
            const supabaseClient = getSupabaseClient();
            
            // Step 4: Update accident status
            const { error: updateError } = await supabaseClient
                .from('accident_detections')
                .update({
                    status: isConfirmed ? 'Verified' : 'False Alarm',
                    created_at: new Date().toISOString()
                })
                .eq('accident_id', accidentId);
            
            if (updateError) throw updateError;
            
            // Step 5: Create appropriate alerts for tanods
            const { data: tanods, error: tanodError } = await supabaseClient
                .from('users')
                .select('user_id')
                .eq('role', 'tanod');
            
            if (tanodError) throw tanodError;
            
            if (tanods && tanods.length > 0) {
                const alerts = tanods.map(tanod => ({
                    detection_id: accidentId,
                    sent_to: tanod.user_id,
                    message: isConfirmed ? 
                        'üö® CONFIRMED ACCIDENT - Immediate Action Required!' :
                        '‚úÖ FALSE ALARM - Incident Cancelled. Stand down.',
                    response_status: 'Unacknowledged',
                    alert_time: new Date().toISOString()
                }));
                
                const { error: alertError } = await supabaseClient
                    .from('alerts')
                    .insert(alerts);
                
                if (alertError) throw alertError;
            }
            
            // Show success message
            if (closeModal) {
                document.getElementById('reviewModal')?.remove();
            }
            
            alert(isConfirmed ? 
                '‚úÖ Accident confirmed!\nTanods have been alerted to respond.' :
                '‚úÖ Marked as false alarm!\nTanods notified to stand down.');
            
            // Refresh all data
            loadDashboardData();
            loadAdminActions();
            
        } catch (error) {
            console.error('Error verifying accident:', error);
            alert('‚ùå Failed to verify accident. Please try again.');
        }
    }

    // Real-time updates with Supabase
    function setupRealtimeUpdates() {
        const supabaseClient = getSupabaseClient();
        if (!supabaseClient) return;

        // Subscribe to accident_detections changes
        supabaseClient
            .channel('accident-detections-changes')
            .on(
                'postgres_changes',
                {
                    event: '*',
                    schema: 'public',
                    table: 'accident_detections'
                },
                (payload) => {
                    console.log('Accident detection updated:', payload);
                    loadDashboardData(false);
                }
            )
            .subscribe();

        // Subscribe to alerts changes FOR CURRENT USER
        supabaseClient
            .channel('alerts-changes-user')
            .on(
                'postgres_changes',
                {
                    event: '*',
                    schema: 'public',
                    table: 'alerts',
                    filter: `sent_to=eq.{{ user.user_id }}`  // Only current user's alerts
                },
                (payload) => {
                    console.log('Your alert updated:', payload);
                    loadDashboardData(false);
                }
            )
            .subscribe();
    }

    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
        // Initial load
        loadDashboardData();
        
        // Load admin actions if user is admin
        if ("{{ user.role }}" === 'admin') {
            loadAdminActions();
            // Refresh admin panel every 15 seconds
            setInterval(loadAdminActions, 15000);
        }
        
        // Set up auto-refresh every 30 seconds
        refreshInterval = setInterval(() => loadDashboardData(false), 30000);
        
        // Set up real-time updates
        setupRealtimeUpdates();
    });

    // Make functions globally available
    window.loadDashboardData = loadDashboardData;
    window.acknowledgeAlert = acknowledgeAlert;
    window.reviewAccident = reviewAccident;
    window.verifyAccident = verifyAccident;
    window.loadAdminActions = loadAdminActions;
})();
</script>
{% endblock %}

{% block content %}
<!-- Dashboard Section -->
<div id="dashboard">
    <!-- Hero Welcome -->
    <div class="gradient-bg rounded-2xl p-6 md:p-8 mb-6 md:mb-8 text-center relative overflow-hidden">
        <div class="absolute inset-0 opacity-10">
            <div class="absolute w-48 h-48 md:w-64 md:h-64 bg-sky rounded-full -top-12 md:-top-16 -left-12 md:-left-16 pulse-slow"></div>
            <div class="absolute w-48 h-48 md:w-64 md:h-64 bg-alert rounded-full -bottom-12 md:-bottom-16 -right-12 md:-right-16 pulse-slow" style="animation-delay: 1s;"></div>
        </div>
        <div class="relative z-10 slide-up">
            <h1 class="text-2xl md:text-4xl lg:text-5xl font-bold text-white mb-3 md:mb-4">DisgrasEye Dashboard</h1>
            <p class="text-base md:text-xl text-graylight mb-4 md:mb-6">AI-Powered Real-Time Vehicle Crash Detection System</p>
            <div class="flex flex-col sm:flex-row gap-3 md:gap-4 justify-center">
                <a href="{% url 'cctv_monitoring' %}" class="bg-sky hover:bg-sky/80 text-white px-4 py-2 md:px-6 md:py-3 rounded-lg font-semibold transition-all transform hover:scale-105 shadow-lg flex items-center justify-center gap-2 text-sm md:text-base">
                    <i class="bi bi-camera-video"></i> <span class="hidden xs:inline">Monitor CCTV</span>
                </a>
                <a href="{% url 'live_monitoring' %}" class="bg-alert hover:bg-alert/80 text-white px-4 py-2 md:px-6 md:py-3 rounded-lg font-semibold transition-all transform hover:scale-105 shadow-lg flex items-center justify-center gap-2 text-sm md:text-base">
                    <i class="bi bi-broadcast"></i> <span class="hidden xs:inline">Live Detection</span>
                </a>
                <a href="{% url 'reports' %}" class="bg-greenlight hover:bg-greenlight/80 text-white px-4 py-2 md:px-6 md:py-3 rounded-lg font-semibold transition-all transform hover:scale-105 shadow-lg flex items-center justify-center gap-2 text-sm md:text-base">
                    <i class="bi bi-graph-up"></i> <span class="hidden xs:inline">View Reports</span>
                </a>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 md:gap-6 mb-6 md:mb-8 stats-grid">
        <div class="bg-[#1E293B] p-4 md:p-6 rounded-xl shadow hover:shadow-lg transition transform hover:-translate-y-1 border border-sky/20 stat-card">
            <div class="flex justify-between items-center">
                <div>
                    <p class="text-xs md:text-sm text-gray-400">Accidents Today</p>
                    <h2 class="text-xl md:text-3xl font-bold text-sky mt-1 md:mt-2" id="accidentsToday">0</h2>
                </div>
                <div class="bg-sky/20 p-2 md:p-3 rounded-lg">
                    <i class="bi bi-car-front text-sky text-lg md:text-xl"></i>
                </div>
            </div>
        </div>

        <div class="bg-[#1E293B] p-4 md:p-6 rounded-xl shadow hover:shadow-lg transition transform hover:-translate-y-1 border border-alert/20 stat-card">
            <div class="flex justify-between items-center">
                <div>
                    <p class="text-xs md:text-sm text-gray-400">Pending Alerts</p>
                    <h2 class="text-xl md:text-3xl font-bold text-alert mt-1 md:mt-2 pulse-alert" id="pendingAlerts">0</h2>
                </div>
                <div class="bg-alert/20 p-2 md:p-3 rounded-lg">
                    <i class="bi bi-exclamation-circle text-alert text-lg md:text-xl"></i>
                </div>
            </div>
        </div>

        <div class="bg-[#1E293B] p-4 md:p-6 rounded-xl shadow hover:shadow-lg transition transform hover:-translate-y-1 border border-greenlight/20 stat-card">
            <div class="flex justify-between items-center">
                <div>
                    <p class="text-xs md:text-sm text-gray-400">Responded Cases</p>
                    <h2 class="text-xl md:text-3xl font-bold text-greenlight mt-1 md:mt-2" id="respondedCases">0</h2>
                </div>
                <div class="bg-greenlight/20 p-2 md:p-3 rounded-lg">
                    <i class="bi bi-check-circle text-greenlight text-lg md:text-xl"></i>
                </div>
            </div>
        </div>

        <div class="bg-[#1E293B] p-4 md:p-6 rounded-xl shadow hover:shadow-lg transition transform hover:-translate-y-1 border border-gold/20 stat-card">
            <div class="flex justify-between items-center">
                <div>
                    <p class="text-xs md:text-sm text-gray-400">Response Rate</p>
                    <h2 class="text-xl md:text-3xl font-bold text-gold mt-1 md:mt-2" id="responseRate">0%</h2>
                </div>
                <div class="bg-gold/20 p-2 md:p-3 rounded-lg">
                    <i class="bi bi-bullseye text-gold text-lg md:text-xl"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Action Panel (Only for Admins) -->
    {% if user.role == 'admin' %}
    <div class="bg-[#1E293B] rounded-xl shadow overflow-hidden border border-sky/20 mb-6 md:mb-8">
        <div class="p-4 md:p-6 border-b border-gray-600">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <i class="bi bi-eye text-sky"></i>
                    <h3 class="text-lg md:text-xl font-bold">Admin Actions</h3>
                    <span class="text-sm text-gray-400 hidden sm:inline">Review & Verify Incidents</span>
                </div>
                <button onclick="loadAdminActions()" class="text-sm bg-sky hover:bg-sky/80 text-white px-3 py-1 rounded transition flex items-center gap-1">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
            </div>
        </div>
        
        <div class="p-4 md:p-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
                <!-- Pending Review Card -->
                <div class="bg-[#112240] rounded-lg p-4 border border-gold/30">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-2">
                            <i class="bi bi-clock-history text-gold"></i>
                            <h4 class="font-semibold">Pending Review</h4>
                        </div>
                        <span id="pendingCount" class="bg-gold text-black text-xs px-2 py-1 rounded-full">0</span>
                    </div>
                    <div id="pendingList" class="space-y-3">
                        <!-- Will be loaded via JavaScript -->
                        <div class="text-center py-4 text-gray-500">
                            <div class="animate-spin h-6 w-6 border-2 border-gold border-t-transparent rounded-full mx-auto mb-2"></div>
                            <p class="text-sm">Loading...</p>
                        </div>
                    </div>
                </div>
                
                <!-- Recent Verifications Card -->
                <div class="bg-[#112240] rounded-lg p-4 border border-greenlight/30">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-2">
                            <i class="bi bi-check-circle text-greenlight"></i>
                            <h4 class="font-semibold">Recent Verifications</h4>
                        </div>
                        <span id="verifiedCount" class="bg-greenlight text-black text-xs px-2 py-1 rounded-full">0</span>
                    </div>
                    <div id="verifiedList" class="space-y-3">
                        <!-- Will be loaded via JavaScript -->
                        <div class="text-center py-4 text-gray-500">
                            <div class="animate-spin h-6 w-6 border-2 border-greenlight border-t-transparent rounded-full mx-auto mb-2"></div>
                            <p class="text-sm">Loading...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- System Status and Performance Section -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6 mb-6 md:mb-8">
        <!-- System Status Card -->
        <div class="bg-[#1E293B] rounded-xl shadow overflow-hidden border border-gray-600">
            <div class="p-4 md:p-6 border-b border-gray-600">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <i class="bi bi-heart-pulse text-sky"></i>
                        <h3 class="text-lg md:text-xl font-bold">System Status</h3>
                    </div>
                    <span id="systemStatus" class="bg-greenlight/20 text-greenlight text-sm px-3 py-1 rounded-full flex items-center gap-1">
                        <i id="statusIcon" class="bi bi-check-circle"></i>
                        <span id="statusText">System Active</span>
                    </span>
                </div>
            </div>
            <div class="p-4 md:p-6">
                <div class="space-y-3 md:space-y-4">
                    <div class="flex justify-between items-center">
                        <span class="text-sm md:text-base text-gray-400">Response Rate</span>
                        <span class="text-xl md:text-2xl font-bold text-sky" id="responseRate">0%</span>
                    </div>
                    <div class="w-full bg-gray-600 rounded-full h-2">
                        <div id="responseRateBar" class="bg-sky h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                    <div class="grid grid-cols-3 gap-2 md:gap-4 text-xs md:text-sm">
                        <div class="text-center p-2 md:p-3 bg-sky/10 rounded-lg">
                            <div class="text-sky font-bold text-base md:text-lg" id="respondedCases">0</div>
                            <div class="text-gray-400">Responded</div>
                        </div>
                        <div class="text-center p-2 md:p-3 bg-alert/10 rounded-lg">
                            <div class="text-alert font-bold text-base md:text-lg" id="pendingAlerts">0</div>
                            <div class="text-gray-400">Pending</div>
                        </div>
                        <div class="text-center p-2 md:p-3 bg-gold/10 rounded-lg">
                            <div class="text-gold font-bold text-base md:text-lg" id="totalDetections">0</div>
                            <div class="text-gray-400">Total</div>
                        </div>
                    </div>
                    <div class="pt-2 text-center">
                        <small class="text-gray-400" id="lastUpdate">Last update: --:--</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions Card -->
        <div class="bg-[#1E293B] rounded-xl shadow overflow-hidden border border-gray-600">
            <div class="p-4 md:p-6 border-b border-gray-600">
                <div class="flex items-center gap-2">
                    <i class="bi bi-lightning-charge text-gold"></i>
                    <h3 class="text-lg md:text-xl font-bold">Quick Actions</h3>
                </div>
            </div>
            <div class="p-4 md:p-6">
                <div class="grid grid-cols-2 gap-3 md:gap-4 quick-actions-grid">
                    <a href="{% url 'cctv_monitoring' %}" class="bg-sky hover:bg-sky/80 text-white p-3 md:p-4 rounded-lg text-center transition transform hover:scale-105 quick-action-btn">
                        <i class="bi bi-camera-video text-xl md:text-2xl mb-1 md:mb-2"></i>
                        <div class="font-semibold text-sm md:text-base">Live CCTV</div>
                        <div class="text-xs md:text-sm opacity-80">Monitor Feeds</div>
                    </a>
                    <a href="{% url 'live_monitoring' %}" class="bg-alert hover:bg-alert/80 text-white p-3 md:p-4 rounded-lg text-center transition transform hover:scale-105 quick-action-btn">
                        <i class="bi bi-broadcast text-xl md:text-2xl mb-1 md:mb-2"></i>
                        <div class="font-semibold text-sm md:text-base">Live Detection</div>
                        <div class="text-xs md:text-sm opacity-80">Test System</div>
                    </a>
                    <a href="{% url 'reports' %}" class="bg-greenlight hover:bg-greenlight/80 text-white p-3 md:p-4 rounded-lg text-center transition transform hover:scale-105 quick-action-btn">
                        <i class="bi bi-graph-up text-xl md:text-2xl mb-1 md:mb-2"></i>
                        <div class="font-semibold text-sm md:text-base">Reports</div>
                        <div class="text-xs md:text-sm opacity-80">View Analytics</div>
                    </a>
                    <button onclick="loadDashboardData()" class="bg-gold hover:bg-gold/80 text-gray-900 p-3 md:p-4 rounded-lg text-center transition transform hover:scale-105 quick-action-btn">
                        <i class="bi bi-arrow-clockwise text-xl md:text-2xl mb-1 md:mb-2"></i>
                        <div class="font-semibold text-sm md:text-base">Refresh</div>
                        <div class="text-xs md:text-sm opacity-80">Update Data</div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Alert Workflow Section -->
    <div class="bg-[#1E293B] rounded-xl shadow overflow-hidden border border-gray-600">
        <div class="p-4 md:p-6 border-b border-gray-600 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <i class="bi bi-diagram-3 text-sky"></i>
                <h3 class="text-lg md:text-xl font-bold">Your Alert Workflow</h3>
                <span class="text-sm text-gray-400">({{ user.role|title }} View)</span>
            </div>
            <div class="flex items-center gap-2">
                <span class="text-xs text-gray-400 hidden sm:inline">Real-time updates</span>
                <button onclick="loadDashboardData()" class="text-xs md:text-sm bg-sky hover:bg-sky/80 text-white px-2 md:px-3 py-1 md:py-1 rounded transition flex items-center gap-1">
                    <i class="bi bi-arrow-clockwise"></i> <span class="hidden sm:inline">Refresh</span>
                </button>
            </div>
        </div>
        
        <!-- Desktop Table View -->
        <div class="hidden md:block overflow-x-auto">
            <table class="w-full text-left" id="recentAlertsTable">
                <thead class="bg-[#112240]">
                    <tr>
                        <th class="py-3 px-4">Alert Time</th>
                        <th class="py-3 px-4">Camera</th>
                        <th class="py-3 px-4">Assigned To</th>
                        <th class="py-3 px-4">Priority</th>
                        <th class="py-3 px-4">Status</th>
                        <th class="py-3 px-4 text-right">Action</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="6" class="py-8 text-center text-gray-500">
                            <i class="bi bi-arrow-repeat text-2xl mb-2 animate-spin"></i><br>
                            Loading your alerts...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Mobile Card View -->
        <div class="md:hidden p-4" id="mobileAlertsView">
            <div class="text-center py-8 text-gray-500">
                <i class="bi bi-arrow-repeat text-2xl mb-2 animate-spin"></i>
                <p>Loading your alerts...</p>
            </div>
        </div>
        
        <!-- Workflow Legend -->
                            <div class="p-4 border-t border-gray-600 bg-[#112240]">
                            <div class="flex flex-wrap gap-3 md:gap-4 justify-center text-xs md:text-sm">
                                <div class="flex items-center gap-1">
                                    <div class="w-3 h-3 rounded-full bg-alert"></div>
                                    <span>Unacknowledged - Immediate Action</span>
                                </div>
                                <div class="flex items-center gap-1">
                                    <div class="w-3 h-3 rounded-full bg-gold"></div>
                                    <span>Acknowledged - Response Pending</span>
                                </div>
                                <div class="flex items-center gap-1">
                                    <div class="w-3 h-3 rounded-full bg-greenlight"></div>
                                    <span>Completed - Case Closed</span>
                                </div>
                                {% if user.role == 'admin' %}
                                <div class="flex items-center gap-1">
                                    <div class="w-3 h-3 rounded-full bg-sky"></div>
                                    <span>Admin Review Required</span>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- User Info Panel -->
                <div class="bg-[#1E293B] rounded-xl shadow overflow-hidden border border-gray-600 mt-6 md:mt-8">
                    <div class="p-4 md:p-6 border-b border-gray-600">
                        <div class="flex items-center gap-3">
                            <div class="bg-sky/20 p-2 md:p-3 rounded-lg">
                                <i class="bi bi-person-circle text-sky text-xl md:text-2xl"></i>
                            </div>
                            <div>
                                <h3 class="text-lg md:text-xl font-bold">User Information</h3>
                                <p class="text-sm text-gray-400">Your role and system access</p>
                            </div>
                        </div>
                    </div>
                    <div class="p-4 md:p-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
                            <div class="space-y-3">
                                <div>
                                    <p class="text-sm text-gray-400">Full Name</p>
                                    <p class="text-base md:text-lg font-semibold">{{ user.first_name }} {{ user.last_name }}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-400">Role</p>
                                    <p class="text-base md:text-lg">
                                        <span class="inline-flex items-center gap-1 px-2 py-1 rounded 
                                            {% if user.role == 'admin' %}bg-sky/20 text-sky
                                            {% elif user.role == 'tanod' %}bg-greenlight/20 text-greenlight
                                            {% else %}bg-gray-600 text-gray-300{% endif %}">
                                            <i class="bi 
                                                {% if user.role == 'admin' %}bi-shield-check
                                                {% elif user.role == 'tanod' %}bi-shield-exclamation
                                                {% else %}bi-person{% endif %}"></i>
                                            {{ user.role|title }}
                                        </span>
                                    </p>
                                </div>
                            </div>
                            <div class="space-y-3">
                                <div>
                                    <p class="text-sm text-gray-400">Account Status</p>
                                    <p class="text-base md:text-lg font-semibold text-greenlight flex items-center gap-1">
                                        <i class="bi bi-check-circle"></i> Active
                                    </p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-400">Dashboard Type</p>
                                    <p class="text-base md:text-lg">
                                        <span class="inline-flex items-center gap-1 px-2 py-1 rounded bg-sky/20 text-sky">
                                            <i class="bi bi-layout-text-window"></i>
                                            {% if user.role == 'admin' %}Administrator Dashboard
                                            {% elif user.role == 'tanod' %}Tanod Response Dashboard
                                            {% else %}Standard Dashboard{% endif %}
                                        </span>
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-4 md:mt-6 pt-4 border-t border-gray-600">
                            <p class="text-sm text-gray-400 mb-2">Your Permissions:</p>
                            <div class="flex flex-wrap gap-2">
                                {% if user.role == 'admin' %}
                                <span class="inline-flex items-center gap-1 px-2 py-1 rounded bg-sky/20 text-sky text-xs">
                                    <i class="bi bi-eye"></i> Review Accidents
                                </span>
                                <span class="inline-flex items-center gap-1 px-2 py-1 rounded bg-sky/20 text-sky text-xs">
                                    <i class="bi bi-check-circle"></i> Verify Detections
                                </span>
                                <span class="inline-flex items-center gap-1 px-2 py-1 rounded bg-sky/20 text-sky text-xs">
                                    <i class="bi bi-bar-chart"></i> View Analytics
                                </span>
                                <span class="inline-flex items-center gap-1 px-2 py-1 rounded bg-sky/20 text-sky text-xs">
                                    <i class="bi bi-gear"></i> System Settings
                                </span>
                                {% elif user.role == 'tanod' %}
                                <span class="inline-flex items-center gap-1 px-2 py-1 rounded bg-greenlight/20 text-greenlight text-xs">
                                    <i class="bi bi-bell"></i> Receive Alerts
                                </span>
                                <span class="inline-flex items-center gap-1 px-2 py-1 rounded bg-greenlight/20 text-greenlight text-xs">
                                    <i class="bi bi-check-circle"></i> Acknowledge Alerts
                                </span>
                                <span class="inline-flex items-center gap-1 px-2 py-1 rounded bg-greenlight/20 text-greenlight text-xs">
                                    <i class="bi bi-clock-history"></i> View History
                                </span>
                                {% else %}
                                <span class="inline-flex items-center gap-1 px-2 py-1 rounded bg-gray-600 text-gray-300 text-xs">
                                    <i class="bi bi-eye"></i> View Only
                                </span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity Timeline (Simplified for mobile) -->
                <div class="bg-[#1E293B] rounded-xl shadow overflow-hidden border border-gray-600 mt-6 md:mt-8">
                    <div class="p-4 md:p-6 border-b border-gray-600">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <i class="bi bi-clock-history text-sky"></i>
                                <h3 class="text-lg md:text-xl font-bold">Recent System Activity</h3>
                            </div>
                            <span class="text-xs text-gray-400 hidden sm:inline">Last 24 hours</span>
                        </div>
                    </div>
                    <div class="p-4 md:p-6">
                        <div class="relative">
                            <!-- Timeline line -->
                            <div class="absolute left-4 md:left-5 top-0 bottom-0 w-0.5 bg-gray-600"></div>
                            
                            <div class="space-y-4 pl-8 md:pl-10">
                                <!-- Timeline items will be loaded via JavaScript -->
                                <div id="timelineItems" class="space-y-4">
                                    <!-- Example timeline item -->
                                    <div class="relative fade-in">
                                        <div class="absolute -left-9 md:-left-10 top-1 w-4 h-4 md:w-5 md:h-5 rounded-full border-2 border-sky bg-[#1E293B]"></div>
                                        <div class="bg-[#112240] rounded-lg p-3 md:p-4 border border-gray-600">
                                            <div class="flex items-start justify-between">
                                                <div>
                                                    <p class="font-medium text-sm md:text-base">System Initialized</p>
                                                    <p class="text-xs md:text-sm text-gray-400">Dashboard loaded successfully</p>
                                                </div>
                                                <span class="text-xs text-gray-400">Just now</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Loading state for real data -->
                                    <div id="activityLoading" class="text-center py-4 text-gray-500">
                                        <div class="animate-spin h-6 w-6 border-2 border-sky border-t-transparent rounded-full mx-auto mb-2"></div>
                                        <p class="text-sm">Loading recent activity...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Refresh activity button -->
                        <div class="mt-4 pt-4 border-t border-gray-600 text-center">
                            <button onclick="loadRecentActivity()" class="text-sm bg-sky hover:bg-sky/80 text-white px-4 py-2 rounded transition flex items-center gap-1 mx-auto">
                                <i class="bi bi-arrow-clockwise"></i> Load Recent Activity
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer note -->
            <div class="mt-6 md:mt-8 text-center text-xs text-gray-500">
                <p>DisgrasEye Dashboard ‚Ä¢ Real-time updates enabled ‚Ä¢ Auto-refresh every 30 seconds</p>
                <p class="mt-1">Last full sync: <span id="fullSyncTime">--:--:--</span></p>
            </div>
        </div>
    </div>
</div>

<script>
// Additional JavaScript for timeline and user-specific features

async function loadRecentActivity() {
    try {
        const supabaseClient = getSupabaseClient();
        const userId = {{ user.user_id }};
        const userRole = "{{ user.role }}";
        
        // Get user-specific activity
        const { data: alerts, error: alertsError } = await supabaseClient
            .from('alerts')
            .select(`
                alert_time,
                message,
                response_status,
                accident_detections: detection_id (
                    detection_time,
                    camera_id
                )
            `)
            .eq('sent_to', userId)
            .order('alert_time', { ascending: false })
            .limit(10);
        
        if (alertsError) throw alertsError;
        
        // Get system activity (admin only)
        let systemActivity = [];
        if (userRole === 'admin') {
            const { data: accidents, error: accidentsError } = await supabaseClient
                .from('accident_detections')
                .select(`
                    detection_time,
                    status,
                    camera_id
                `)
                .order('detection_time', { ascending: false })
                .limit(5);
            
            if (!accidentsError) {
                systemActivity = accidents || [];
            }
        }
        
        // Combine and sort activities
        const allActivities = [
            ...alerts.map(a => ({
                type: 'alert',
                time: a.alert_time,
                message: a.message,
                status: a.response_status,
                camera: a.accident_detections?.camera_id
            })),
            ...systemActivity.map(a => ({
                type: 'system',
                time: a.detection_time,
                message: `Accident ${a.status}`,
                status: a.status,
                camera: a.camera_id
            }))
        ].sort((a, b) => new Date(b.time) - new Date(a.time)).slice(0, 10);
        
        // Update timeline
        updateTimeline(allActivities);
        
        // Update sync time
        document.getElementById('fullSyncTime').textContent = new Date().toLocaleTimeString();
        
    } catch (error) {
        console.error('Error loading recent activity:', error);
    }
}

function updateTimeline(activities) {
    const timelineContainer = document.getElementById('timelineItems');
    const loadingElement = document.getElementById('activityLoading');
    
    if (!timelineContainer) return;
    
    if (loadingElement) {
        loadingElement.remove();
    }
    
    if (activities.length === 0) {
        timelineContainer.innerHTML = `
            <div class="text-center py-4 text-gray-500">
                <i class="bi bi-inbox text-2xl mb-2"></i>
                <p class="text-sm">No recent activity found</p>
            </div>
        `;
        return;
    }
    
    timelineContainer.innerHTML = activities.map((activity, index) => {
        const time = new Date(activity.time);
        const timeAgo = getTimeAgo(time);
        const icon = activity.type === 'alert' ? 
            (activity.status === 'Unacknowledged' ? 'bi-bell' : 
             activity.status === 'Acknowledged' ? 'bi-bell-check' : 'bi-bell-slash') :
            (activity.status === 'Verified' ? 'bi-check-circle' : 
             activity.status === 'False Alarm' ? 'bi-x-circle' : 'bi-clock');
        
        const iconColor = activity.type === 'alert' ?
            (activity.status === 'Unacknowledged' ? 'text-alert' :
             activity.status === 'Acknowledged' ? 'text-gold' : 'text-gray-400') :
            (activity.status === 'Verified' ? 'text-greenlight' :
             activity.status === 'False Alarm' ? 'text-alert' : 'text-gold');
        
        return `
            <div class="relative fade-in" style="animation-delay: ${index * 50}ms">
                <div class="absolute -left-9 md:-left-10 top-1 w-4 h-4 md:w-5 md:h-5 rounded-full border-2 ${iconColor.replace('text-', 'border-')} bg-[#1E293B] flex items-center justify-center">
                    <i class="bi ${icon} text-xs ${iconColor}"></i>
                </div>
                <div class="bg-[#112240] rounded-lg p-3 md:p-4 border border-gray-600">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <p class="font-medium text-sm md:text-base">${activity.message}</p>
                            ${activity.camera ? `
                            <p class="text-xs md:text-sm text-gray-400 mt-1">
                                <i class="bi bi-camera-video"></i> Camera ${activity.camera}
                            </p>
                            ` : ''}
                        </div>
                        <span class="text-xs text-gray-400 ml-2 whitespace-nowrap">${timeAgo}</span>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

function getTimeAgo(date) {
    const seconds = Math.floor((new Date() - date) / 1000);
    
    if (seconds < 60) return 'Just now';
    if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
    if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
    return `${Math.floor(seconds / 86400)}d ago`;
}

// Initialize timeline on page load
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        loadRecentActivity();
    }, 1000);
    
    // Update sync time initially
    document.getElementById('fullSyncTime').textContent = new Date().toLocaleTimeString();
});

// Make timeline function available globally
window.loadRecentActivity = loadRecentActivity;
</script>
{% endblock %}