{% extends 'dashboard/base.html' %}

{% block title %}Reports & Analytics | DisgrasEye{% endblock %}

{% block extra_scripts %}
<script>
let charts = {};
let reportData = {};
let currentDateFilter = 'today'; // today, week, month, custom
let currentView = 'incidents'; // incidents, reports, analytics

// Function to get Supabase client from global scope
function getSupabaseClient() {
    if (window._supabase) {
        return window._supabase;
    }
    
    const supabaseUrl = "{{ SUPABASE_URL|default:'https://ivigoibymrcvaftgayqv.supabase.co' }}";
    const supabaseAnonKey = "{{ SUPABASE_ANON_KEY|default:'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml2aWdvaWJ5bXJjdmFmdGdheXF2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5MDI2MDgsImV4cCI6MjA3OTQ3ODYwOH0.c3MoFVyNGXwZ3zqtgWz62Du0WfA7pranyAXDwRpy5sw' }}";
    
    return supabase.createClient(supabaseUrl, supabaseAnonKey);
}

// Initialize everything when page loads
document.addEventListener('DOMContentLoaded', function() {
    initializeDateFilter();
    initializeViewTabs();
    loadReportData();
});

// Set up view tabs
function initializeViewTabs() {
    document.querySelectorAll('.view-tab-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            currentView = this.dataset.view;
            
            // Update button active states
            document.querySelectorAll('.view-tab-btn').forEach(b => {
                b.classList.remove('bg-sky', 'text-white');
                b.classList.add('bg-gray-700', 'text-gray-300');
            });
            this.classList.remove('bg-gray-700', 'text-gray-300');
            this.classList.add('bg-sky', 'text-white');
            
            // Update view sections visibility
            document.querySelectorAll('.view-section').forEach(section => {
                section.classList.add('hidden');
            });
            document.getElementById(`${currentView}View`).classList.remove('hidden');
            
            // Reload data for new view
            loadReportData();
        });
    });
}

// Set up date filter button click handlers
function initializeDateFilter() {
    document.querySelectorAll('.date-filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            currentDateFilter = this.dataset.filter;
            
            // Update button active states
            document.querySelectorAll('.date-filter-btn').forEach(b => {
                b.classList.remove('bg-sky', 'text-white');
                b.classList.add('bg-gray-700', 'text-gray-300');
            });
            this.classList.remove('bg-gray-700', 'text-gray-300');
            this.classList.add('bg-sky', 'text-white');
            
            // Reload data with new filter
            loadReportData();
        });
    });
    
    // Handle custom date picker
    document.getElementById('customDatePicker')?.addEventListener('change', function() {
        if (this.value) {
            currentDateFilter = 'custom';
            loadReportData();
        }
    });
}

// Build date range filter based on current selection
function buildDateFilter() {
    const now = new Date();
    let startDate, endDate;
    
    switch(currentDateFilter) {
        case 'today':
            startDate = new Date(now.setHours(0, 0, 0, 0));
            endDate = new Date(now.setHours(23, 59, 59, 999));
            break;
        case 'week':
            startDate = new Date(now);
            startDate.setDate(now.getDate() - 7);
            startDate.setHours(0, 0, 0, 0);
            endDate = new Date();
            endDate.setHours(23, 59, 59, 999);
            break;
        case 'month':
            startDate = new Date(now.getFullYear(), now.getMonth(), 1);
            endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59, 999);
            break;
        case 'custom':
            const customDate = document.getElementById('customDatePicker')?.value;
            if (customDate) {
                startDate = new Date(customDate);
                startDate.setHours(0, 0, 0, 0);
                endDate = new Date(customDate);
                endDate.setHours(23, 59, 59, 999);
            } else {
                startDate = new Date(now.setHours(0, 0, 0, 0));
                endDate = new Date(now.setHours(23, 59, 59, 999));
            }
            break;
        default:
            startDate = new Date(now.setHours(0, 0, 0, 0));
            endDate = new Date(now.setHours(23, 59, 59, 999));
    }
    
    return {
        start: startDate.toISOString(),
        end: endDate.toISOString()
    };
}

// Main function to load report data
async function loadReportData() {
    try {
        const supabase = getSupabaseClient();
        if (!supabase) {
            console.error('Supabase client not available');
            showNoDataMessage();
            return;
        }

        const dateFilter = buildDateFilter();
        
        // Load data based on current view
        if (currentView === 'incidents') {
            await loadIncidentsView(supabase, dateFilter);
        } else if (currentView === 'reports') {
            await loadReportsView(supabase, dateFilter);
        } else if (currentView === 'analytics') {
            await loadAnalyticsView(supabase, dateFilter);
        } else if (currentView === 'locations') {
            await loadLocationsView(supabase, dateFilter);
        } else if (currentView === 'topTanods') {
            await loadTopTanodsView(supabase, dateFilter);
        }

    } catch (error) {
        console.error('Error loading report data:', error);
        showNoDataMessage();
    }
}

// Load Incidents View (from accident_detections)
async function loadIncidentsView(supabase, dateFilter) {
    // Load incidents with camera info
    const { data: incidents, error } = await supabase
        .from('accident_detections')
        .select(`
            accident_id,
            detection_time,
            status,
            camera_id,
            admin_confirmed_at,
            cctv:camera_id (
                location_name,
                status
            )
        `)
        .gte('detection_time', dateFilter.start)
        .lte('detection_time', dateFilter.end)
        .order('detection_time', { ascending: false });

    if (error) throw error;

    // Update stats
    document.getElementById('totalIncidents').textContent = incidents.length;
    document.getElementById('pendingIncidents').textContent = incidents.filter(i => i.status === 'Pending').length;
    document.getElementById('dispatchedIncidents').textContent = incidents.filter(i => i.status === 'Admin_Confirmed').length;
    document.getElementById('verifiedIncidents').textContent = incidents.filter(i => i.status === 'Verified').length;
    document.getElementById('falseAlarmIncidents').textContent = incidents.filter(i => i.status === 'False_Alarm').length;

    // Calculate resolution rate
    const resolvedCount = incidents.filter(i => i.status === 'Verified' || i.status === 'False_Alarm').length;
    const resolutionRate = incidents.length > 0 ? Math.round((resolvedCount / incidents.length) * 100) : 0;
    document.getElementById('resolutionRate').textContent = resolutionRate + '%';
    document.getElementById('resolutionBar').style.width = resolutionRate + '%';

    // Render incidents table
    renderIncidentsTable(incidents);

    // Create charts
    createIncidentCharts(incidents);
}

// Load Reports View (from reports table with tanod info)
async function loadReportsView(supabase, dateFilter) {
    // Load reports with tanod and incident info
    const { data: reports, error } = await supabase
        .from('reports')
        .select(`
            report_id,
            detection_id,
            remarks,
            photo_url,
            submitted_at,
            generated_by,
            users!generated_by (
                first_name,
                last_name,
                user_id
            ),
            accident_detections!detection_id (
                accident_id,
                status,
                detection_time,
                camera_id,
                cctv:camera_id (
                    location_name
                )
            )
        `)
        .gte('submitted_at', dateFilter.start)
        .lte('submitted_at', dateFilter.end)
        .order('submitted_at', { ascending: false });

    if (error) throw error;

    // Update stats
    document.getElementById('totalReports').textContent = reports.length;
    document.getElementById('verifiedReports').textContent = reports.filter(r => r.accident_detections?.status === 'Verified').length;
    document.getElementById('falseAlarmReports').textContent = reports.filter(r => r.accident_detections?.status === 'False_Alarm').length;
    document.getElementById('uniqueTanods').textContent = new Set(reports.map(r => r.generated_by)).size;

    // Render reports table
    renderReportsTable(reports);
}

// Load Analytics View (response metrics)
async function loadAnalyticsView(supabase, dateFilter) {
    // Load alerts for response time analysis
    const { data: alerts, error } = await supabase
        .from('alerts')
        .select(`
            alert_id,
            alert_time,
            response_status,
            acknowledged_at,
            resolved_at,
            detection_id,
            accident_detections!detection_id (
                accident_id,
                status,
                detection_time,
                admin_confirmed_at,
                cctv:camera_id (
                    location_name
                )
            )
        `)
        .gte('alert_time', dateFilter.start)
        .lte('alert_time', dateFilter.end);

    if (error) throw error;

    // Calculate metrics
    const avgResponseTime = calculateAverageResponseTime(alerts);
    const ackRate = calculateAcknowledgmentRate(alerts);
    const resolutionRate = calculateResolutionRate(alerts);
    const falseAlarmRate = calculateFalseAlarmRate(alerts);

    document.getElementById('avgResponseTime').textContent = avgResponseTime;
    document.getElementById('ackRate').textContent = ackRate + '%';
    document.getElementById('ackBar').style.width = ackRate + '%';
    document.getElementById('ackRateDetail').textContent = ackRate + '%';
    
    document.getElementById('resolutionRate').textContent = resolutionRate + '%';
    document.getElementById('resBar').style.width = resolutionRate + '%';
    document.getElementById('resRateDetail').textContent = resolutionRate + '%';
    
    document.getElementById('falseRate').textContent = falseAlarmRate + '%';
    document.getElementById('falseBar').style.width = falseAlarmRate + '%';
    document.getElementById('falseRateDetail').textContent = falseAlarmRate + '%';
    
    document.getElementById('totalAlerts').textContent = alerts.length;

    createAnalyticsCharts(alerts);
}

// Load Locations View (frequent crash locations)
async function loadLocationsView(supabase, dateFilter) {
    // Load incidents with location data
    const { data: incidents, error } = await supabase
        .from('accident_detections')
        .select(`
            accident_id,
            status,
            camera_id,
            cctv:camera_id (
                location_name
            )
        `)
        .gte('detection_time', dateFilter.start)
        .lte('detection_time', dateFilter.end);

    if (error) throw error;

    // Group by location
    const locationStats = {};
    
    incidents.forEach(incident => {
        const location = incident.cctv?.location_name || `Camera ${incident.camera_id}`;
        
        if (!locationStats[location]) {
            locationStats[location] = {
                total: 0,
                verified: 0,
                falseAlarm: 0,
                pending: 0,
                dispatched: 0
            };
        }
        
        locationStats[location].total++;
        
        switch(incident.status) {
            case 'Verified':
                locationStats[location].verified++;
                break;
            case 'False_Alarm':
                locationStats[location].falseAlarm++;
                break;
            case 'Pending':
                locationStats[location].pending++;
                break;
            case 'Admin_Confirmed':
                locationStats[location].dispatched++;
                break;
        }
    });

    // Convert to array and sort by total
    const locationsArray = Object.entries(locationStats)
        .map(([location, stats]) => ({ location, ...stats }))
        .sort((a, b) => b.total - a.total);

    // Update total locations
    document.getElementById('totalLocations').textContent = locationsArray.length;

    // Render locations table
    renderLocationsTable(locationsArray);

    // Create location charts
    createLocationCharts(locationsArray);
}

// Load Top Tanods View
async function loadTopTanodsView(supabase, dateFilter) {
    // Load reports with tanod info
    const { data: reports, error } = await supabase
        .from('reports')
        .select(`
            report_id,
            generated_by,
            users!generated_by (
                first_name,
                last_name,
                user_id
            ),
            accident_detections!detection_id (
                status
            )
        `)
        .gte('submitted_at', dateFilter.start)
        .lte('submitted_at', dateFilter.end);

    if (error) throw error;

    // Group by tanod
    const tanodStats = {};
    
    reports.forEach(report => {
        const tanodId = report.generated_by;
        const tanod = report.users;
        const tanodName = tanod ? `${tanod.first_name} ${tanod.last_name}` : 'Unknown Tanod';
        
        if (!tanodStats[tanodId]) {
            tanodStats[tanodId] = {
                name: tanodName,
                totalReports: 0,
                verified: 0,
                falseAlarm: 0,
                firstResponse: null
            };
        }
        
        tanodStats[tanodId].totalReports++;
        
        if (report.accident_detections?.status === 'Verified') {
            tanodStats[tanodId].verified++;
        } else if (report.accident_detections?.status === 'False_Alarm') {
            tanodStats[tanodId].falseAlarm++;
        }
    });

    // Get first response times (from alerts)
    const { data: alerts } = await supabase
        .from('alerts')
        .select(`
            acknowledged_at,
            alert_time,
            sent_to
        `)
        .gte('alert_time', dateFilter.start)
        .lte('alert_time', dateFilter.end)
        .not('acknowledged_at', 'is', null);

    // Calculate average response time per tanod
    const responseTimes = {};
    alerts.forEach(alert => {
        const tanodId = alert.sent_to;
        if (!responseTimes[tanodId]) {
            responseTimes[tanodId] = [];
        }
        const responseTime = (new Date(alert.acknowledged_at) - new Date(alert.alert_time)) / 60000; // minutes
        responseTimes[tanodId].push(responseTime);
    });

    // Calculate averages
    Object.keys(tanodStats).forEach(tanodId => {
        if (responseTimes[tanodId] && responseTimes[tanodId].length > 0) {
            const avg = responseTimes[tanodId].reduce((a, b) => a + b, 0) / responseTimes[tanodId].length;
            tanodStats[tanodId].avgResponseTime = Math.round(avg * 10) / 10 + ' min';
        } else {
            tanodStats[tanodId].avgResponseTime = 'N/A';
        }
    });

    // Convert to array and sort by verified count
    const tanodsArray = Object.values(tanodStats).sort((a, b) => b.verified - a.verified);

    // Update total active tanods
    document.getElementById('activeTanods').textContent = tanodsArray.length;

    // Render tanods table
    renderTanodsTable(tanodsArray);
}

// Render incidents table
function renderIncidentsTable(incidents) {
    const tbody = document.getElementById('incidentsTableBody');
    if (!incidents || incidents.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center py-8 text-gray-500">
                    <i class="fas fa-car-crash text-3xl mb-2"></i>
                    <p>No incidents found for selected period</p>
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = incidents.map(incident => {
        const location = incident.cctv?.location_name || `Camera ${incident.camera_id}`;
        const detectionTime = new Date(incident.detection_time).toLocaleString();
        
        let statusBadge = '';
        let statusColor = '';
        
        switch(incident.status) {
            case 'Pending':
                statusBadge = 'PENDING';
                statusColor = 'bg-gold/10 text-gold';
                break;
            case 'Admin_Confirmed':
                statusBadge = 'DISPATCHED';
                statusColor = 'bg-sky/10 text-sky';
                break;
            case 'Verified':
                statusBadge = 'RESOLVED';
                statusColor = 'bg-greenlight/10 text-greenlight';
                break;
            case 'False_Alarm':
                statusBadge = 'FALSE ALARM';
                statusColor = 'bg-alert/10 text-alert';
                break;
            default:
                statusBadge = incident.status;
                statusColor = 'bg-gray-500/10 text-gray-400';
        }

        return `
            <tr class="border-b border-gray-700 hover:bg-white/5">
                <td class="px-4 py-3">#${incident.accident_id}</td>
                <td class="px-4 py-3">${location}</td>
                <td class="px-4 py-3">${detectionTime}</td>
                <td class="px-4 py-3">
                    <span class="px-2 py-1 rounded text-xs ${statusColor}">${statusBadge}</span>
                </td>
                <td class="px-4 py-3">${incident.admin_confirmed_at ? new Date(incident.admin_confirmed_at).toLocaleString() : '—'}</td>
                <td class="px-4 py-3">
                    <button onclick="viewIncident(${incident.accident_id})" 
                            class="text-sky hover:text-sky/80 text-sm">
                        View
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

// Render reports table
function renderReportsTable(reports) {
    const tbody = document.getElementById('reportsTableBody');
    if (!reports || reports.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center py-8 text-gray-500">
                    <i class="fas fa-file-alt text-3xl mb-2"></i>
                    <p>No reports found for selected period</p>
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = reports.map(report => {
        const tanod = report.users;
        const incident = report.accident_detections;
        const location = incident?.cctv?.location_name || 'Unknown';
        const submittedTime = new Date(report.submitted_at).toLocaleString();
        const tanodName = tanod ? `${tanod.first_name} ${tanod.last_name}` : 'Unknown Tanod';
        
        let statusBadge = '';
        let statusColor = '';
        
        if (incident?.status === 'Verified') {
            statusBadge = 'VERIFIED';
            statusColor = 'bg-greenlight/10 text-greenlight';
        } else if (incident?.status === 'False_Alarm') {
            statusBadge = 'FALSE ALARM';
            statusColor = 'bg-alert/10 text-alert';
        } else {
            statusBadge = incident?.status || 'Unknown';
            statusColor = 'bg-gray-500/10 text-gray-400';
        }

        return `
            <tr class="border-b border-gray-700 hover:bg-white/5">
                <td class="px-4 py-3">#${report.report_id}</td>
                <td class="px-4 py-3">${tanodName}</td>
                <td class="px-4 py-3">${location}</td>
                <td class="px-4 py-3">${submittedTime}</td>
                <td class="px-4 py-3">
                    <span class="px-2 py-1 rounded text-xs ${statusColor}">${statusBadge}</span>
                </td>
                <td class="px-4 py-3">
                    ${report.photo_url ? 
                        '<span class="text-greenlight"><i class="fas fa-camera"></i> Yes</span>' : 
                        '<span class="text-gray-500">No</span>'}
                </td>
                <td class="px-4 py-3">
                    <button onclick="viewFullReport(${report.report_id})" 
                            class="text-sky hover:text-sky/80 text-sm mr-2">
                        View
                    </button>
                    <button onclick="viewIncident(${incident?.accident_id})" 
                            class="text-gold hover:text-gold/80 text-sm">
                        Incident
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

// Render locations table
function renderLocationsTable(locations) {
    const tbody = document.getElementById('locationsTableBody');
    if (!locations || locations.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" class="text-center py-8 text-gray-500">
                    <i class="fas fa-map-marker-alt text-3xl mb-2"></i>
                    <p>No location data found</p>
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = locations.map((loc, index) => {
        const successRate = loc.total > 0 ? Math.round((loc.verified / loc.total) * 100) : 0;
        
        return `
            <tr class="border-b border-gray-700 hover:bg-white/5">
                <td class="px-4 py-3 font-medium">#${index + 1}</td>
                <td class="px-4 py-3">${loc.location}</td>
                <td class="px-4 py-3 font-bold text-sky">${loc.total}</td>
                <td class="px-4 py-3 text-greenlight">${loc.verified}</td>
                <td class="px-4 py-3 text-alert">${loc.falseAlarm}</td>
                <td class="px-4 py-3">
                    <div class="flex items-center gap-2">
                        <span class="text-sm ${successRate > 70 ? 'text-greenlight' : successRate > 40 ? 'text-gold' : 'text-alert'}">
                            ${successRate}%
                        </span>
                        <div class="w-16 bg-gray-700 rounded-full h-1.5">
                            <div class="bg-sky h-1.5 rounded-full" style="width: ${successRate}%"></div>
                        </div>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

// Render top tanods table
function renderTanodsTable(tanods) {
    const tbody = document.getElementById('tanodsTableBody');
    if (!tanods || tanods.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" class="text-center py-8 text-gray-500">
                    <i class="fas fa-users text-3xl mb-2"></i>
                    <p>No tanod activity found</p>
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = tanods.map((tanod, index) => {
        const accuracyRate = tanod.totalReports > 0 ? Math.round((tanod.verified / tanod.totalReports) * 100) : 0;
        
        return `
            <tr class="border-b border-gray-700 hover:bg-white/5">
                <td class="px-4 py-3 font-medium">#${index + 1}</td>
                <td class="px-4 py-3">${tanod.name}</td>
                <td class="px-4 py-3 font-bold text-greenlight">${tanod.verified}</td>
                <td class="px-4 py-3 text-alert">${tanod.falseAlarm}</td>
                <td class="px-4 py-3">${tanod.totalReports}</td>
                <td class="px-4 py-3">
                    <div class="flex items-center gap-2">
                        <span class="text-sm ${accuracyRate > 80 ? 'text-greenlight' : accuracyRate > 60 ? 'text-gold' : 'text-alert'}">
                            ${accuracyRate}%
                        </span>
                        <div class="w-16 bg-gray-700 rounded-full h-1.5">
                            <div class="bg-greenlight h-1.5 rounded-full" style="width: ${accuracyRate}%"></div>
                        </div>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

// Create incident charts
function createIncidentCharts(incidents) {
    // Status distribution
    const statusCounts = {
        'Pending': incidents.filter(i => i.status === 'Pending').length,
        'Dispatched': incidents.filter(i => i.status === 'Admin_Confirmed').length,
        'Verified': incidents.filter(i => i.status === 'Verified').length,
        'False Alarm': incidents.filter(i => i.status === 'False_Alarm').length
    };

    const statusCtx = document.getElementById('incidentStatusChart');
    if (statusCtx) {
        if (charts.incidentStatusChart) charts.incidentStatusChart.destroy();
        charts.incidentStatusChart = new Chart(statusCtx, {
            type: 'doughnut',
            data: {
                labels: Object.keys(statusCounts),
                datasets: [{
                    data: Object.values(statusCounts),
                    backgroundColor: ['#FCD34D', '#38BDF8', '#22C55E', '#EF4444']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'right', labels: { color: '#CBD5E1' } }
                }
            }
        });
    }
}

// Create location charts
function createLocationCharts(locations) {
    const top5 = locations.slice(0, 5);
    
    const locationCtx = document.getElementById('topLocationsChart');
    if (locationCtx) {
        if (charts.topLocationsChart) charts.topLocationsChart.destroy();
        charts.topLocationsChart = new Chart(locationCtx, {
            type: 'bar',
            data: {
                labels: top5.map(l => l.location.length > 15 ? l.location.substring(0, 15) + '...' : l.location),
                datasets: [{
                    label: 'Total Incidents',
                    data: top5.map(l => l.total),
                    backgroundColor: '#38BDF8',
                    borderColor: '#0EA5E9',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: { beginAtZero: true, grid: { color: 'rgba(203, 213, 225, 0.1)' } },
                    x: { grid: { display: false } }
                }
            }
        });
    }
}

// Create analytics charts
function createAnalyticsCharts(alerts) {
    // Response time distribution
    const responseTimes = [];
    alerts.forEach(alert => {
        if (alert.acknowledged_at && alert.alert_time) {
            const time = (new Date(alert.acknowledged_at) - new Date(alert.alert_time)) / 60000; // minutes
            responseTimes.push(time);
        }
    });

    const responseCtx = document.getElementById('responseTimeChart');
    if (responseCtx) {
        if (charts.responseTimeChart) charts.responseTimeChart.destroy();
        charts.responseTimeChart = new Chart(responseCtx, {
            type: 'bar',
            data: {
                labels: ['< 1 min', '1-5 min', '5-15 min', '15-30 min', '> 30 min'],
                datasets: [{
                    label: 'Responses',
                    data: [
                        responseTimes.filter(t => t < 1).length,
                        responseTimes.filter(t => t >= 1 && t < 5).length,
                        responseTimes.filter(t => t >= 5 && t < 15).length,
                        responseTimes.filter(t => t >= 15 && t < 30).length,
                        responseTimes.filter(t => t >= 30).length
                    ],
                    backgroundColor: '#22C55E'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: { beginAtZero: true, grid: { color: 'rgba(203, 213, 225, 0.1)' } }
                }
            }
        });
    }
}

// Calculate average response time
function calculateAverageResponseTime(alerts) {
    let totalTime = 0;
    let count = 0;
    
    alerts.forEach(alert => {
        if (alert.acknowledged_at && alert.alert_time) {
            const responseTime = new Date(alert.acknowledged_at) - new Date(alert.alert_time);
            totalTime += responseTime;
            count++;
        }
    });
    
    if (count === 0) return 'N/A';
    
    const avgMs = totalTime / count;
    const avgMinutes = Math.round(avgMs / 60000);
    
    if (avgMinutes < 1) return '< 1 min';
    if (avgMinutes < 60) return `${avgMinutes} min`;
    return `${Math.round(avgMinutes / 60)} hr`;
}

// Calculate acknowledgment rate
function calculateAcknowledgmentRate(alerts) {
    const total = alerts.length;
    if (total === 0) return 0;
    
    const acknowledged = alerts.filter(a => a.response_status === 'Acknowledged' || a.acknowledged_at).length;
    return Math.round((acknowledged / total) * 100);
}

// Calculate resolution rate
function calculateResolutionRate(alerts) {
    const total = alerts.length;
    if (total === 0) return 0;
    
    const resolved = alerts.filter(a => a.response_status === 'Resolved' || a.resolved_at).length;
    return Math.round((resolved / total) * 100);
}

// Calculate false alarm rate
function calculateFalseAlarmRate(alerts) {
    const total = alerts.length;
    if (total === 0) return 0;
    
    // Count alerts related to false alarm incidents
    const falseAlarms = alerts.filter(a => a.accident_detections?.status === 'False_Alarm').length;
    return Math.round((falseAlarms / total) * 100);
}

function showNoDataMessage() {
    // Show messages in tables
    document.getElementById('incidentsTableBody').innerHTML = `
        <tr><td colspan="7" class="text-center py-8 text-gray-500">No data available</td></tr>
    `;
    document.getElementById('reportsTableBody').innerHTML = `
        <tr><td colspan="7" class="text-center py-8 text-gray-500">No data available</td></tr>
    `;
    document.getElementById('locationsTableBody').innerHTML = `
        <tr><td colspan="6" class="text-center py-8 text-gray-500">No data available</td></tr>
    `;
    document.getElementById('tanodsTableBody').innerHTML = `
        <tr><td colspan="6" class="text-center py-8 text-gray-500">No data available</td></tr>
    `;
}

// Export report as PDF/text
async function exportReport() {
    try {
        const supabase = getSupabaseClient();
        if (!supabase) {
            alert('Cannot generate report: Database connection unavailable');
            return;
        }

        const dateFilter = buildDateFilter();
        
        // Fetch all data for the report
        const { data: incidents } = await supabase
            .from('accident_detections')
            .select(`
                *,
                cctv:camera_id (location_name)
            `)
            .gte('detection_time', dateFilter.start)
            .lte('detection_time', dateFilter.end);

        const { data: reports } = await supabase
            .from('reports')
            .select(`
                *,
                users!generated_by (first_name, last_name)
            `)
            .gte('submitted_at', dateFilter.start)
            .lte('submitted_at', dateFilter.end);

        const reportContent = generateFullReport(incidents || [], reports || [], dateFilter);
        
        // Trigger download
        const blob = new Blob([reportContent], { type: 'text/plain' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `DisgrasEye_Report_${new Date().toISOString().split('T')[0]}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        alert('Report generated successfully!');

    } catch (error) {
        console.error('Error generating report:', error);
        alert(`Error generating report: ${error.message}`);
    }
}

function generateFullReport(incidents, reports, dateFilter) {
    const startDate = new Date(dateFilter.start).toLocaleDateString();
    const endDate = new Date(dateFilter.end).toLocaleDateString();
    
    // Calculate location stats
    const locationStats = {};
    incidents.forEach(i => {
        const loc = i.cctv?.location_name || `Camera ${i.camera_id}`;
        locationStats[loc] = (locationStats[loc] || 0) + 1;
    });
    
    const topLocations = Object.entries(locationStats)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5)
        .map(([loc, count]) => `  - ${loc}: ${count} incidents`)
        .join('\n');

    // Calculate tanod stats
    const tanodStats = {};
    reports.forEach(r => {
        const name = r.users ? `${r.users.first_name} ${r.users.last_name}` : 'Unknown';
        tanodStats[name] = (tanodStats[name] || 0) + 1;
    });
    
    const topTanods = Object.entries(tanodStats)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5)
        .map(([name, count]) => `  - ${name}: ${count} reports`)
        .join('\n');

    return `
========================================
        DISGRASEYE INCIDENT REPORT
========================================
Date Range: ${startDate} - ${endDate}
Generated: ${new Date().toLocaleString()}

SUMMARY STATISTICS
----------------------------------------
Total Incidents: ${incidents.length}
├─ Pending: ${incidents.filter(i => i.status === 'Pending').length}
├─ Dispatched: ${incidents.filter(i => i.status === 'Admin_Confirmed').length}
├─ Verified: ${incidents.filter(i => i.status === 'Verified').length}
└─ False Alarms: ${incidents.filter(i => i.status === 'False_Alarm').length}

Total Reports Submitted: ${reports.length}
Unique Tanods: ${new Set(reports.map(r => r.generated_by)).size}

TOP CRASH LOCATIONS
----------------------------------------
${topLocations || '  No location data'}

TOP PERFORMING TANODS
----------------------------------------
${topTanods || '  No tanod activity'}

INCIDENT LIST (First 20)
----------------------------------------
${incidents.slice(0, 20).map((i, idx) => {
    const time = new Date(i.detection_time).toLocaleString();
    const location = i.cctv?.location_name || `Camera ${i.camera_id}`;
    return `${idx+1}. #${i.accident_id} | ${time} | ${location} | ${i.status}`;
}).join('\n')}

${incidents.length > 20 ? `\n... and ${incidents.length - 20} more incidents` : ''}

========================================
        END OF REPORT
========================================
    `;
}
</script>
{% endblock %}

{% block content %}
<div class="mb-8">
    <h2 class="text-2xl font-bold flex items-center gap-2">
        <i class="fas fa-chart-bar text-sky"></i> Reports & Analytics
    </h2>
    <p class="text-gray-400 mt-2">Comprehensive incident reporting and analysis</p>
</div>

<!-- View Tabs -->
<div class="bg-[#1E293B] rounded-xl p-4 border border-gray-600 mb-6">
    <div class="flex flex-wrap gap-3">
        <button class="view-tab-btn px-6 py-2.5 rounded-lg bg-sky text-white font-medium" data-view="incidents">
            <i class="fas fa-car-crash mr-2"></i> Incidents
        </button>
        <button class="view-tab-btn px-6 py-2.5 rounded-lg bg-gray-700 text-gray-300 hover:bg-gray-600 font-medium" data-view="reports">
            <i class="fas fa-file-alt mr-2"></i> Tanod Reports
        </button>
        <button class="view-tab-btn px-6 py-2.5 rounded-lg bg-gray-700 text-gray-300 hover:bg-gray-600 font-medium" data-view="analytics">
            <i class="fas fa-chart-line mr-2"></i> Analytics
        </button>
        <button class="view-tab-btn px-6 py-2.5 rounded-lg bg-gray-700 text-gray-300 hover:bg-gray-600 font-medium" data-view="locations">
            <i class="fas fa-map-marker-alt mr-2"></i> Top Locations
        </button>
        <button class="view-tab-btn px-6 py-2.5 rounded-lg bg-gray-700 text-gray-300 hover:bg-gray-600 font-medium" data-view="topTanods">
            <i class="fas fa-crown mr-2"></i> Top Tanods
        </button>
    </div>
</div>

<!-- Date Filter Section -->
<div class="bg-[#1E293B] rounded-xl p-6 border border-gray-600 mb-8">
    <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
        <i class="fas fa-calendar-alt text-sky"></i> Date Range
    </h3>
    
    <div class="flex flex-wrap gap-3 mb-4">
        <button class="date-filter-btn px-5 py-2.5 rounded-lg bg-sky text-white font-medium" data-filter="today">
            Today
        </button>
        <button class="date-filter-btn px-5 py-2.5 rounded-lg bg-gray-700 text-gray-300 hover:bg-gray-600 font-medium" data-filter="week">
            Last 7 Days
        </button>
        <button class="date-filter-btn px-5 py-2.5 rounded-lg bg-gray-700 text-gray-300 hover:bg-gray-600 font-medium" data-filter="month">
            This Month
        </button>
        
        <div class="relative">
            <input type="date" id="customDatePicker" 
                   class="bg-darkbg border border-gray-600 rounded-lg px-5 py-2.5 text-white">
        </div>
        
        <button onclick="loadReportData()" class="px-5 py-2.5 rounded-lg bg-greenlight hover:bg-greenlight/80 text-white font-medium flex items-center gap-2">
            <i class="fas fa-sync-alt"></i> Refresh
        </button>
        
        <button onclick="exportReport()" class="px-5 py-2.5 rounded-lg bg-gold hover:bg-yellow-500 text-darkblue font-medium flex items-center gap-2">
            <i class="fas fa-download"></i> Export Report
        </button>
    </div>
</div>

<!-- INCIDENTS VIEW -->
<div id="incidentsView" class="view-section">
    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-6 gap-4 mb-8">
        <div class="bg-[#1E293B] p-6 rounded-xl border border-gray-600">
            <div class="flex justify-between items-center">
                <div>
                    <p class="text-sm text-gray-400">Total</p>
                    <p class="text-3xl font-bold text-sky" id="totalIncidents">0</p>
                </div>
                <i class="fas fa-car-crash text-3xl text-sky/50"></i>
            </div>
        </div>
        
        <div class="bg-[#1E293B] p-6 rounded-xl border border-gray-600">
            <div class="flex justify-between items-center">
                <div>
                    <p class="text-sm text-gray-400">Pending</p>
                    <p class="text-3xl font-bold text-gold" id="pendingIncidents">0</p>
                </div>
                <i class="fas fa-clock text-3xl text-gold/50"></i>
            </div>
        </div>
        
        <div class="bg-[#1E293B] p-6 rounded-xl border border-gray-600">
            <div class="flex justify-between items-center">
                <div>
                    <p class="text-sm text-gray-400">Dispatched</p>
                    <p class="text-3xl font-bold text-sky" id="dispatchedIncidents">0</p>
                </div>
                <i class="fas fa-paper-plane text-3xl text-sky/50"></i>
            </div>
        </div>
        
        <div class="bg-[#1E293B] p-6 rounded-xl border border-gray-600">
            <div class="flex justify-between items-center">
                <div>
                    <p class="text-sm text-gray-400">Verified</p>
                    <p class="text-3xl font-bold text-greenlight" id="verifiedIncidents">0</p>
                </div>
                <i class="fas fa-check-circle text-3xl text-greenlight/50"></i>
            </div>
        </div>
        
        <div class="bg-[#1E293B] p-6 rounded-xl border border-gray-600">
            <div class="flex justify-between items-center">
                <div>
                    <p class="text-sm text-gray-400">False Alarms</p>
                    <p class="text-3xl font-bold text-alert" id="falseAlarmIncidents">0</p>
                </div>
                <i class="fas fa-times-circle text-3xl text-alert/50"></i>
            </div>
        </div>
        
        <div class="bg-[#1E293B] p-6 rounded-xl border border-gray-600">
            <div class="flex justify-between items-center">
                <div>
                    <p class="text-sm text-gray-400">Resolution</p>
                    <p class="text-3xl font-bold text-greenlight" id="resolutionRate">0%</p>
                </div>
                <div class="w-full bg-gray-700 rounded-full h-2 mt-2">
                    <div class="bg-greenlight h-2 rounded-full" id="resolutionBar" style="width: 0%"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <div class="bg-[#1E293B] p-6 rounded-xl border border-gray-600">
            <h4 class="font-semibold mb-4">Incident Status Distribution</h4>
            <div class="h-64">
                <canvas id="incidentStatusChart"></canvas>
            </div>
        </div>
        
        <div class="bg-[#1E293B] p-6 rounded-xl border border-gray-600">
            <h4 class="font-semibold mb-4">Hourly Incident Distribution</h4>
            <div class="h-64">
                <canvas id="hourlyDistributionChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Incidents Table -->
    <div class="bg-[#1E293B] rounded-xl border border-gray-600 overflow-hidden">
        <div class="p-4 border-b border-gray-600">
            <h4 class="font-semibold">Incident List</h4>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-darkbg/50">
                    <tr>
                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-400">ID</th>
                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-400">Location</th>
                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-400">Detection Time</th>
                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-400">Status</th>
                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-400">Admin Response</th>
                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-400">Actions</th>
                    </tr>
                </thead>
                <tbody id="incidentsTableBody">
                    <tr><td colspan="6" class="text-center py-8 text-gray-500">Loading...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- REPORTS VIEW -->
<div id="reportsView" class="view-section hidden">
    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
        <div class="bg-[#1E293B] p-6 rounded-xl border border-gray-600">
            <div class="flex justify-between items-center">
                <div>
                    <p class="text-sm text-gray-400">Total Reports</p>
                    <p class="text-3xl font-bold text-sky" id="totalReports">0</p>
                </div>
                <i class="fas fa-file-alt text-3xl text-sky/50"></i>
            </div>
        </div>
        
        <div class="bg-[#1E293B] p-6 rounded-xl border border-gray-600">
            <div class="flex justify-between items-center">
                <div>
                    <p class="text-sm text-gray-400">Verified</p>
                    <p class="text-3xl font-bold text-greenlight" id="verifiedReports">0</p>
                </div>
                <i class="fas fa-check-circle text-3xl text-greenlight/50"></i>
            </div>
        </div>
        
        <div class="bg-[#1E293B] p-6 rounded-xl border border-gray-600">
            <div class="flex justify-between items-center">
                <div>
                    <p class="text-sm text-gray-400">False Alarms</p>
                    <p class="text-3xl font-bold text-alert" id="falseAlarmReports">0</p>
                </div>
                <i class="fas fa-times-circle text-3xl text-alert/50"></i>
            </div>
        </div>
        
        <div class="bg-[#1E293B] p-6 rounded-xl border border-gray-600">
            <div class="flex justify-between items-center">
                <div>
                    <p class="text-sm text-gray-400">Active Tanods</p>
                    <p class="text-3xl font-bold text-gold" id="uniqueTanods">0</p>
                </div>
                <i class="fas fa-users text-3xl text-gold/50"></i>
            </div>
        </div>
    </div>

    <!-- Reports Table -->
    <div class="bg-[#1E293B] rounded-xl border border-gray-600 overflow-hidden">
        <div class="p-4 border-b border-gray-600">
            <h4 class="font-semibold">Tanod Reports</h4>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-darkbg/50">
                    <tr>
                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-400">Report ID</th>
                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-400">Tanod</th>
                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-400">Location</th>
                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-400">Submitted</th>
                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-400">Status</th>
                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-400">Photo</th>
                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-400">Actions</th>
                    </tr>
                </thead>
                <tbody id="reportsTableBody">
                    <tr><td colspan="7" class="text-center py-8 text-gray-500">Loading...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- ANALYTICS VIEW -->
<div id="analyticsView" class="view-section hidden">
    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
        <div class="bg-[#1E293B] p-6 rounded-xl border border-gray-600">
            <div class="flex justify-between items-center">
                <div>
                    <p class="text-sm text-gray-400">Avg Response</p>
                    <p class="text-3xl font-bold text-sky" id="avgResponseTime">—</p>
                </div>
                <i class="fas fa-clock text-3xl text-sky/50"></i>
            </div>
        </div>
        
        <div class="bg-[#1E293B] p-6 rounded-xl border border-gray-600">
            <div class="flex justify-between items-center">
                <div>
                    <p class="text-sm text-gray-400">Acknowledgment</p>
                    <p class="text-3xl font-bold text-greenlight" id="ackRate">0%</p>
                </div>
                <i class="fas fa-check-circle text-3xl text-greenlight/50"></i>
            </div>
            <div class="w-full bg-gray-700 rounded-full h-2 mt-2">
                <div class="bg-greenlight h-2 rounded-full" id="ackBar" style="width: 0%"></div>
            </div>
        </div>
        
        <div class="bg-[#1E293B] p-6 rounded-xl border border-gray-600">
            <div class="flex justify-between items-center">
                <div>
                    <p class="text-sm text-gray-400">Resolution</p>
                    <p class="text-3xl font-bold text-gold" id="resolutionRate">0%</p>
                </div>
                <i class="fas fa-check-double text-3xl text-gold/50"></i>
            </div>
            <div class="w-full bg-gray-700 rounded-full h-2 mt-2">
                <div class="bg-gold h-2 rounded-full" id="resBar" style="width: 0%"></div>
            </div>
        </div>
        
        <div class="bg-[#1E293B] p-6 rounded-xl border border-gray-600">
            <div class="flex justify-between items-center">
                <div>
                    <p class="text-sm text-gray-400">False Alarm</p>
                    <p class="text-3xl font-bold text-alert" id="falseRate">0%</p>
                </div>
                <i class="fas fa-exclamation-triangle text-3xl text-alert/50"></i>
            </div>
            <div class="w-full bg-gray-700 rounded-full h-2 mt-2">
                <div class="bg-alert h-2 rounded-full" id="falseBar" style="width: 0%"></div>
            </div>
        </div>
    </div>

    <!-- Analytics Charts -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="bg-[#1E293B] p-6 rounded-xl border border-gray-600">
            <h4 class="font-semibold mb-4">Response Time Distribution</h4>
            <div class="h-64">
                <canvas id="responseTimeChart"></canvas>
            </div>
        </div>
        
        <div class="bg-[#1E293B] p-6 rounded-xl border border-gray-600">
            <h4 class="font-semibold mb-4">Performance Metrics</h4>
            <div class="space-y-4">
                <div>
                    <div class="flex justify-between text-sm mb-1">
                        <span>Acknowledgment Rate</span>
                        <span class="text-sky" id="ackRateDetail">0%</span>
                    </div>
                    <div class="w-full bg-gray-700 rounded-full h-2">
                        <div class="bg-sky h-2 rounded-full" id="ackBarDetail" style="width: 0%"></div>
                    </div>
                </div>
                <div>
                    <div class="flex justify-between text-sm mb-1">
                        <span>Resolution Rate</span>
                        <span class="text-greenlight" id="resRateDetail">0%</span>
                    </div>
                    <div class="w-full bg-gray-700 rounded-full h-2">
                        <div class="bg-greenlight h-2 rounded-full" id="resBarDetail" style="width: 0%"></div>
                    </div>
                </div>
                <div>
                    <div class="flex justify-between text-sm mb-1">
                        <span>False Alarm Rate</span>
                        <span class="text-alert" id="falseRateDetail">0%</span>
                    </div>
                    <div class="w-full bg-gray-700 rounded-full h-2">
                        <div class="bg-alert h-2 rounded-full" id="falseBarDetail" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- TOP LOCATIONS VIEW -->
<div id="locationsView" class="view-section hidden">
    <!-- Stats Card -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
        <div class="bg-[#1E293B] p-6 rounded-xl border border-gray-600 md:col-span-1">
            <div class="flex justify-between items-center">
                <div>
                    <p class="text-sm text-gray-400">Total Locations</p>
                    <p class="text-3xl font-bold text-sky" id="totalLocations">0</p>
                </div>
                <i class="fas fa-map-marked-alt text-3xl text-sky/50"></i>
            </div>
        </div>
        
        <div class="bg-[#1E293B] p-6 rounded-xl border border-gray-600 md:col-span-2">
            <h4 class="font-semibold mb-2">Most Active Location</h4>
            <div class="h-32 flex items-center justify-center text-gray-400" id="topLocationDisplay">
                Loading...
            </div>
        </div>
    </div>

    <!-- Locations Chart -->
    <div class="bg-[#1E293B] p-6 rounded-xl border border-gray-600 mb-8">
        <h4 class="font-semibold mb-4">Top 5 Crash Locations</h4>
        <div class="h-72">
            <canvas id="topLocationsChart"></canvas>
        </div>
    </div>

    <!-- Locations Table -->
    <div class="bg-[#1E293B] rounded-xl border border-gray-600 overflow-hidden">
        <div class="p-4 border-b border-gray-600">
            <h4 class="font-semibold">Location Performance</h4>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-darkbg/50">
                    <tr>
                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-400">Rank</th>
                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-400">Location</th>
                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-400">Total Incidents</th>
                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-400">Verified</th>
                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-400">False Alarms</th>
                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-400">Success Rate</th>
                    </tr>
                </thead>
                <tbody id="locationsTableBody">
                    <tr><td colspan="6" class="text-center py-8 text-gray-500">Loading...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- TOP TANODS VIEW -->
<div id="topTanodsView" class="view-section hidden">
    <!-- Stats Card -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
        <div class="bg-[#1E293B] p-6 rounded-xl border border-gray-600 md:col-span-1">
            <div class="flex justify-between items-center">
                <div>
                    <p class="text-sm text-gray-400">Active Tanods</p>
                    <p class="text-3xl font-bold text-sky" id="activeTanods">0</p>
                </div>
                <i class="fas fa-users text-3xl text-sky/50"></i>
            </div>
        </div>
        
        <div class="bg-[#1E293B] p-6 rounded-xl border border-gray-600 md:col-span-2">
            <h4 class="font-semibold mb-2">Top Performer</h4>
            <div class="h-32 flex items-center justify-center text-gray-400" id="topTanodDisplay">
                Loading...
            </div>
        </div>
    </div>

    <!-- Tanods Table -->
    <div class="bg-[#1E293B] rounded-xl border border-gray-600 overflow-hidden">
        <div class="p-4 border-b border-gray-600">
            <h4 class="font-semibold">Tanod Performance Rankings</h4>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-darkbg/50">
                    <tr>
                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-400">Rank</th>
                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-400">Tanod</th>
                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-400">Verified</th>
                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-400">False Alarms</th>
                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-400">Total Reports</th>
                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-400">Accuracy</th>
                    </tr>
                </thead>
                <tbody id="tanodsTableBody">
                    <tr><td colspan="6" class="text-center py-8 text-gray-500">Loading...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}