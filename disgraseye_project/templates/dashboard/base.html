<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}DisgrasEye{% endblock %}</title>

    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- Bootstrap Icons (keep for compatibility) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Supabase JS v2 -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        darkblue: '#0A192F',
                        sky: '#38BDF8',
                        gold: '#FCD34D',
                        alert: '#EF4444',
                        graylight: '#CBD5E1',
                        greenlight: '#22C55E',
                        darkbg: '#112240',
                        cardbg: '#1E293B'
                    }
                }
            }
        }
    </script>

    <style>
        .pulse-alert {
            animation: pulse 2s infinite;
            box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
        }
        @keyframes pulse {
            0% { transform: scale(0.95); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(239,68,68,0); }
            100% { transform: scale(0.95); }
        }
        .gradient-bg {
            background: linear-gradient(135deg, #0A192F 0%, #112240 50%, #1E293B 100%);
        }
        .slide-up {
            animation: slideUp 0.8s ease-out;
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .toast-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* ===== MODAL STYLES ===== */
        .modal-overlay {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            animation: fadeIn 0.2s ease-out;
        }

        .confirm-modal-overlay {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            animation: fadeIn 0.2s ease-out;
        }

        .confirm-modal {
            animation: slideUpModal 0.3s ease-out;
        }

        @keyframes slideUpModal {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .loading-spinner {
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top: 2px solid #38BDF8;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .review-pulse {
            animation: reviewPulse 2s infinite;
        }

        @keyframes reviewPulse {
            0% { box-shadow: 0 0 0 0 rgba(56, 189, 248, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(56, 189, 248, 0); }
            100% { box-shadow: 0 0 0 0 rgba(56, 189, 248, 0); }
        }

        .re-review-btn {
            animation: gentlePulse 2s infinite;
        }

        @keyframes gentlePulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
    </style>

    {% block extra_head %}{% endblock %}
</head>

<body class="bg-darkblue text-graylight font-sans">

<!-- HEADER -->
<header class="flex justify-between items-center p-4 bg-[#091527] border-b border-sky/30">
    <h1 class="text-xl font-bold text-sky flex items-center gap-2">
        <i class="fas fa-eye text-sky"></i> DisgrasEye Dashboard
    </h1>

    <div class="flex items-center gap-4 relative">
        <!-- Test Alert Button -->
        <button id="testAlertBtn"
            class="bg-yellow-500 hover:bg-yellow-600 text-black px-3 py-1.5 rounded-lg flex items-center gap-1 text-sm transition">
            <i class="fas fa-bolt text-xs"></i> Test
        </button>

        <!-- Notification Bell -->
        <div class="relative">
            <button id="notifBtn" class="relative p-1.5 hover:bg-gray-800 rounded-lg transition">
                <i class="fas fa-bell text-lg"></i>
                <span id="notifCount"
                    class="hidden absolute -top-1 -right-1 bg-alert text-white text-[10px] h-4 w-4 rounded-full flex items-center justify-center pulse-alert">
                    0
                </span>
            </button>

            <!-- Compact Dropdown -->
            <div id="notifDropdown"
                class="hidden absolute right-0 mt-2 w-72 bg-cardbg rounded-lg shadow-xl z-50 border border-gray-700 max-h-96 overflow-y-auto">
                <div class="p-2 border-b border-gray-700 font-semibold text-sky flex justify-between items-center sticky top-0 bg-cardbg">
                    <span class="text-sm"><i class="fas fa-bell mr-2"></i>Alerts</span>
                    <button id="markAllRead" class="text-xs text-sky hover:underline hidden">Mark all read</button>
                </div>

                <div id="notifLoading" class="p-4 text-center">
                    <div class="animate-spin h-5 w-5 border-2 border-sky border-t-transparent rounded-full mx-auto"></div>
                    <p class="mt-1 text-xs text-gray-400">Loading...</p>
                </div>

                <ul id="notifList" class="divide-y divide-gray-700 text-xs max-h-80 overflow-y-auto"></ul>

                <div id="notifEmpty" class="hidden p-4 text-center text-gray-400">
                    <i class="fas fa-bell-slash text-lg mb-1"></i>
                    <p class="text-xs">No alerts yet</p>
                </div>
            </div>
        </div>

        <!-- Last Update -->
        <span id="lastUpdate" class="text-xs text-gray-400">--</span>

        <!-- Logout Button -->
        <form action="{% url 'logout' %}" method="post">
            {% csrf_token %}
            <button type="submit" class="bg-alert hover:bg-red-700 text-white px-3 py-1.5 rounded-lg flex items-center gap-1 text-sm">
                <i class="fas fa-sign-out-alt text-xs"></i> Logout
            </button>
        </form>
    </div>
</header>

<div class="flex min-h-screen">
    <!-- Sidebar -->
    <aside class="w-64 bg-[#0F172A] p-4">
        <nav class="flex flex-col gap-2">
            <a href="{% url 'dashboard' %}" class="flex items-center px-3 py-2 rounded-lg hover:bg-gray-800 transition text-sm">
                <i class="fas fa-house mr-3 w-4"></i> Dashboard
            </a>
            <a href="{% url 'cctv_monitoring' %}" class="flex items-center px-3 py-2 rounded-lg hover:bg-gray-800 transition text-sm">
                <i class="fas fa-video mr-3 w-4"></i> CCTV Monitoring
            </a>
            <a href="{% url 'live_monitoring' %}" class="flex items-center px-3 py-2 rounded-lg hover:bg-gray-800 transition text-sm">
                <i class="fas fa-broadcast-tower mr-3 w-4"></i> Live Detection
            </a>
            <a href="{% url 'reports' %}" class="flex items-center px-3 py-2 rounded-lg hover:bg-gray-800 transition text-sm">
                <i class="fas fa-chart-line mr-3 w-4"></i> Reports
            </a>
            <a href="{% url 'settings' %}" class="flex items-center px-3 py-2 rounded-lg hover:bg-gray-800 transition text-sm">
                <i class="fas fa-gear mr-3 w-4"></i> Settings
            </a>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 p-6 bg-darkbg">
        {% block content %}{% endblock %}
    </main>
</div>

<!-- Toast notification container -->
<div id="toastContainer" class="fixed top-20 right-4 z-50 space-y-2"></div>

<!-- ================= SCRIPT ================= -->
<script>
// Console log to verify script is running
console.log("BASE TEMPLATE: Script starting");

// Get user ID from multiple sources - UNIVERSAL FIX
let USER_ID = null;

// First try: session data directly (most reliable)
{% if request.session.supabase_user %}
    USER_ID = "{{ request.session.supabase_user.id }}";
    console.log("ðŸ”µ Using session user ID:", USER_ID);
{% else %}
    // Second try: your custom user object
    USER_ID = {{ user.user_id|default:'null' }};
    console.log("ðŸ”µ Using template user ID:", USER_ID);
{% endif %}

const SUPABASE_URL = "{{ SUPABASE_URL|default:'https://ivigoibymrcvaftgayqv.supabase.co' }}";
const SUPABASE_ANON_KEY = "{{ SUPABASE_ANON_KEY|default:'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml2aWdvaWJ5bXJjdmFmdGdheXF2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5MDI2MDgsImV4cCI6MjA3OTQ3ODYwOH0.c3MoFVyNGXwZ3zqtgWz62Du0WfA7pranyAXDwRpy5sw' }}";
const SUPABASE_SERVICE_ROLE_KEY = "{{ SUPABASE_SERVICE_ROLE_KEY|escapejs }}";

console.log("BASE TEMPLATE: User ID =", USER_ID);
console.log("BASE TEMPLATE: Supabase URL exists =", SUPABASE_URL ? "Yes" : "No");

// Supabase initialization
let supabaseClient = null;
let supabaseAdminClient = null;

function initSupabase(useServiceKey = false) {
    if (useServiceKey) {
        if (!supabaseAdminClient) {
            try {
                if (!SUPABASE_URL || !SUPABASE_SERVICE_ROLE_KEY) {
                    console.error("Supabase service credentials missing!");
                    return null;
                }
                supabaseAdminClient = supabase.createClient(SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY);
                console.log("Supabase admin initialized successfully");
            } catch (error) {
                console.error("Failed to initialize Supabase admin:", error);
                return null;
            }
        }
        return supabaseAdminClient;
    } else {
        if (!supabaseClient) {
            try {
                if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
                    console.error("Supabase anon credentials missing!");
                    return null;
                }
                supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log("Supabase anon initialized successfully");
                window._supabase = supabaseClient;
            } catch (error) {
                console.error("Failed to initialize Supabase:", error);
                return null;
            }
        }
        return supabaseClient;
    }
}

// Initialize immediately
initSupabase(false);

/* ==================== MODAL FUNCTIONS ==================== */

// Custom Confirm Modal
function showCustomConfirm(title, message, type = 'confirm') {
    return new Promise((resolve) => {
        const modalId = 'customConfirmModal';
        const existing = document.getElementById(modalId);
        if (existing) existing.remove();
        
        let bgColor, icon, buttonText;
        if (type === 'warning') {
            bgColor = 'bg-gold'; icon = 'fa-exclamation-triangle'; buttonText = 'Yes, Change Decision';
        } else if (type === 'delete') {
            bgColor = 'bg-alert'; icon = 'fa-trash-alt'; buttonText = 'Yes, Delete';
        } else if (type === 'cancel') {
            bgColor = 'bg-alert'; icon = 'fa-times-circle'; buttonText = 'Mark as False Alarm';
        } else {
            bgColor = 'bg-greenlight'; icon = 'fa-check-circle'; buttonText = 'Confirm & Dispatch Tanod';
        }
        
        document.body.insertAdjacentHTML('beforeend', `
            <div id="${modalId}" class="fixed inset-0 confirm-modal-overlay z-[9999] flex items-center justify-center p-4">
                <div class="confirm-modal bg-[#1E293B] rounded-xl max-w-md w-full border border-gray-600 shadow-2xl">
                    <div class="p-6">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="${bgColor}/20 p-3 rounded-full">
                                <i class="fas ${icon} text-2xl icon-md"></i>
                            </div>
                            <h3 class="text-xl font-bold text-white">${title}</h3>
                        </div>
                        <p class="text-gray-300 mb-6">${message}</p>
                        <div class="flex gap-3 justify-end">
                            <button id="cancelConfirmBtn" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 text-white rounded-lg transition">Cancel</button>
                            <button id="confirmActionBtn" class="px-4 py-2 ${bgColor} hover:opacity-80 text-white rounded-lg transition flex items-center gap-2">
                                <i class="fas ${icon} icon-xs"></i> ${buttonText}
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `);
        
        document.getElementById('cancelConfirmBtn').addEventListener('click', () => { 
            document.getElementById(modalId).remove(); 
            resolve(false); 
        });
        
        document.getElementById('confirmActionBtn').addEventListener('click', () => { 
            document.getElementById(modalId).remove(); 
            resolve(true); 
        });
    });
}

// Review Accident Modal
async function reviewAccident(accidentId) {
    try {
        const supabaseClient = initSupabase(false);
        if (!supabaseClient) throw new Error("Supabase client not initialized");
        
        // Show loading modal first
        document.body.insertAdjacentHTML('beforeend', `
            <div id="reviewModal" class="fixed inset-0 modal-overlay z-50 flex items-center justify-center p-4">
                <div class="bg-[#1E293B] rounded-xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
                    <div class="p-4 border-b border-gray-600 flex justify-between items-center">
                        <h3 class="text-lg font-bold">Loading Accident Details...</h3>
                        <button onclick="document.getElementById('reviewModal').remove()" class="text-gray-400 hover:text-white">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="p-8 text-center">
                        <div class="loading-spinner mx-auto"></div>
                        <p class="mt-4 text-gray-400">Fetching accident data...</p>
                    </div>
                </div>
            </div>
        `);
        
        const { data: accident, error } = await supabaseClient
            .from('accident_detections')
            .select(`
                accident_id,
                detection_time,
                status,
                frame_image,
                video_clip,
                camera_id,
                cctv:camera_id (
                    location_name,
                    status
                )
            `)
            .eq('accident_id', accidentId)
            .single();
        
        if (error) throw error;
        
        // Remove loading modal
        document.getElementById('reviewModal').remove();
        
        const detectionTime = new Date(accident.detection_time).toLocaleString();
        const locationName = accident.cctv?.location_name || 
            (accident.camera_id ? `Camera ${accident.camera_id}` : 'Unknown Location');
        
        document.body.insertAdjacentHTML('beforeend', `
            <div id="reviewModal" class="fixed inset-0 modal-overlay z-50 flex items-center justify-center p-4">
                <div class="bg-[#1E293B] rounded-xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
                    <div class="p-4 md:p-6 border-b border-gray-600 flex justify-between items-center">
                        <div>
                            <h3 class="text-lg md:text-xl font-bold">Review Accident #${accident.accident_id}</h3>
                            <p class="text-sm text-gray-400">
                                <i class="fas fa-map-marker-alt mr-1"></i> ${locationName} &bull;
                                <i class="fas fa-clock mr-1"></i> ${detectionTime}
                            </p>
                        </div>
                        <button onclick="document.getElementById('reviewModal').remove()" 
                                class="text-gray-400 hover:text-white text-xl">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div class="p-4 md:p-6 overflow-y-auto" style="max-height: calc(90vh - 120px);">
                        <!-- Status Banner -->
                        <div class="mb-6 p-4 ${accident.status === 'Pending' ? 'bg-gold/20 border border-gold/30' : 'bg-gray-700/20 border border-gray-600'} rounded-lg">
                            <div class="flex items-center gap-3">
                                <i class="fas ${accident.status === 'Pending' ? 'fa-clock text-gold' : 'fa-check-circle text-greenlight'} text-xl"></i>
                                <div>
                                    <p class="font-medium">Current Status: <span class="${accident.status === 'Pending' ? 'text-gold' : 'text-greenlight'}">${accident.status === 'Pending' ? 'Pending Review' : accident.status}</span></p>
                                    <p class="text-xs text-gray-400 mt-1">
                                        ${accident.status === 'Pending' ? 'Review the footage and decide: Is this a real accident or false alarm?' : 'This accident has already been reviewed.'}
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Media Grid -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
                            <div>
                                <h4 class="font-semibold mb-2 flex items-center gap-2">
                                    <i class="fas fa-image text-gold"></i> Detection Frame
                                </h4>
                                ${accident.frame_image ? `
                                    <img src="${accident.frame_image}" alt="Accident frame"
                                         class="w-full rounded-lg border border-gray-600 cursor-pointer hover:opacity-90 transition"
                                         style="max-height: 200px; object-fit: cover;"
                                         onclick="window.open('${accident.frame_image}', '_blank')"
                                         title="Click to enlarge">
                                    <p class="text-xs text-gray-400 mt-1"><i class="fas fa-search-plus"></i> Click image to enlarge</p>
                                ` : `
                                    <div class="bg-[#112240] rounded-lg p-6 text-center text-gray-500 border border-gray-600">
                                        <i class="fas fa-image text-3xl mb-2 text-gray-600"></i>
                                        <p class="text-sm">No frame image available</p>
                                        <p class="text-xs text-gray-600 mt-1">Image will appear once CCTV is integrated</p>
                                    </div>
                                `}
                            </div>
                            <div>
                                <h4 class="font-semibold mb-2 flex items-center gap-2">
                                    <i class="fas fa-video text-sky"></i> Video Evidence
                                </h4>
                                ${accident.video_clip ? `
                                    <video src="${accident.video_clip}" controls
                                           class="w-full rounded-lg border border-gray-600 bg-black"
                                           style="max-height: 200px;">
                                        Your browser does not support the video tag.
                                    </video>
                                    <p class="text-xs text-gray-400 mt-1"><i class="fas fa-info-circle"></i> Video clip from time of detection</p>
                                ` : `
                                    <div class="bg-[#112240] rounded-lg p-6 text-center text-gray-500 border border-gray-600">
                                        <i class="fas fa-video-slash text-3xl mb-2 text-gray-600"></i>
                                        <p class="text-sm">No video available</p>
                                        <p class="text-xs text-gray-600 mt-1">Video will appear once CCTV is integrated</p>
                                    </div>
                                `}
                            </div>
                        </div>

                        <!-- Detection Details -->
                        <div class="mb-6 p-4 bg-[#112240] rounded-lg border border-gray-600">
                            <h4 class="font-semibold mb-3 flex items-center gap-2">
                                <i class="fas fa-info-circle text-sky"></i> Detection Details
                            </h4>
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                                <div>
                                    <p class="text-xs text-gray-400">Camera ID</p>
                                    <p class="font-medium">${accident.camera_id || 'Not assigned'}</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-400">Location</p>
                                    <p class="font-medium">${locationName}</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-400">Camera Status</p>
                                    <p class="font-medium ${accident.cctv?.status === 'Active' ? 'text-greenlight' : 'text-alert'}">
                                        ${accident.cctv?.status || 'Unknown'}
                                    </p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-400">Detection Time</p>
                                    <p class="font-medium text-xs">${detectionTime}</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-400">Accident ID</p>
                                    <p class="font-medium text-xs">#${accident.accident_id}</p>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="flex flex-col sm:flex-row gap-3 justify-end">
                            <button onclick="verifyAccident(${accident.accident_id}, false, true)"
                                    class="bg-gray-600 hover:bg-gray-500 text-white px-6 py-2 rounded-lg transition flex items-center justify-center gap-2">
                                <i class="fas fa-times-circle"></i> False Alarm (Cancel)
                            </button>
                            <button onclick="verifyAccident(${accident.accident_id}, true, true)"
                                    class="bg-greenlight hover:bg-greenlight/80 text-white px-6 py-2 rounded-lg transition flex items-center justify-center gap-2">
                                <i class="fas fa-check-circle"></i> Confirm &amp; Dispatch Tanod
                            </button>
                        </div>

                        <p class="text-xs text-gray-500 text-center mt-4">
                            <i class="fas fa-shield-alt"></i>
                            <strong>Confirm:</strong> Tanod dispatched, they will verify on-site &nbsp;&bull;&nbsp;
                            <strong>False Alarm:</strong> Incident cancelled immediately
                        </p>
                    </div>
                </div>
            </div>
        `);
        
    } catch (error) {
        console.error('Error in reviewAccident:', error);
        const modal = document.getElementById('reviewModal');
        if (modal) modal.remove();
        showToast('Failed to load accident details: ' + error.message, 'error');
    }
}

// Re-review Accident Modal
async function reReviewAccident(accidentId, currentStatus) {
    try {
        const confirmed = await showCustomConfirm(
            'Re-review Accident',
            `This accident is currently marked as "${currentStatus === 'Admin_Confirmed' ? 'Dispatched' : 'False Alarm'}". Do you want to change this decision?`,
            'warning'
        );
        if (!confirmed) return;
        
        // Show loading modal
        document.body.insertAdjacentHTML('beforeend', `
            <div id="reviewModal" class="fixed inset-0 modal-overlay z-50 flex items-center justify-center p-4">
                <div class="bg-[#1E293B] rounded-xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
                    <div class="p-4 border-b border-gray-600 flex justify-between items-center">
                        <h3 class="text-lg font-bold">Re-review Accident #${accidentId}</h3>
                        <button onclick="document.getElementById('reviewModal').remove()" class="text-gray-400 hover:text-white">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="p-8 text-center">
                        <div class="loading-spinner mx-auto"></div>
                        <p class="mt-4 text-gray-400">Loading accident details for re-review...</p>
                    </div>
                </div>
            </div>
        `);
        
        const supabaseClient = initSupabase(false);
        const { data: accident, error } = await supabaseClient
            .from('accident_detections')
            .select(`
                accident_id,
                detection_time,
                status,
                frame_image,
                video_clip,
                camera_id,
                cctv:camera_id (
                    location_name,
                    status
                )
            `)
            .eq('accident_id', accidentId)
            .single();
        
        if (error) throw error;
        
        document.getElementById('reviewModal').remove();
        
        const detectionTime = new Date(accident.detection_time).toLocaleString();
        const locationName = accident.cctv?.location_name ||
            (accident.camera_id ? `Camera ${accident.camera_id}` : 'Unknown Location');
        
        document.body.insertAdjacentHTML('beforeend', `
            <div id="reviewModal" class="fixed inset-0 modal-overlay z-50 flex items-center justify-center p-4">
                <div class="bg-[#1E293B] rounded-xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
                    <div class="p-4 md:p-6 border-b border-gray-600 flex justify-between items-center">
                        <div>
                            <h3 class="text-lg md:text-xl font-bold">Re-review Accident #${accident.accident_id}</h3>
                            <p class="text-sm text-gray-400">
                                <i class="fas fa-map-marker-alt mr-1"></i> ${locationName} &bull;
                                <i class="fas fa-clock mr-1"></i> ${detectionTime}
                            </p>
                            <p class="text-xs text-gold mt-1">
                                <i class="fas fa-exclamation-triangle"></i>
                                Current Status: ${accident.status === 'Admin_Confirmed' ? 'Dispatched' : 'False Alarm'}
                            </p>
                        </div>
                        <button onclick="document.getElementById('reviewModal').remove()"
                                class="text-gray-400 hover:text-white text-xl">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div class="p-4 md:p-6 overflow-y-auto" style="max-height: calc(90vh - 120px);">
                        <!-- Warning Banner -->
                        <div class="mb-6 p-4 bg-gold/20 border border-gold/30 rounded-lg">
                            <div class="flex items-center gap-3">
                                <i class="fas fa-undo-alt text-gold text-xl"></i>
                                <div>
                                    <p class="font-medium">You are about to change your decision</p>
                                    <p class="text-xs text-gray-400 mt-1">
                                        This will send new notifications to tanods based on your updated decision.
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Media Grid -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
                            <div>
                                <h4 class="font-semibold mb-2 flex items-center gap-2">
                                    <i class="fas fa-image text-gold"></i> Detection Frame
                                </h4>
                                ${accident.frame_image ? `
                                    <img src="${accident.frame_image}" alt="Accident frame"
                                         class="w-full rounded-lg border border-gray-600 cursor-pointer hover:opacity-90 transition"
                                         style="max-height: 200px; object-fit: cover;"
                                         onclick="window.open('${accident.frame_image}', '_blank')"
                                         title="Click to enlarge">
                                ` : `
                                    <div class="bg-[#112240] rounded-lg p-6 text-center text-gray-500 border border-gray-600">
                                        <i class="fas fa-image text-3xl mb-2 text-gray-600"></i>
                                        <p class="text-sm">No frame image available</p>
                                    </div>
                                `}
                            </div>
                            <div>
                                <h4 class="font-semibold mb-2 flex items-center gap-2">
                                    <i class="fas fa-video text-sky"></i> Video Evidence
                                </h4>
                                ${accident.video_clip ? `
                                    <video src="${accident.video_clip}" controls
                                           class="w-full rounded-lg border border-gray-600 bg-black"
                                           style="max-height: 200px;">
                                        Your browser does not support the video tag.
                                    </video>
                                ` : `
                                    <div class="bg-[#112240] rounded-lg p-6 text-center text-gray-500 border border-gray-600">
                                        <i class="fas fa-video-slash text-3xl mb-2 text-gray-600"></i>
                                        <p class="text-sm">No video available</p>
                                    </div>
                                `}
                            </div>
                        </div>

                        <!-- Detection Details -->
                        <div class="mb-6 p-4 bg-[#112240] rounded-lg border border-gray-600">
                            <h4 class="font-semibold mb-3 flex items-center gap-2">
                                <i class="fas fa-info-circle text-sky"></i> Detection Details
                            </h4>
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                                <div>
                                    <p class="text-xs text-gray-400">Camera ID</p>
                                    <p class="font-medium">${accident.camera_id || 'Not assigned'}</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-400">Location</p>
                                    <p class="font-medium">${locationName}</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-400">Camera Status</p>
                                    <p class="font-medium ${accident.cctv?.status === 'Active' ? 'text-greenlight' : 'text-alert'}">
                                        ${accident.cctv?.status || 'Unknown'}
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="flex flex-col sm:flex-row gap-3 justify-end">
                            <button onclick="document.getElementById('reviewModal').remove()"
                                    class="bg-gray-600 hover:bg-gray-500 text-white px-6 py-2 rounded-lg transition">
                                Cancel
                            </button>
                            <button onclick="updateDecision(${accident.accident_id}, ${accident.status === 'Admin_Confirmed' ? 'false' : 'true'}, true)"
                                    class="bg-gold hover:bg-yellow-500 text-darkblue px-6 py-2 rounded-lg transition flex items-center justify-center gap-2">
                                <i class="fas fa-undo-alt"></i>
                                Change to ${accident.status === 'Admin_Confirmed' ? 'False Alarm' : 'Dispatch Tanod'}
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `);
        
    } catch (error) {
        console.error('Error in reReviewAccident:', error);
        const modal = document.getElementById('reviewModal');
        if (modal) modal.remove();
        showToast('Failed to load accident details for re-review', 'error');
    }
}

// Verify Accident
async function verifyAccident(accidentId, isConfirmed, closeModal = false) {
    try {
        const confirmed = await showCustomConfirm(
            isConfirmed ? 'Confirm & Dispatch Tanod' : 'Mark as False Alarm',
            isConfirmed
                ? 'Are you sure you want to dispatch a tanod? They will respond to the location and verify on-site.'
                : 'Are you sure you want to cancel this incident? No tanod will be dispatched.',
            isConfirmed ? 'confirm' : 'cancel'
        );
        if (!confirmed) return;
        
        const adminClient = initSupabase(true);
        if (!adminClient) { showToast('Server configuration error. Please contact administrator.', 'error'); return; }
        
        showToast('Processing...', 'info');
        
        const newStatus = isConfirmed ? 'Admin_Confirmed' : 'False_Alarm';
        
        const { error: updateError } = await adminClient
            .from('accident_detections')
            .update({ status: newStatus })
            .eq('accident_id', accidentId);
        
        if (updateError) throw updateError;
        
        const { data: tanods, error: tanodError } = await adminClient
            .from('users').select('user_id').eq('role', 'tanod');
        
        if (!tanodError && tanods && tanods.length > 0) {
            const alerts = tanods.map(tanod => ({
                detection_id: accidentId,
                sent_to: tanod.user_id,
                message: isConfirmed
                    ? 'CONFIRMED ACCIDENT - Please respond to location'
                    : 'INCIDENT CANCELLED - False alarm. Stand down.',
                response_status: isConfirmed ? 'Unacknowledged' : 'Resolved',
                alert_time: new Date().toISOString()
            }));
            await adminClient.from('alerts').insert(alerts);
            showToast(isConfirmed
                ? `Tanod dispatched! ${tanods.length} tanod(s) notified.`
                : 'False alarm! Tanods notified to stand down.', 'success');
        }
        
        if (closeModal) {
            const modal = document.getElementById('reviewModal');
            if (modal) modal.remove();
        }
        
        // Reload dashboard data if function exists
        if (typeof loadDashboardData === 'function') {
            await loadDashboardData();
        }
        
    } catch (error) {
        console.error('Error in verifyAccident:', error);
        showToast('Failed to process verification: ' + (error.message || 'Unknown error'), 'error');
    }
}

// Update Decision (for re-review)
async function updateDecision(accidentId, newIsConfirmed, closeModal = false) {
    try {
        const adminClient = initSupabase(true);
        if (!adminClient) throw new Error("Supabase admin client not initialized");
        
        showToast('Updating decision...', 'info');
        
        const newStatus = newIsConfirmed ? 'Admin_Confirmed' : 'False_Alarm';
        
        const { error: updateError } = await adminClient
            .from('accident_detections')
            .update({ status: newStatus })
            .eq('accident_id', accidentId);
        if (updateError) throw updateError;
        
        const { data: tanods } = await adminClient.from('users').select('user_id').eq('role', 'tanod');
        
        if (tanods && tanods.length > 0) {
            // Cancel old alerts
            const cancelAlerts = tanods.map(tanod => ({
                detection_id: accidentId,
                sent_to: tanod.user_id,
                message: 'PREVIOUS DECISION CANCELLED - New assessment in progress',
                response_status: 'Unacknowledged',
                alert_time: new Date().toISOString()
            }));
            await adminClient.from('alerts').insert(cancelAlerts);
            
            // Send new decision alerts
            const newAlerts = tanods.map(tanod => ({
                detection_id: accidentId,
                sent_to: tanod.user_id,
                message: newIsConfirmed
                    ? 'CONFIRMED ACCIDENT - Please respond to location'
                    : 'INCIDENT CANCELLED - False alarm. Stand down.',
                response_status: 'Unacknowledged',
                alert_time: new Date().toISOString()
            }));
            await adminClient.from('alerts').insert(newAlerts);
            showToast('Decision updated! Tanods notified of change.', 'success');
        }
        
        if (closeModal) {
            const modal = document.getElementById('reviewModal');
            if (modal) modal.remove();
        }
        
        // Reload dashboard data if function exists
        if (typeof loadDashboardData === 'function') {
            await loadDashboardData();
        }
        
    } catch (error) {
        console.error('Error in updateDecision:', error);
        showToast('Failed to update decision', 'error');
    }
}

// Acknowledge Alert
async function acknowledgeAlert(alertId) {
    try {
        const adminClient = initSupabase(true);
        if (!adminClient) throw new Error("Supabase admin client not initialized");
        
        const { error } = await adminClient
            .from('alerts')
            .update({ response_status: 'Acknowledged' })
            .eq('alert_id', alertId)
            .eq('sent_to', {{ user.user_id }});
        
        if (error) throw error;
        showToast('Alert acknowledged successfully');
        
        // Reload notifications and dashboard
        if (typeof loadNotifications === 'function') {
            await loadNotifications();
        }
        if (typeof loadDashboardData === 'function') {
            await loadDashboardData();
        }
    } catch (error) {
        console.error('Error in acknowledgeAlert:', error);
        showToast('Failed to acknowledge alert', 'error');
    }
}

// Delete Alert
async function deleteAlert(alertId) {
    try {
        const confirmed = await showCustomConfirm('Delete Alert', 'Are you sure you want to delete this alert? This action cannot be undone.', 'delete');
        if (!confirmed) return;
        
        const adminClient = initSupabase(true);
        await adminClient.from('alerts').delete().eq('alert_id', alertId);
        showToast('Alert deleted successfully', 'success');
        
        // Reload notifications and dashboard
        if (typeof loadNotifications === 'function') {
            await loadNotifications();
        }
        if (typeof loadDashboardData === 'function') {
            await loadDashboardData();
        }
    } catch (error) {
        console.error('Error deleting alert:', error);
        showToast('Failed to delete alert', 'error');
    }
}

/* ELEMENTS */
const notifBtn = document.getElementById("notifBtn");
const notifDropdown = document.getElementById("notifDropdown");
const notifList = document.getElementById("notifList");
const notifCount = document.getElementById("notifCount");
const notifLoading = document.getElementById("notifLoading");
const notifEmpty = document.getElementById("notifEmpty");
const markAllReadBtn = document.getElementById("markAllRead");
const testAlertBtn = document.getElementById("testAlertBtn");
const toastContainer = document.getElementById("toastContainer");

/* HELPER FUNCTIONS */
function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    const bgColor = type === 'success' ? 'bg-greenlight/20 text-greenlight' : 'bg-alert/20 text-alert';
    const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
    
    toast.className = `${bgColor} px-3 py-1.5 rounded-lg flex items-center gap-2 shadow-lg text-sm`;
    toast.innerHTML = `<i class="fas ${icon} text-xs"></i> ${message}`;
    
    toastContainer.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 3000);
}

function timeAgo(timestamp) {
    const date = new Date(timestamp);
    const now = new Date();
    const seconds = Math.floor((now - date) / 1000);
    
    if (seconds < 60) return "now";
    if (seconds < 3600) return `${Math.floor(seconds / 60)}m`;
    if (seconds < 86400) return `${Math.floor(seconds / 3600)}h`;
    return `${Math.floor(seconds / 86400)}d`;
}

function updateLastUpdate() {
    document.getElementById("lastUpdate").textContent =
        new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
}

/* DROPDOWN */
if (notifBtn) {
    notifBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        notifDropdown.classList.toggle("hidden");
        if (!notifDropdown.classList.contains('hidden')) {
            loadNotifications();
        }
    });
}

document.addEventListener("click", (e) => {
    if (notifDropdown && notifBtn && !notifDropdown.contains(e.target) && !notifBtn.contains(e.target)) {
        notifDropdown.classList.add("hidden");
    }
});

/* MARK ALL READ */
if (markAllReadBtn) {
    markAllReadBtn.addEventListener('click', async () => {
        try {
            const client = initSupabase(false);
            if (!client) throw new Error("Supabase client not initialized");
            
            if (!USER_ID || USER_ID === 'null') {
                showToast('User not logged in', 'error');
                return;
            }
            
            markAllReadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            markAllReadBtn.disabled = true;
            
            // Handle UUID vs Integer
            const isUuid = typeof USER_ID === 'string' && USER_ID.includes('-');
            let alertUserId = USER_ID;
            
            if (isUuid) {
                const { data: userData } = await client
                    .from("users")
                    .select("user_id")
                    .eq("auth_id", USER_ID)
                    .maybeSingle();
                    
                if (userData) {
                    alertUserId = userData.user_id;
                }
            }
            
            const { data: unreadAlerts, error: fetchError } = await client
                .from("alerts")
                .select("alert_id")
                .eq("sent_to", alertUserId)
                .eq("response_status", "Unacknowledged");
            
            if (fetchError) throw fetchError;
            
            if (!unreadAlerts || unreadAlerts.length === 0) {
                showToast('No unread alerts', 'info');
                return;
            }
            
            const alertIds = unreadAlerts.map(a => a.alert_id);
            
            const { error: updateError } = await client
                .from("alerts")
                .update({ response_status: "Acknowledged" })
                .in("alert_id", alertIds)
                .eq("sent_to", alertUserId);
            
            if (updateError) throw updateError;
            
            showToast(`${alertIds.length} marked read`, 'success');
            await loadNotifications();
            
        } catch (err) {
            showToast('Failed: ' + err.message, 'error');
        } finally {
            markAllReadBtn.innerHTML = 'Mark all read';
            markAllReadBtn.disabled = false;
        }
    });
}

/* LOAD NOTIFICATIONS */
async function loadNotifications() {
    // Don't try to load if no user ID
    if (!USER_ID || USER_ID === 'null') {
        console.log("No user ID available - skipping alerts");
        if (notifLoading) notifLoading.classList.add("hidden");
        if (notifEmpty) {
            notifEmpty.classList.remove("hidden");
            notifEmpty.innerHTML = '<i class="fas fa-user-slash text-lg mb-1"></i><p class="text-xs">Please log in</p>';
        }
        return;
    }
    
    if (notifLoading) notifLoading.classList.remove("hidden");
    if (notifEmpty) notifEmpty.classList.add("hidden");
    if (notifList) notifList.innerHTML = "";

    try {
        const client = initSupabase(false);
        if (!client) throw new Error("Supabase client not initialized");

        console.log("ðŸ”µ USER_ID from template:", USER_ID);
        
        // Check if USER_ID is a UUID (contains dashes) or integer
        const isUuid = typeof USER_ID === 'string' && USER_ID.includes('-');
        
        let alertUserId = USER_ID;
        
        // If it's a UUID, we need to get the integer user_id first
        if (isUuid) {
            console.log("ðŸ”µ USER_ID is UUID, fetching integer user_id...");
            
            const { data: userData, error: userError } = await client
                .from("users")
                .select("user_id")
                .eq("auth_id", USER_ID)
                .maybeSingle();

            if (userError) {
                console.error("Error fetching user_id:", userError);
                throw userError;
            }

            if (!userData) {
                console.error("No user found with auth_id:", USER_ID);
                throw new Error("User not found in database");
            }

            alertUserId = userData.user_id;
            console.log("ðŸ”µ Found integer user_id:", alertUserId);
        }

        // Now fetch alerts using the correct user_id
        const { data, error } = await client
            .from("alerts")
            .select(`
                alert_id,
                alert_time,
                message,
                response_status,
                detection_id,
                accident_detections:detection_id (
                    status,
                    accident_id
                )
            `)
            .eq("sent_to", alertUserId)
            .order("alert_time", { ascending: false })
            .limit(10);

        if (error) throw error;

        console.log("ðŸ”µ Alerts loaded:", data?.length || 0);

        let unread = 0;

        if (data && data.length > 0) {
            data.forEach(alert => {
                const isUnread = alert.response_status === "Unacknowledged";
                if (isUnread) unread++;

                const incidentStatus = alert.accident_detections?.status;
                const accidentId = alert.accident_detections?.accident_id;
                
                let icon = "fa-bell";
                let colorClass = "text-gray-400";
                let bgColor = "";
                
                switch(incidentStatus) {
                    case 'Pending':
                        icon = "fa-exclamation-triangle";
                        colorClass = "text-gold";
                        bgColor = isUnread ? 'bg-yellow-500/10' : '';
                        break;
                    case 'Admin_Confirmed':
                        icon = "fa-check-circle";
                        colorClass = "text-greenlight";
                        break;
                    case 'Verified':
                        icon = "fa-check-double";
                        colorClass = "text-greenlight";
                        break;
                    case 'False_Alarm':
                        icon = "fa-times-circle";
                        colorClass = "text-gray-500";
                        break;
                }

                const shortMessage = alert.message && alert.message.length > 35 
                    ? alert.message.substring(0, 35) + '...' 
                    : alert.message || 'No message';

                if (notifList) {
                    let actionButton = '';
                    
                    // Admin actions - REVIEW for pending, RE-REVIEW for decided
                    if (incidentStatus === 'Pending' && accidentId) {
                        actionButton = `
                            <button onclick="reviewAccident(${accidentId})" 
                                    class="text-[10px] bg-sky hover:bg-sky/80 text-white px-1.5 py-0.5 rounded flex-shrink-0">
                                Review
                            </button>
                        `;
                    } else if ((incidentStatus === 'Admin_Confirmed' || incidentStatus === 'False_Alarm') && accidentId) {
                        actionButton = `
                            <button onclick="reReviewAccident(${accidentId}, '${incidentStatus}')" 
                                    class="text-[10px] bg-gold hover:bg-yellow-500 text-darkblue px-1.5 py-0.5 rounded flex-shrink-0">
                                Re-review
                            </button>
                        `;
                    } else if (alert.response_status === 'Unacknowledged' && alert.alert_id) {
                        actionButton = `
                            <button onclick="acknowledgeAlert(${alert.alert_id})" 
                                    class="text-[10px] bg-gray-600 hover:bg-gray-700 text-white px-1.5 py-0.5 rounded flex-shrink-0">
                                Ok
                            </button>
                        `;
                    }

                    notifList.innerHTML += `
                        <li class="px-3 py-2 hover:bg-gray-800/50 ${bgColor} ${isUnread ? 'border-l-2 border-sky' : ''}">
                            <div class="flex items-start gap-2">
                                <i class="fas ${icon} ${colorClass} mt-0.5 text-xs"></i>
                                <div class="flex-1 min-w-0">
                                    <p class="text-xs ${isUnread ? 'font-semibold' : ''}">${shortMessage}</p>
                                    <div class="flex items-center gap-2 mt-0.5 text-[10px] text-gray-500">
                                        <span>${timeAgo(alert.alert_time)}</span>
                                        <span>â€¢</span>
                                        <span class="capitalize">${alert.response_status || 'Unknown'}</span>
                                    </div>
                                </div>
                                ${actionButton}
                            </div>
                        </li>
                    `;
                }
            });
        } else {
            if (notifEmpty) {
                notifEmpty.classList.remove("hidden");
                notifEmpty.innerHTML = '<i class="fas fa-bell-slash text-lg mb-1"></i><p class="text-xs">No alerts yet</p>';
            }
        }

        if (notifCount) {
            notifCount.textContent = unread;
            notifCount.classList.toggle("hidden", unread === 0);
        }
        if (markAllReadBtn) markAllReadBtn.classList.toggle("hidden", unread === 0);
        
        updateLastUpdate();
        
    } catch (err) {
        console.error("Error loading notifications:", err);
        if (notifList) {
            notifList.innerHTML = `
                <li class="p-3 text-center text-red-400 text-xs">
                    <i class="fas fa-exclamation-triangle"></i> Error loading
                </li>
            `;
        }
    } finally {
        if (notifLoading) notifLoading.classList.add("hidden");
    }
}

/* VIEW REPORT */
async function viewReport(detectionId) {
    if (detectionId) {
        window.location.href = `/reports/?detection=${detectionId}`;
    }
}

/* TEST ALERT */
if (testAlertBtn) {
    testAlertBtn.addEventListener('click', async () => {
        const originalText = testAlertBtn.innerHTML;
        
        try {
            testAlertBtn.disabled = true;
            testAlertBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            
            const client = initSupabase(false);
            if (!client) throw new Error("Supabase client not initialized");
            
            if (!USER_ID || USER_ID === 'null') {
                throw new Error("User not logged in");
            }
            
            // Handle UUID vs Integer for managed_by
            const isUuid = typeof USER_ID === 'string' && USER_ID.includes('-');
            let managedById = USER_ID;
            
            if (isUuid) {
                const { data: userData } = await client
                    .from("users")
                    .select("user_id")
                    .eq("auth_id", USER_ID)
                    .maybeSingle();
                    
                if (userData) {
                    managedById = userData.user_id;
                }
            }
            
            // Get or create camera
            let { data: cameras } = await client
                .from("cctv")
                .select("camera_id, location_name")
                .limit(1);
            
            let cameraId, locationName;
            
            if (!cameras || cameras.length === 0) {
                const { data: newCamera } = await client
                    .from("cctv")
                    .insert({
                        location_name: 'Test Camera',
                        ip_address: '192.168.1.' + Math.floor(Math.random() * 254 + 1),
                        status: 'Active',
                        managed_by: managedById
                    })
                    .select()
                    .single();
                
                cameraId = newCamera.camera_id;
                locationName = newCamera.location_name;
            } else {
                cameraId = cameras[0].camera_id;
                locationName = cameras[0].location_name;
            }
            
            // Create accident
            const { data: accident } = await client
                .from("accident_detections")
                .insert({
                    camera_id: cameraId,
                    detection_time: new Date().toISOString(),
                    status: 'Pending'
                })
                .select()
                .single();
            
            // Get admins
            const { data: admins } = await client
                .from("users")
                .select("user_id")
                .eq("role", "admin");
            
            // Create alerts
            if (admins && admins.length > 0) {
                const alerts = admins.map(admin => ({
                    detection_id: accident.accident_id,
                    sent_to: admin.user_id,
                    message: `Accident detected at ${locationName}`,
                    response_status: 'Unacknowledged'
                }));
                
                await client.from("alerts").insert(alerts);
                showToast(`Alert sent to ${admins.length} admins`, 'success');
            } else {
                await client.from("alerts").insert({
                    detection_id: accident.accident_id,
                    sent_to: managedById,
                    message: `Accident detected at ${locationName}`,
                    response_status: 'Unacknowledged'
                });
                showToast('Test alert created', 'success');
            }
            
            await loadNotifications();
            
        } catch (err) {
            showToast('Test failed: ' + err.message, 'error');
        } finally {
            testAlertBtn.disabled = false;
            testAlertBtn.innerHTML = originalText;
        }
    });
}

/* REALTIME UPDATES */
function setupRealtime() {
    if (!USER_ID || USER_ID === 'null') {
        console.log("No user ID - skipping realtime setup");
        return;
    }
    
    const client = initSupabase(false);
    if (client) {
        client
            .channel(`alerts-${USER_ID}`)
            .on("postgres_changes",
                { 
                    event: "*", 
                    schema: "public", 
                    table: "alerts"
                },
                () => {
                    loadNotifications();
                }
            )
            .subscribe();
    }
}

/* INITIALIZE */
document.addEventListener("DOMContentLoaded", () => {
    console.log("BASE TEMPLATE: DOMContentLoaded fired");
    updateLastUpdate();
    loadNotifications();
    setupRealtime();
    setInterval(loadNotifications, 30000);
    setInterval(updateLastUpdate, 60000);
});

// Global functions
window.reviewAccident = reviewAccident;
window.reReviewAccident = reReviewAccident;
window.verifyAccident = verifyAccident;
window.updateDecision = updateDecision;
window.acknowledgeAlert = acknowledgeAlert;
window.deleteAlert = deleteAlert;
window.viewReport = viewReport;
window.showToast = showToast;
window.showCustomConfirm = showCustomConfirm;
window.loadNotifications = loadNotifications;
window.USER_ID = USER_ID;
window.initSupabase = initSupabase;

console.log("BASE TEMPLATE: Script finished loading");
</script>

{% block extra_scripts %}{% endblock %}
</body>
</html>