{% extends 'dashboard/base.html' %}

{% block title %}CCTV Monitoring | DisgrasEye{% endblock %}

{% block extra_head %}
<style>
    .camera-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 20px;
    }
    .camera-feed {
        background: #000;
        border-radius: 12px;
        overflow: hidden;
        position: relative;
        border: 2px solid #334155;
        transition: all 0.3s ease;
    }
    .camera-feed:hover {
        border-color: #38BDF8;
        transform: translateY(-2px);
    }
    .camera-status {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        z-index: 10;
    }
    .ai-status {
        position: absolute;
        top: 10px;
        left: 10px;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        z-index: 10;
    }
    .ai-active {
        background: rgba(34, 197, 94, 0.8);
    }
    .ai-inactive {
        background: rgba(107, 114, 128, 0.8);
    }
    
    /* Modal Styles */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        z-index: 1000;
        backdrop-filter: blur(5px);
    }
    .modal-content {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: #1E293B;
        border: 2px solid #334155;
        border-radius: 12px;
        padding: 2rem;
        width: 90%;
        max-width: 500px;
        max-height: 90vh;
        overflow-y: auto;
    }
    
    /* Fullscreen styles */
    #fullscreen-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: black;
        z-index: 9999;
        display: none;
    }
    #fullscreen-video {
        width: 100%;
        height: 100%;
        object-fit: contain;
    }
    #fullscreen-controls {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.8);
        padding: 10px 20px;
        border-radius: 25px;
        z-index: 10000;
        display: flex;
        gap: 10px;
        backdrop-filter: blur(10px);
    }
    
    /* Global controls */
    .global-controls {
        background: #1E293B;
        border: 2px solid #334155;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="mb-6">
    <h2 class="text-2xl font-bold flex items-center gap-2">
        <i class="bi bi-camera-video text-sky"></i> Live CCTV Monitoring
    </h2>
    <p class="text-gray-400 mt-2">Real-time surveillance feeds with individual and global AI controls</p>
</div>

<!-- Global Controls -->
<!-- <div class="global-controls">
    <h3 class="text-lg font-bold mb-4 flex items-center gap-2 text-white">
        <i class="bi bi-sliders text-sky"></i> Global Controls
    </h3>
    <div class="flex flex-wrap gap-4">
        <button onclick="startAllStreams()" class="bg-sky hover:bg-sky/80 text-white px-6 py-3 rounded-lg transition flex items-center gap-2 font-semibold">
            <i class="bi bi-play-circle"></i> Start All Streams
        </button>
        <button onclick="stopAllStreams()" class="bg-alert hover:bg-red-700 text-white px-6 py-3 rounded-lg transition flex items-center gap-2 font-semibold">
            <i class="bi bi-stop-circle"></i> Stop All Streams
        </button>
        <button onclick="startAllAI()" class="bg-greenlight hover:bg-green-600 text-white px-6 py-3 rounded-lg transition flex items-center gap-2 font-semibold">
            <i class="bi bi-cpu"></i> Start All AI
        </button>
        <button onclick="stopAllAI()" class="bg-gold hover:bg-yellow-600 text-gray-900 px-6 py-3 rounded-lg transition flex items-center gap-2 font-semibold">
            <i class="bi bi-pause-circle"></i> Stop All AI
        </button>
    </div>
</div> -->

<!-- Camera Grid -->
<div class="camera-grid mb-8">
    <!-- Camera 1 -->
    <div class="camera-feed" id="camera-cam1">
        <div class="camera-status bg-greenlight/80">LIVE</div>
        <div id="aiStatus-cam1" class="ai-status ai-inactive">AI INACTIVE</div>
        
        <div class="aspect-video bg-gradient-to-br from-sky/20 to-alert/20 flex items-center justify-center">
            <img id="video-cam1" src="" class="hidden w-full h-full object-cover camera-video">
            <div id="placeholder-cam1" class="text-center text-white">
                <i class="bi bi-camera-video text-4xl mb-2 opacity-50"></i>
                <p class="font-semibold" id="cameraName-cam1">Payung 1-3</p>
                <p class="text-sm opacity-70">Click configure to set RTSP URL</p>
            </div>
        </div>
        
        <div class="p-4 bg-[#1E293B]">
            <div class="flex justify-between items-center gap-2">
                <span class="text-sm text-gray-400" id="cameraLabel-cam1">Camera 1</span>
                <div class="flex gap-2">
                    <button onclick="openConfigModal('cam1')" class="bg-gold hover:bg-yellow-600 text-gray-900 px-3 py-1 rounded text-sm transition">
                        <i class="bi bi-gear mr-1"></i> Configure
                    </button>
                    <button onclick="toggleStream('cam1')" class="bg-sky hover:bg-sky/80 text-white px-3 py-1 rounded text-sm transition">
                        <i class="bi bi-play-circle mr-1"></i> Start Stream
                    </button>
                    <button id="aiToggle-cam1" onclick="toggleAI('cam1')" class="bg-greenlight hover:bg-green-600 text-white px-3 py-1 rounded text-sm transition" disabled>
                        <i class="bi bi-cpu mr-1"></i> Start AI
                    </button>
                    <button onclick="toggleFullscreen('cam1')" class="bg-purple-500 hover:bg-purple-600 text-white px-3 py-1 rounded text-sm transition">
                        <i class="bi bi-arrows-fullscreen mr-1"></i> 
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Camera 2 -->
    <div class="camera-feed" id="camera-cam2">
        <div class="camera-status bg-greenlight/80">LIVE</div>
        <div id="aiStatus-cam2" class="ai-status ai-inactive">AI INACTIVE</div>
        
        <div class="aspect-video bg-gradient-to-br from-gold/20 to-greenlight/20 flex items-center justify-center">
            <img id="video-cam2" src="" class="hidden w-full h-full object-cover camera-video">
            <div id="placeholder-cam2" class="text-center text-white">
                <i class="bi bi-camera-video text-4xl mb-2 opacity-50"></i>
                <p class="font-semibold" id="cameraName-cam2">DPWH 1-2</p>
                <p class="text-sm opacity-70">Click configure to set RTSP URL</p>
            </div>
        </div>
        
        <div class="p-4 bg-[#1E293B]">
            <div class="flex justify-between items-center gap-2">
                <span class="text-sm text-gray-400" id="cameraLabel-cam2">Camera 2</span>
                <div class="flex gap-2">
                    <button onclick="openConfigModal('cam2')" class="bg-gold hover:bg-yellow-600 text-gray-900 px-3 py-1 rounded text-sm transition">
                        <i class="bi bi-gear mr-1"></i> Configure
                    </button>
                    <button onclick="toggleStream('cam2')" class="bg-sky hover:bg-sky/80 text-white px-3 py-1 rounded text-sm transition">
                        <i class="bi bi-play-circle mr-1"></i> Start Stream
                    </button>
                    <button id="aiToggle-cam2" onclick="toggleAI('cam2')" class="bg-greenlight hover:bg-green-600 text-white px-3 py-1 rounded text-sm transition" disabled>
                        <i class="bi bi-cpu mr-1"></i> Start AI
                    </button>
                    <button onclick="toggleFullscreen('cam2')" class="bg-purple-500 hover:bg-purple-600 text-white px-3 py-1 rounded text-sm transition">
                        <i class="bi bi-arrows-fullscreen mr-1"></i> 
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Camera 3 -->
    <div class="camera-feed" id="camera-cam3">
        <div class="camera-status bg-alert/80">ALERT</div>
        <div id="aiStatus-cam3" class="ai-status ai-inactive">AI INACTIVE</div>
        
        <div class="aspect-video bg-gradient-to-br from-alert/20 to-red-500/20 flex items-center justify-center relative">
            <img id="video-cam3" src="" class="hidden w-full h-full object-cover camera-video">
            <div id="placeholder-cam3" class="text-center text-white relative z-10">
                <i class="bi bi-exclamation-triangle text-4xl mb-2"></i>
                <p class="font-semibold" id="cameraName-cam3">Market Road</p>
                <p class="text-sm">üö® Manual Alert - Configure to enable</p>
            </div>
        </div>
        
        <div class="p-4 bg-[#1E293B]">
            <div class="flex justify-between items-center gap-2">
                <span class="text-sm text-alert">Manual Alert</span>
                <div class="flex gap-2">
                    <button onclick="openConfigModal('cam3')" class="bg-gold hover:bg-yellow-600 text-gray-900 px-3 py-1 rounded text-sm transition">
                        <i class="bi bi-gear mr-1"></i> Configure
                    </button>
                    <button onclick="toggleStream('cam3')" class="bg-sky hover:bg-sky/80 text-white px-3 py-1 rounded text-sm transition">
                        <i class="bi bi-play-circle mr-1"></i> Start Stream
                    </button>
                    <button id="aiToggle-cam3" onclick="toggleAI('cam3')" class="bg-greenlight hover:bg-green-600 text-white px-3 py-1 rounded text-sm transition" disabled>
                        <i class="bi bi-cpu mr-1"></i> Start AI
                    </button>
                    <button onclick="toggleFullscreen('cam3')" class="bg-purple-500 hover:bg-purple-600 text-white px-3 py-1 rounded text-sm transition">
                        <i class="bi bi-arrows-fullscreen mr-1"></i> 
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Camera 4 -->
    <div class="camera-feed" id="camera-cam4">
        <div class="camera-status bg-greenlight/80">LIVE</div>
        <div id="aiStatus-cam4" class="ai-status ai-inactive">AI INACTIVE</div>
        
        <div class="aspect-video bg-gradient-to-br from-purple-500/20 to-pink-500/20 flex items-center justify-center">
            <img id="video-cam4" src="" class="hidden w-full h-full object-cover camera-video">
            <div id="placeholder-cam4" class="text-center text-white">
                <i class="bi bi-camera-video text-4xl mb-2 opacity-50"></i>
                <p class="font-semibold" id="cameraName-cam4">Galvez 1-2</p>
                <p class="text-sm opacity-70">Click configure to set RTSP URL</p>
            </div>
        </div>
        
        <div class="p-4 bg-[#1E293B]">
            <div class="flex justify-between items-center gap-2">
                <span class="text-sm text-gray-400" id="cameraLabel-cam4">Camera 4</span>
                <div class="flex gap-2">
                    <button onclick="openConfigModal('cam4')" class="bg-gold hover:bg-yellow-600 text-gray-900 px-3 py-1 rounded text-sm transition">
                        <i class="bi bi-gear mr-1"></i> Configure
                    </button>
                    <button onclick="toggleStream('cam4')" class="bg-sky hover:bg-sky/80 text-white px-3 py-1 rounded text-sm transition">
                        <i class="bi bi-play-circle mr-1"></i> Start Stream
                    </button>
                    <button id="aiToggle-cam4" onclick="toggleAI('cam4')" class="bg-greenlight hover:bg-green-600 text-white px-3 py-1 rounded text-sm transition" disabled>
                        <i class="bi bi-cpu mr-1"></i> Start AI
                    </button>
                    <button onclick="toggleFullscreen('cam4')" class="bg-purple-500 hover:bg-purple-600 text-white px-3 py-1 rounded text-sm transition">
                        <i class="bi bi-arrows-fullscreen mr-1"></i> 
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Configuration Modal -->
<div id="configModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="text-xl font-bold text-white" id="configTitle">Configure Camera</h3>
            <button onclick="closeConfigModal()" class="modal-close">
                &times;
            </button>
        </div>
        
        <div class="space-y-4">
            <div>
                <label class="block text-sm text-gray-400 mb-2">Camera Name</label>
                <input type="text" id="configCameraName" 
                       class="w-full px-3 py-2 bg-darkbg rounded-lg border border-gray-600 text-white focus:border-sky focus:ring-1 focus:ring-sky transition"
                       placeholder="Enter camera name">
            </div>
            
            <div>
                <label class="block text-sm text-gray-400 mb-2">RTSP URL</label>
                <input type="text" id="configRtspUrl" 
                       class="w-full px-3 py-2 bg-darkbg rounded-lg border border-gray-600 text-white focus:border-sky focus:ring-1 focus:ring-sky transition"
                       placeholder="rtsp://ip:port/stream">
                
                <div class="mt-3 p-3 bg-darkbg rounded-lg border border-gray-600">
                    <p class="text-sm text-gray-400 mb-2">Common RTSP Formats:</p>
                    <ul class="text-xs text-gray-500 space-y-1">
                        <li>‚Ä¢ <code class="bg-black px-1 rounded">rtsp://192.168.1.100:554/stream</code></li>
                        <li>‚Ä¢ <code class="bg-black px-1 rounded">http://192.168.1.100:8080/video</code></li>
                        <li>‚Ä¢ <code class="bg-black px-1 rounded">rtsp://username:password@ip:port/stream</code></li>
                        <li>‚Ä¢ <code class="bg-black px-1 rounded">rtsp://192.168.1.183:8080/h264.sdp</code></li>
                    </ul>
                </div>
            </div>
            
            <div class="flex gap-3 mt-6">
                <button onclick="saveCameraConfig()" class="flex-1 bg-sky hover:bg-sky/80 text-white py-3 rounded-lg transition font-semibold">
                    <i class="bi bi-check-lg mr-2"></i> Save Configuration
                </button>
                <button onclick="closeConfigModal()" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white py-3 rounded-lg transition font-semibold">
                    <i class="bi bi-x-lg mr-2"></i> Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Fullscreen Container -->
<div id="fullscreen-container">
    <img id="fullscreen-video" src="" alt="Fullscreen Video">
    <div id="fullscreen-controls">
        <button onclick="exitFullscreen()" class="bg-alert hover:bg-red-700 text-white px-4 py-2 rounded-lg transition flex items-center gap-2">
            <i class="bi bi-fullscreen-exit"></i> Exit Fullscreen
        </button>
    </div>
</div>  

<!-- Statistics Panels -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-6">
    <!-- Your existing statistics panels -->
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Camera configuration storage
const cameraConfigs = {
    'cam1': {
        name: 'Payung 1-3',
        rtspUrl: 'rtsp://192.168.1.183:8080/h264.sdp',
        aiEnabled: false,
        streamActive: false,
        streamUrl: ''
    },
    'cam2': {
        name: 'DPWH 1-2', 
        rtspUrl: 'rtsp://192.168.1.183:8080/h264.sdp',
        aiEnabled: false,
        streamActive: false,
        streamUrl: ''
    },
    'cam3': {
        name: 'Market Road',
        rtspUrl: 'rtsp://192.168.1.183:8080/h264.sdp',
        aiEnabled: false,
        streamActive: false,
        streamUrl: ''
    },
    'cam4': {
        name: 'Galvez 1-2',
        rtspUrl: 'rtsp://192.168.1.183:8080/h264.sdp',
        aiEnabled: false,
        streamActive: false,
        streamUrl: ''
    }
};

let currentConfigCamera = null;
let currentFullscreenCamera = null;

document.addEventListener('DOMContentLoaded', function() {
    loadCameraConfigs();
    
    // Handle ESC key to exit fullscreen
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && currentFullscreenCamera) {
            exitFullscreen();
        }
    });
});

// Global Control Functions
async function startAllStreams() {
    showNotification('üöÄ Starting all camera streams...', 'info');
    
    for (const cameraId of Object.keys(cameraConfigs)) {
        if (!cameraConfigs[cameraId].streamActive) {
            await startCameraStream(cameraId);
            // Add small delay to avoid overwhelming the server
            await new Promise(resolve => setTimeout(resolve, 500));
        }
    }
}

async function stopAllStreams() {
    showNotification('‚èπÔ∏è Stopping all camera streams...', 'info');
    
    for (const cameraId of Object.keys(cameraConfigs)) {
        if (cameraConfigs[cameraId].streamActive) {
            await stopCameraStream(cameraId);
        }
    }
}

async function startAllAI() {
    showNotification('ü§ñ Starting AI on all active streams...', 'info');
    
    for (const cameraId of Object.keys(cameraConfigs)) {
        if (cameraConfigs[cameraId].streamActive && !cameraConfigs[cameraId].aiEnabled) {
            await toggleAI(cameraId);
            await new Promise(resolve => setTimeout(resolve, 300));
        }
    }
}

async function stopAllAI() {
    showNotification('‚èπÔ∏è Stopping AI on all cameras...', 'info');
    
    for (const cameraId of Object.keys(cameraConfigs)) {
        if (cameraConfigs[cameraId].aiEnabled) {
            await toggleAI(cameraId);
        }
    }
}

// Individual Camera Functions
async function toggleStream(cameraId) {
    const config = cameraConfigs[cameraId];
    
    if (config.streamActive) {
        await stopCameraStream(cameraId);
    } else {
        await startCameraStream(cameraId);
    }
}

async function startCameraStream(cameraId) {
    const config = cameraConfigs[cameraId];
    
    try {
        const response = await fetch('/start-camera-stream/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                camera_id: cameraId,
                rtsp_url: config.rtspUrl,
                camera_name: config.name
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            config.streamActive = true;
            config.streamUrl = `/camera-stream/${cameraId}/`;
            
            // Start the video stream
            const videoElement = document.getElementById(`video-${cameraId}`);
            const placeholder = document.getElementById(`placeholder-${cameraId}`);
            
            if (videoElement && placeholder) {
                videoElement.src = config.streamUrl + '?t=' + new Date().getTime();
                videoElement.classList.remove('hidden');
                placeholder.classList.add('hidden');
                
                videoElement.onload = function() {
                    console.log(`‚úÖ Stream started for ${config.name}`);
                };
                
                videoElement.onerror = function() {
                    console.error(`‚ùå Stream failed for ${config.name}`);
                    showNotification(`‚ùå Failed to connect to ${config.name}`, 'error');
                    stopCameraStream(cameraId);
                };
            }
            
            showNotification(`üé• Live stream started for ${config.name}`, 'success');
            updateCameraUI(cameraId);
            
        } else {
            throw new Error(data.error || 'Failed to start stream');
        }
    } catch (error) {
        console.error('Error starting stream:', error);
        showNotification(`‚ùå Failed to start stream for ${config.name}: ${error.message}`, 'error');
    }
}

async function stopCameraStream(cameraId) {
    const config = cameraConfigs[cameraId];
    
    try {
        const response = await fetch('/stop-camera-stream/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                camera_id: cameraId
            })
        });
        
        if (response.ok) {
            config.streamActive = false;
            config.aiEnabled = false;
            config.streamUrl = '';
            
            // Hide video and show placeholder
            const videoElement = document.getElementById(`video-${cameraId}`);
            const placeholder = document.getElementById(`placeholder-${cameraId}`);
            
            if (videoElement && placeholder) {
                videoElement.src = '';
                videoElement.classList.add('hidden');
                placeholder.classList.remove('hidden');
            }
            
            updateCameraUI(cameraId);
            showNotification(`‚èπÔ∏è Stream stopped for ${config.name}`, 'success');
        }
    } catch (error) {
        console.error('Error stopping stream:', error);
    }
}

async function toggleAI(cameraId) {
    const config = cameraConfigs[cameraId];
    
    if (!config.streamActive) {
        showNotification('‚ö†Ô∏è Please start the stream first before enabling AI', 'error');
        return;
    }
    
    try {
        const response = await fetch('/toggle-camera-ai/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                camera_id: cameraId,
                ai_enabled: !config.aiEnabled
            })
        });
        
        if (response.ok) {
            config.aiEnabled = !config.aiEnabled;
            updateCameraUI(cameraId);
            localStorage.setItem(`camera_${cameraId}`, JSON.stringify(config));
            
            showNotification(
                config.aiEnabled ? 
                `ü§ñ AI enabled for ${config.name}` : 
                `‚èπÔ∏è AI disabled for ${config.name}`,
                'success'
            );
            
            // Start status updates if AI is enabled
            if (config.aiEnabled) {
                startStatusUpdates(cameraId);
            }
        }
    } catch (error) {
        console.error('Error toggling AI:', error);
        showNotification(`‚ùå Failed to toggle AI for ${config.name}`, 'error');
    }
}

function startStatusUpdates(cameraId) {
    // Update status every 2 seconds for cameras with AI enabled
    setInterval(async () => {
        if (cameraConfigs[cameraId]?.aiEnabled) {
            try {
                const response = await fetch(`/camera-status/${cameraId}/`);
                const data = await response.text();
                
                // Parse status data
                const parts = data.split('|');
                let crashDetected = false;
                
                parts.forEach(part => {
                    if (part.startsWith('Crash:')) {
                        crashDetected = part.split(':')[1] === "True";
                    }
                });
                
                // Update UI if crash detected
                if (crashDetected) {
                    const cameraElement = document.getElementById(`camera-${cameraId}`);
                    const statusElement = document.getElementById(`aiStatus-${cameraId}`);
                    
                    if (cameraElement && statusElement) {
                        cameraElement.style.borderColor = '#EF4444';
                        statusElement.textContent = 'üö® CRASH DETECTED!';
                        statusElement.className = 'ai-status bg-alert';
                        
                        // Flash alert
                        cameraElement.style.animation = 'pulse 0.5s infinite';
                        setTimeout(() => {
                            cameraElement.style.animation = '';
                        }, 5000);
                    }
                }
            } catch (error) {
                console.error('Status update error:', error);
            }
        }
    }, 2000);
}

// Modal functions (same as before)
function openConfigModal(cameraId) {
    const config = cameraConfigs[cameraId];
    currentConfigCamera = cameraId;
    
    document.getElementById('configTitle').textContent = `Configure ${config.name}`;
    document.getElementById('configCameraName').value = config.name;
    document.getElementById('configRtspUrl').value = config.rtspUrl;
    document.getElementById('configModal').style.display = 'block';
}

function closeConfigModal() {
    document.getElementById('configModal').style.display = 'none';
    currentConfigCamera = null;
}

function saveCameraConfig() {
    if (!currentConfigCamera) return;
    
    const newName = document.getElementById('configCameraName').value.trim();
    const newUrl = document.getElementById('configRtspUrl').value.trim();
    
    if (newName && newUrl) {
        const oldConfig = {...cameraConfigs[currentConfigCamera]};
        
        cameraConfigs[currentConfigCamera].name = newName;
        cameraConfigs[currentConfigCamera].rtspUrl = newUrl;
        
        // If stream was active with old URL, restart it
        if (oldConfig.streamActive && oldConfig.rtspUrl !== newUrl) {
            stopCameraStream(currentConfigCamera);
            setTimeout(() => startCameraStream(currentConfigCamera), 1000);
        }
        
        updateCameraUI(currentConfigCamera);
        localStorage.setItem(`camera_${currentConfigCamera}`, JSON.stringify(cameraConfigs[currentConfigCamera]));
        
        showNotification(`‚úÖ ${newName} configured successfully!`, 'success');
        closeConfigModal();
    } else {
        showNotification('‚ùå Please enter both camera name and RTSP URL', 'error');
    }
}

function updateCameraUI(cameraId) {
    const config = cameraConfigs[cameraId];
    
    // Update camera name displays
    document.getElementById(`cameraName-${cameraId}`).textContent = config.name;
    document.getElementById(`cameraLabel-${cameraId}`).textContent = config.name;
    
    // Update AI status
    const aiStatus = document.getElementById(`aiStatus-${cameraId}`);
    const aiToggle = document.getElementById(`aiToggle-${cameraId}`);
    
    if (aiStatus) {
        aiStatus.textContent = config.aiEnabled ? 'AI ACTIVE' : 'AI INACTIVE';
        aiStatus.className = `ai-status ${config.aiEnabled ? 'ai-active' : 'ai-inactive'}`;
    }
    
    if (aiToggle) {
        aiToggle.innerHTML = config.aiEnabled ? 
            '<i class="bi bi-pause-circle mr-1"></i> Stop AI' : 
            '<i class="bi bi-play-circle mr-1"></i> Start AI';
        aiToggle.className = config.aiEnabled ?
            'bg-alert hover:bg-red-700 text-white px-3 py-1 rounded text-sm transition' :
            'bg-greenlight hover:bg-green-600 text-white px-3 py-1 rounded text-sm transition';
            
        // Enable/disable AI button based on stream status
        aiToggle.disabled = !config.streamActive;
        if (!config.streamActive) {
            aiToggle.classList.add('opacity-50', 'cursor-not-allowed');
        } else {
            aiToggle.classList.remove('opacity-50', 'cursor-not-allowed');
        }
    }
    
    // Update stream control button
    const streamToggle = document.querySelector(`[onclick="toggleStream('${cameraId}')"]`);
    if (streamToggle) {
        streamToggle.innerHTML = config.streamActive ? 
            '<i class="bi bi-stop-circle mr-1"></i> Stop Stream' : 
            '<i class="bi bi-play-circle mr-1"></i> Start Stream';
        streamToggle.className = config.streamActive ?
            'bg-alert hover:bg-red-700 text-white px-3 py-1 rounded text-sm transition' :
            'bg-sky hover:bg-sky/80 text-white px-3 py-1 rounded text-sm transition';
    }
}

// Add stream control button to your camera HTML
function toggleStream(cameraId) {
    const config = cameraConfigs[cameraId];
    
    if (config.streamActive) {
        stopCameraStream(cameraId);
    } else {
        startCameraStream(cameraId);
    }
}

// Enhanced Fullscreen Functionality
function toggleFullscreen(cameraId) {
    if (currentFullscreenCamera) {
        exitFullscreen();
    } else {
        enterFullscreen(cameraId);
    }
}

function enterFullscreen(cameraId) {
    const videoElement = document.getElementById(`video-${cameraId}`);
    
    if (videoElement && videoElement.src && cameraConfigs[cameraId].streamActive) {
        currentFullscreenCamera = cameraId;
        
        const fullscreenContainer = document.getElementById('fullscreen-container');
        const fullscreenVideo = document.getElementById('fullscreen-video');
        
        // Set the video source
        fullscreenVideo.src = videoElement.src;
        
        // Show fullscreen container
        fullscreenContainer.style.display = 'block';
        
        // Hide original camera feeds
        document.querySelectorAll('.camera-feed').forEach(feed => {
            feed.style.opacity = '0.3';
        });
        
        console.log(`üîç Entered fullscreen for ${cameraConfigs[cameraId].name}`);
    } else {
        showNotification('‚ö†Ô∏è Please start the stream first before entering fullscreen', 'error');
    }
}

function exitFullscreen() {
    const fullscreenContainer = document.getElementById('fullscreen-container');
    const fullscreenVideo = document.getElementById('fullscreen-video');
    
    // Hide fullscreen container
    fullscreenContainer.style.display = 'none';
    fullscreenVideo.src = '';
    
    // Restore original camera feeds
    document.querySelectorAll('.camera-feed').forEach(feed => {
        feed.style.opacity = '1';
    });
    
    currentFullscreenCamera = null;
    console.log('üîç Exited fullscreen');
}

function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 p-4 rounded-lg ${
        type === 'success' ? 'bg-greenlight' : 
        type === 'error' ? 'bg-alert' : 
        type === 'info' ? 'bg-sky' : 'bg-gold'
    } text-white z-50 shadow-lg transition-all duration-300`;
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => notification.remove(), 300);
    }, 4000);
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}