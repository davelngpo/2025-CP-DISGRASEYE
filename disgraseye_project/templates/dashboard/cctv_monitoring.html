{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}CCTV Monitoring | DisgrasEye{% endblock %}

{% block extra_head %}
<style>
    .camera-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 20px;
    }
    .camera-feed {
        background: #000;
        border-radius: 12px;
        overflow: hidden;
        position: relative;
        border: 2px solid #334155;
        transition: all 0.3s ease;
    }
    .camera-feed:hover {
        border-color: #38BDF8;
        transform: translateY(-2px);
    }
    .camera-status {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(0,0,0,0.7);
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        z-index: 10;
    }
    .ai-status {
        position: absolute;
        top: 10px;
        left: 10px;
        background: rgba(0,0,0,0.7);
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        z-index: 10;
    }
    .ai-active      { background: rgba(34, 197, 94, 0.85) !important; }
    .ai-inactive    { background: rgba(107, 114, 128, 0.8) !important; }
    .status-active  { background: rgba(34, 197, 94, 0.85) !important; }
    .status-offline { background: rgba(239, 68, 68, 0.85) !important; }
    .status-maintenance { background: rgba(251, 191, 36, 0.85) !important; }

    /* Modal */
    .modal-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.7);
        z-index: 1000;
        backdrop-filter: blur(5px);
    }
    .modal-content {
        position: absolute;
        top: 50%; left: 50%;
        transform: translate(-50%, -50%);
        background: #1E293B;
        border: 2px solid #334155;
        border-radius: 12px;
        padding: 2rem;
        width: 90%;
        max-width: 500px;
        max-height: 90vh;
        overflow-y: auto;
    }

    /* Fullscreen */
    #fullscreen-container {
        position: fixed;
        inset: 0;
        background: black;
        z-index: 9999;
        display: none;
        align-items: center;
        justify-content: center;
    }
    #fullscreen-img {
        width: 100%;
        height: 100%;
        object-fit: contain;
        display: block;
    }
    #fullscreen-controls {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0,0,0,0.8);
        padding: 10px 20px;
        border-radius: 25px;
        z-index: 10000;
        display: flex;
        gap: 10px;
        backdrop-filter: blur(10px);
    }
    #fullscreen-label {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        z-index: 10000;
        font-size: 14px;
        backdrop-filter: blur(10px);
    }

    /* Global controls bar */
    .global-controls {
        background: #1E293B;
        border: 2px solid #334155;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }

    /* Camera viewport (16:9 aspect ratio box) */
    .camera-viewport {
        position: relative;
        width: 100%;
        padding-top: 56.25%;
        background: #0f172a;
        overflow: hidden;
    }
    .camera-viewport > * {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
    }
    .camera-img {
        object-fit: cover;
        display: none;
    }
    .camera-placeholder {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: white;
        text-align: center;
        gap: 4px;
        padding: 1rem;
    }
    .camera-loading {
        display: none;
        align-items: center;
        justify-content: center;
        background: rgba(0,0,0,0.6);
        z-index: 5;
    }
    .camera-reconnect {
        display: none;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        background: rgba(0,0,0,0.75);
        z-index: 6;
        gap: 8px;
        color: #fbbf24;
        font-size: 13px;
    }
</style>
{% endblock %}

{% block content %}
<!-- <div class="bg-yellow-500/20 text-yellow-500 p-2 rounded mb-4 text-xs">
    Debug - User ID from Django: {{ user.user_id|default:"NOT PASSED" }}<br>
    User object: {{ user|default:"No user object" }}
</div> -->
<div class="mb-6">
    <h2 class="text-2xl font-bold flex items-center gap-2">
        <i class="bi bi-camera-video text-sky"></i> Live CCTV Monitoring
    </h2>
    <p class="text-gray-400 mt-2">Real-time surveillance feeds with individual and global AI controls</p>
</div>

<!-- Global Controls -->
<div class="global-controls">
    <div class="flex flex-wrap justify-between items-center gap-4">
        <div>
            <h3 class="text-lg font-bold flex items-center gap-2 text-white">
                <i class="bi bi-sliders text-sky"></i> Global Controls
            </h3>
            <p class="text-sm text-gray-400">Manage all cameras at once</p>
        </div>
        <div class="flex flex-wrap gap-3">
            <button onclick="startAllStreams()"
                class="bg-sky hover:bg-sky/80 text-white px-5 py-2.5 rounded-lg transition flex items-center gap-2 font-semibold text-sm">
                <i class="bi bi-play-circle"></i> Start All Streams
            </button>
            <button onclick="stopAllStreams()"
                class="bg-alert hover:bg-red-700 text-white px-5 py-2.5 rounded-lg transition flex items-center gap-2 font-semibold text-sm">
                <i class="bi bi-stop-circle"></i> Stop All Streams
            </button>
            <button onclick="startAllAI()"
                class="bg-greenlight hover:bg-green-600 text-white px-5 py-2.5 rounded-lg transition flex items-center gap-2 font-semibold text-sm">
                <i class="bi bi-cpu"></i> Start All AI
            </button>
            <button onclick="stopAllAI()"
                class="bg-gold hover:bg-yellow-600 text-gray-900 px-5 py-2.5 rounded-lg transition flex items-center gap-2 font-semibold text-sm">
                <i class="bi bi-pause-circle"></i> Stop All AI
            </button>
        </div>
    </div>
</div>

<!-- Camera Grid -->
<div class="camera-grid mb-8" id="camerasGrid">
    <div class="text-center py-12 col-span-full">
        <div class="animate-spin h-8 w-8 border-2 border-sky border-t-transparent rounded-full mx-auto mb-4"></div>
        <p class="text-gray-400">Loading cameras from databaseâ€¦</p>
    </div>
</div>

<!-- Config Modal -->
<div id="configModal" class="modal-overlay">
    <div class="modal-content">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-white" id="configTitle">Configure Camera</h3>
            <button onclick="closeConfigModal()" class="text-gray-400 hover:text-white text-2xl leading-none">&times;</button>
        </div>
        <div class="space-y-4">
            <div>
                <label class="block text-sm text-gray-400 mb-1">Location Name</label>
                <input type="text" id="configLocationName"
                    class="w-full px-3 py-2 bg-darkbg rounded-lg border border-gray-600 text-white focus:border-sky focus:outline-none transition"
                    placeholder="e.g. Main Entrance">
            </div>
            <div>
                <label class="block text-sm text-gray-400 mb-1">IP Address / RTSP URL</label>
                <input type="text" id="configIpAddress"
                    class="w-full px-3 py-2 bg-darkbg rounded-lg border border-gray-600 text-white focus:border-sky focus:outline-none transition"
                    placeholder="rtsp://192.168.1.227:8080/h264.sdp">
                <div class="mt-2 p-3 bg-darkbg rounded-lg border border-gray-700 text-xs text-gray-500 space-y-1">
                    <p class="text-gray-400 font-medium mb-1">Common formats:</p>
                    <p>â€¢ <code class="bg-black px-1 rounded">rtsp://192.168.1.227:8080/h264.sdp</code></p>
                    <p>â€¢ <code class="bg-black px-1 rounded">http://192.168.1.100:8080/video</code></p>
                    <p>â€¢ <code class="bg-black px-1 rounded">rtsp://user:pass@ip:port/stream</code></p>
                </div>
            </div>
            <div>
                <label class="block text-sm text-gray-400 mb-1">Status</label>
                <select id="configStatus"
                    class="w-full px-3 py-2 bg-darkbg rounded-lg border border-gray-600 text-white focus:border-sky focus:outline-none transition">
                    <option value="Active">Active</option>
                    <option value="Offline">Offline</option>
                    <option value="Maintenance">Maintenance</option>
                </select>
            </div>
            <div class="flex gap-3 pt-2">
                <button onclick="saveCameraConfig()"
                    class="flex-1 bg-sky hover:bg-sky/80 text-white py-2.5 rounded-lg transition font-semibold text-sm">
                    <i class="bi bi-check-lg mr-1"></i> Save
                </button>
                <button onclick="deleteCamera()" id="deleteCameraBtn"
                    class="flex-1 bg-alert hover:bg-red-700 text-white py-2.5 rounded-lg transition font-semibold text-sm hidden">
                    <i class="bi bi-trash mr-1"></i> Delete
                </button>
                <button onclick="closeConfigModal()"
                    class="flex-1 bg-gray-600 hover:bg-gray-700 text-white py-2.5 rounded-lg transition font-semibold text-sm">
                    <i class="bi bi-x-lg mr-1"></i> Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add Camera FAB -->
<div class="fixed bottom-6 right-6 z-50">
    <button onclick="openAddCameraModal()"
        class="bg-greenlight hover:bg-green-600 text-white p-4 rounded-full shadow-lg transition transform hover:scale-110"
        title="Add Camera">
        <i class="bi bi-plus-lg text-2xl"></i>
    </button>
</div>

<!-- Fullscreen overlay -->
<div id="fullscreen-container">
    <span id="fullscreen-label"></span>
    <img id="fullscreen-img" src="" alt="Fullscreen camera stream">
    <div id="fullscreen-controls">
        <button onclick="exitFullscreen()"
            class="bg-alert hover:bg-red-700 text-white px-4 py-2 rounded-lg transition flex items-center gap-2">
            <i class="bi bi-fullscreen-exit"></i> Exit Fullscreen
        </button>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// â”€â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let cctvSupabase          = null;
let cameraConfigs         = {};      // { [string(cameraId)]: config }
let currentConfigCamera   = null;
let isEditing             = false;
let currentFullscreenCamera = null;
const streamPollers       = {};      // reconnect timers

// â”€â”€â”€ Supabase â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getSupabaseClient() {
    if (!cctvSupabase) {
        cctvSupabase = window._supabase ?? supabase.createClient(
            "{{ SUPABASE_URL|default:'https://ivigoibymrcvaftgayqv.supabase.co' }}",
            "{{ SUPABASE_ANON_KEY|default:'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml2aWdvaWJ5bXJjdmFmdGdheXF2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5MDI2MDgsImV4cCI6MjA3OTQ3ODYwOH0.c3MoFVyNGXwZ3zqtgWz62Du0WfA7pranyAXDwRpy5sw' }}"
        );
    }
    return cctvSupabase;
}

// â”€â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const sid = id => String(id);   // normalize camera IDs to string

function buildStreamUrl(cameraId) {
    // Cache-bust so browser always re-fetches when we set src
    return `/camera-stream/${sid(cameraId)}/?t=${Date.now()}`;
}

function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

function getCookie(name) {
    for (const c of document.cookie.split(';')) {
        const t = c.trim();
        if (t.startsWith(name + '=')) return decodeURIComponent(t.slice(name.length + 1));
    }
    return null;
}

function showNotification(message, type = 'info') {
    document.querySelectorAll('.notif-toast').forEach(n => n.remove());
    const bg = { success: 'bg-greenlight', error: 'bg-alert', info: 'bg-sky', warn: 'bg-gold' }[type] ?? 'bg-sky';
    const icon = { success: 'bi-check-circle', error: 'bi-exclamation-triangle', info: 'bi-info-circle', warn: 'bi-exclamation-circle' }[type] ?? 'bi-info-circle';
    const el = document.createElement('div');
    el.className = `notif-toast fixed top-4 right-4 p-4 rounded-lg ${bg} text-white z-[99999] shadow-xl transition-all duration-300`;
    el.innerHTML = `<div class="flex items-center gap-2"><i class="bi ${icon}"></i><span>${message}</span></div>`;
    document.body.appendChild(el);
    setTimeout(() => { el.style.opacity = '0'; el.style.transform = 'translateX(120%)'; setTimeout(() => el.remove(), 350); }, 4000);
}

// â”€â”€â”€ Load cameras from Supabase â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadCamerasFromDatabase() {
    try {
        const sb = getSupabaseClient();
        
        // â† Fetch both DB cameras AND current backend stream state in parallel
        const [{ data: cameras, error }, activeRes] = await Promise.all([
            sb.from('cctv').select('*').order('camera_id', { ascending: true }),
            fetch('/get-active-streams/').then(r => r.json()).catch(() => ({ active_streams: {} }))
        ]);

        if (error) throw error;

        const activeStreams = activeRes.active_streams || {};  // â† ground truth from backend
        const prev = { ...cameraConfigs };
        cameraConfigs = {};

        const grid = document.getElementById('camerasGrid');

        if (!cameras || cameras.length === 0) {
            grid.innerHTML = `
                <div class="col-span-full text-center py-12">
                    <i class="bi bi-camera-video-off text-5xl text-gray-600 block mb-3"></i>
                    <p class="text-gray-400">No cameras configured</p>
                    <p class="text-sm text-gray-500 mt-1">Click the + button to add one</p>
                </div>`;
            return;
        }

        grid.innerHTML = cameras.map(cam => {
            const id  = sid(cam.camera_id);
            const old = prev[id] ?? {};
            
            // â† Prefer backend truth over stale JS memory
            const backendStream = activeStreams[id] ?? activeStreams[String(id)] ?? null;
            const streamActive  = backendStream ? backendStream.active     : (old.stream_active ?? false);
            const aiEnabled     = backendStream ? backendStream.ai_enabled : (old.ai_enabled    ?? false);

            cameraConfigs[id] = {
                camera_id:     id,
                location_name: cam.location_name,
                ip_address:    cam.ip_address,
                status:        cam.status,
                stream_active: streamActive,
                ai_enabled:    aiEnabled,
            };

            const statusClass = cam.status === 'Offline'     ? 'status-offline'
                              : cam.status === 'Maintenance'  ? 'status-maintenance'
                              : 'status-active';
            const statusText  = cam.status === 'Offline'     ? 'OFFLINE'
                              : cam.status === 'Maintenance'  ? 'MAINTENANCE'
                              : 'LIVE';

            return `
            <div class="camera-feed" id="camera-${id}">
                <div class="camera-status ${statusClass}" id="camStatus-${id}">${statusText}</div>
                <div class="ai-status ai-inactive" id="aiStatus-${id}">AI INACTIVE</div>
                <div class="camera-viewport">
                    <div class="camera-placeholder" id="placeholder-${id}">
                        <i class="bi bi-camera-video text-5xl opacity-30 mb-2"></i>
                        <p class="font-semibold">${cam.location_name}</p>
                        <p class="text-xs opacity-50">${cam.ip_address}</p>
                        <p class="text-xs opacity-30 mt-1">ID: ${id}</p>
                    </div>
                    <div class="camera-loading" id="loading-${id}">
                        <div class="animate-spin h-9 w-9 border-2 border-sky border-t-transparent rounded-full"></div>
                    </div>
                    <div class="camera-reconnect" id="reconnect-${id}">
                        <i class="bi bi-arrow-repeat text-2xl"></i>
                        <span class="text-sm">Reconnectingâ€¦</span>
                    </div>
                    <img id="video-${id}" class="camera-img" src="" alt="${cam.location_name}"
                         onload="handleStreamLoad('${id}')"
                         onerror="handleStreamError('${id}')">
                </div>
                <div class="p-4 bg-[#1E293B]">
                    <div class="flex justify-between items-center gap-2 flex-wrap">
                        <span class="text-sm text-gray-300 font-medium truncate max-w-[130px]">${cam.location_name}</span>
                        <div class="flex gap-1.5 flex-wrap">
                            <button onclick="openEditModal('${id}')"
                                class="bg-gold hover:bg-yellow-600 text-gray-900 px-2.5 py-1 rounded text-xs font-semibold transition">
                                <i class="bi bi-gear"></i> Edit
                            </button>
                            <button id="streamBtn-${id}" onclick="toggleStream('${id}')"
                                class="bg-sky hover:bg-sky/80 text-white px-2.5 py-1 rounded text-xs font-semibold transition">
                                <i class="bi bi-play-circle mr-1"></i>Start Stream
                            </button>
                            <button id="aiToggle-${id}" onclick="toggleAI('${id}')"
                                class="bg-greenlight hover:bg-green-600 text-white px-2.5 py-1 rounded text-xs font-semibold transition opacity-40 cursor-not-allowed"
                                disabled>
                                <i class="bi bi-cpu mr-1"></i>Start AI
                            </button>
                            <button onclick="toggleFullscreen('${id}')"
                                class="bg-purple-600 hover:bg-purple-700 text-white px-2.5 py-1 rounded text-xs font-semibold transition">
                                <i class="bi bi-arrows-fullscreen"></i>
                            </button>
                                <!-- â†  MOCK TEST BUTTON -->
    <button onclick="runMockTest('${id}')"
        class="bg-orange-500 hover:bg-orange-600 text-white px-2.5 py-1 rounded text-xs font-semibold transition"
        title="Send mock crash alert for this camera">
        <i class="bi bi-bug mr-1"></i> Test
    </button>
                        </div>
                    </div>
                </div>
            </div>`;
        }).join('');

        // â† Restore UI for all cameras based on reconciled state
        for (const id of Object.keys(cameraConfigs)) {
            const cfg = cameraConfigs[id];
            if (cfg.stream_active) {
                _attachStream(id);
                _syncStreamUI(id, true);
                _syncAIUI(id, cfg.ai_enabled);
            } else {
                _syncStreamUI(id, false);
                _disableAIUI(id);
            }
        }

    } catch (err) {
        console.error('loadCamerasFromDatabase:', err);
        showNotification('âŒ Failed to load cameras', 'error');
    }
}

// â”€â”€â”€ UI sync helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function _syncStreamUI(cameraId, active) {
    const btn = document.getElementById(`streamBtn-${cameraId}`);
    if (!btn) return;
    if (active) {
        btn.innerHTML = '<i class="bi bi-stop-circle mr-1"></i>Stop Stream';
        btn.className = 'bg-alert hover:bg-red-700 text-white px-2.5 py-1 rounded text-xs font-semibold transition';
    } else {
        btn.innerHTML = '<i class="bi bi-play-circle mr-1"></i>Start Stream';
        btn.className = 'bg-sky hover:bg-sky/80 text-white px-2.5 py-1 rounded text-xs font-semibold transition';
    }
}

function _syncAIUI(cameraId, enabled) {
    const btn   = document.getElementById(`aiToggle-${cameraId}`);
    const badge = document.getElementById(`aiStatus-${cameraId}`);
    if (btn) {
        btn.disabled = false;
        if (enabled) {
            btn.innerHTML = '<i class="bi bi-pause-circle mr-1"></i>Stop AI';
            btn.className = 'bg-alert hover:bg-red-700 text-white px-2.5 py-1 rounded text-xs font-semibold transition';
        } else {
            btn.innerHTML = '<i class="bi bi-cpu mr-1"></i>Start AI';
            btn.className = 'bg-greenlight hover:bg-green-600 text-white px-2.5 py-1 rounded text-xs font-semibold transition';
        }
    }
    if (badge) {
        badge.textContent = enabled ? 'AI ACTIVE' : 'AI INACTIVE';
        badge.className   = `ai-status ${enabled ? 'ai-active' : 'ai-inactive'}`;
    }
}

function _disableAIUI(cameraId) {
    const btn   = document.getElementById(`aiToggle-${cameraId}`);
    const badge = document.getElementById(`aiStatus-${cameraId}`);
    if (btn) {
        btn.innerHTML = '<i class="bi bi-cpu mr-1"></i>Start AI';
        btn.className = 'bg-greenlight hover:bg-green-600 text-white px-2.5 py-1 rounded text-xs font-semibold transition opacity-40 cursor-not-allowed';
        btn.disabled  = true;
    }
    if (badge) {
        badge.textContent = 'AI INACTIVE';
        badge.className   = 'ai-status ai-inactive';
    }
}

// â”€â”€â”€ Stream attachment â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function _attachStream(cameraId) {
    const id    = sid(cameraId);
    const img   = document.getElementById(`video-${id}`);
    const ph    = document.getElementById(`placeholder-${id}`);
    const spin  = document.getElementById(`loading-${id}`);
    const rcon  = document.getElementById(`reconnect-${id}`);
    if (!img) return;

    // Show spinner, hide others
    if (spin) spin.style.display = 'flex';
    if (ph)   ph.style.display   = 'none';
    if (rcon) rcon.style.display = 'none';
    img.style.display = 'none';

    // Set MJPEG src (browser will keep connection open)
    img.src = buildStreamUrl(id);
}

function _stopPoller(cameraId) {
    const id = sid(cameraId);
    if (streamPollers[id]) {
        clearTimeout(streamPollers[id]);
        delete streamPollers[id];
    }
}

// â”€â”€â”€ Stream events â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function handleStreamLoad(cameraId) {
    const id   = sid(cameraId);
    const img  = document.getElementById(`video-${id}`);
    const spin = document.getElementById(`loading-${id}`);
    const rcon = document.getElementById(`reconnect-${id}`);
    if (spin) spin.style.display = 'none';
    if (rcon) rcon.style.display = 'none';
    if (img)  img.style.display  = 'block';
}

function handleStreamError(cameraId) {
    const id  = sid(cameraId);
    const cfg = cameraConfigs[id];
    if (!cfg?.stream_active) return;   // stream was intentionally stopped

    const img  = document.getElementById(`video-${id}`);
    const spin = document.getElementById(`loading-${id}`);
    const rcon = document.getElementById(`reconnect-${id}`);
    if (spin) spin.style.display = 'none';
    if (img)  img.style.display  = 'none';
    if (rcon) rcon.style.display = 'flex';

    // Auto-reconnect after 3 s
    _stopPoller(id);
    streamPollers[id] = setTimeout(() => {
        if (cameraConfigs[id]?.stream_active) _attachStream(id);
    }, 3000);
}

// â”€â”€â”€ Toggle stream â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function toggleStream(cameraId) {
    const id  = sid(cameraId);
    const cfg = cameraConfigs[id];
    if (!cfg) return;
    cfg.stream_active ? await stopCameraStream(id) : await startCameraStream(id);
}

async function startCameraStream(cameraId) {
    const id  = sid(cameraId);
    const cfg = cameraConfigs[id];
    if (!cfg) return;

    if (cfg.status !== 'Active') {
        showNotification('âŒ Cannot stream an Offline or Maintenance camera', 'error');
        return;
    }

    // Disable button immediately to prevent double-clicks
    const btn = document.getElementById(`streamBtn-${id}`);
    if (btn) { btn.disabled = true; btn.innerHTML = '<i class="bi bi-hourglass-split mr-1"></i>Connectingâ€¦'; }

    try {
        const res = await fetch('/start-camera-stream/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
            body: JSON.stringify({
                camera_id:   id,
                rtsp_url:    cfg.ip_address,
                camera_name: cfg.location_name
            })
        });

        // Try to parse JSON regardless of status code for better error messages
        let data = {};
        try { data = await res.json(); } catch (_) {}

        if (!res.ok) {
            throw new Error(data.error || `Server returned ${res.status}`);
        }
        if (data.status !== 'success') {
            throw new Error(data.error || 'Unknown server error');
        }

        cfg.stream_active = true;
        cfg.ai_enabled    = false;   // always starts with AI OFF
        _syncStreamUI(id, true);
        _syncAIUI(id, false);        // enable AI button but show as inactive
        _attachStream(id);
        showNotification(`ğŸ¥ Stream started â€” ${cfg.location_name}`, 'success');

    } catch (err) {
        console.error('startCameraStream:', err);
        // â† KEY FIX: always reset button on any failure
        cfg.stream_active = false;
        _syncStreamUI(id, false);
        showNotification(`âŒ ${err.message}`, 'error');
    } finally {
        if (btn) btn.disabled = false;
    }
}

async function stopCameraStream(cameraId) {
    const id  = sid(cameraId);
    const cfg = cameraConfigs[id];
    if (!cfg) return;

    _stopPoller(id);

    // Update state immediately so onerror stops retrying
    cfg.stream_active = false;
    cfg.ai_enabled    = false;

    // Reset UI immediately (don't wait for server)
    const img  = document.getElementById(`video-${id}`);
    const ph   = document.getElementById(`placeholder-${id}`);
    const spin = document.getElementById(`loading-${id}`);
    const rcon = document.getElementById(`reconnect-${id}`);
    if (img)  { img.src = ''; img.style.display = 'none'; }
    if (ph)   ph.style.display   = 'flex';
    if (spin) spin.style.display = 'none';
    if (rcon) rcon.style.display = 'none';

    _syncStreamUI(id, false);
    _disableAIUI(id);

    if (currentFullscreenCamera === id) exitFullscreen();

    // Notify server (non-blocking; failure is non-fatal)
    fetch('/stop-camera-stream/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
        body: JSON.stringify({ camera_id: id })
    }).catch(err => console.warn('stopCameraStream (server):', err));

    showNotification(`â¹ï¸ Stream stopped â€” ${cfg.location_name}`, 'success');
}

// â”€â”€â”€ AI toggle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function toggleAI(cameraId) {
    const id  = sid(cameraId);
    const cfg = cameraConfigs[id];
    if (!cfg) return;

    if (!cfg.stream_active) {
        showNotification('âš ï¸ Start the stream before enabling AI', 'warn');
        return;
    }

    const newState = !cfg.ai_enabled;

    try {
        const res = await fetch('/toggle-camera-ai/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
            body: JSON.stringify({ camera_id: id, ai_enabled: newState })
        });

        let data = {};
        try { data = await res.json(); } catch (_) {}

        if (!res.ok) throw new Error(data.error || `Server returned ${res.status}`);

        cfg.ai_enabled = newState;
        _syncAIUI(id, newState);
        showNotification(
            newState ? `ğŸ¤– AI enabled â€” ${cfg.location_name}` : `â¹ï¸ AI disabled â€” ${cfg.location_name}`,
            'success'
        );
    } catch (err) {
        console.error('toggleAI:', err);
        showNotification(`âŒ AI toggle failed: ${err.message}`, 'error');
    }
}

// â”€â”€â”€ Global controls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function startAllStreams() {
    showNotification('ğŸš€ Starting all camera streamsâ€¦', 'info');
    for (const id of Object.keys(cameraConfigs)) {
        const cfg = cameraConfigs[id];
        if (!cfg.stream_active && cfg.status === 'Active') {
            await startCameraStream(id);
            await sleep(600);
        }
    }
}

async function stopAllStreams() {
    showNotification('â¹ï¸ Stopping all streamsâ€¦', 'info');
    for (const id of Object.keys(cameraConfigs)) {
        if (cameraConfigs[id].stream_active) await stopCameraStream(id);
    }
}

async function startAllAI() {
    showNotification('ğŸ¤– Starting AI on all active streamsâ€¦', 'info');
    for (const id of Object.keys(cameraConfigs)) {
        const cfg = cameraConfigs[id];
        if (cfg.stream_active && !cfg.ai_enabled) {
            await toggleAI(id);
            await sleep(300);
        }
    }
}

async function stopAllAI() {
    showNotification('â¹ï¸ Stopping AI on all camerasâ€¦', 'info');
    for (const id of Object.keys(cameraConfigs)) {
        if (cameraConfigs[id].ai_enabled) await toggleAI(id);
    }
}

// â”€â”€â”€ Fullscreen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function toggleFullscreen(cameraId) {
    const id = sid(cameraId);
    currentFullscreenCamera === id ? exitFullscreen() : enterFullscreen(id);
}

function enterFullscreen(cameraId) {
    const id  = sid(cameraId);
    const cfg = cameraConfigs[id];
    if (!cfg?.stream_active) {
        showNotification('âš ï¸ Start the stream before going fullscreen', 'warn');
        return;
    }
    currentFullscreenCamera = id;

    const fsCont  = document.getElementById('fullscreen-container');
    const fsImg   = document.getElementById('fullscreen-img');
    const fsLabel = document.getElementById('fullscreen-label');

    fsImg.src           = buildStreamUrl(id);
    fsLabel.textContent = `ğŸ“¹ ${cfg.location_name}`;
    fsCont.style.display = 'flex';
    document.body.style.overflow = 'hidden';
}

function exitFullscreen() {
    const fsCont = document.getElementById('fullscreen-container');
    const fsImg  = document.getElementById('fullscreen-img');
    fsImg.src = '';
    fsCont.style.display = 'none';
    document.body.style.overflow = '';
    currentFullscreenCamera = null;
}

// â”€â”€â”€ Modal: Add / Edit / Delete â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function openAddCameraModal() {
    isEditing = false;
    currentConfigCamera = null;
    document.getElementById('configTitle').textContent = 'Add New Camera';
    document.getElementById('configLocationName').value = '';
    document.getElementById('configIpAddress').value = '';
    document.getElementById('configStatus').value = 'Active';
    document.getElementById('deleteCameraBtn').classList.add('hidden');
    document.getElementById('configModal').style.display = 'block';
}

function openEditModal(cameraId) {
    const id  = sid(cameraId);
    const cfg = cameraConfigs[id];
    if (!cfg) return;
    isEditing = true;
    currentConfigCamera = id;
    document.getElementById('configTitle').textContent = `Edit Camera ${id}`;
    document.getElementById('configLocationName').value = cfg.location_name;
    document.getElementById('configIpAddress').value = cfg.ip_address;
    document.getElementById('configStatus').value = cfg.status;
    document.getElementById('deleteCameraBtn').classList.remove('hidden');
    document.getElementById('configModal').style.display = 'block';
}

function closeConfigModal() {
    document.getElementById('configModal').style.display = 'none';
    currentConfigCamera = null;
    isEditing = false;
}

async function saveCameraConfig() {
    const locationName = document.getElementById('configLocationName').value.trim();
    const ipAddress    = document.getElementById('configIpAddress').value.trim();
    const status       = document.getElementById('configStatus').value;

    if (!locationName || !ipAddress) {
        showNotification('âŒ Location name and IP/URL are required', 'error');
        return;
    }

    try {
        const sb = getSupabaseClient();
        if (isEditing && currentConfigCamera) {
            const { error } = await sb.from('cctv')
                .update({ location_name: locationName, ip_address: ipAddress, status, updated_at: new Date().toISOString() })
                .eq('camera_id', currentConfigCamera);
            if (error) throw error;
            showNotification('âœ… Camera updated!', 'success');
        } else {
            const { error } = await sb.from('cctv')
                .insert([{ location_name: locationName, ip_address: ipAddress, status }]);
            if (error) throw error;
            showNotification('âœ… Camera added!', 'success');
        }
        closeConfigModal();
        await loadCamerasFromDatabase();
    } catch (err) {
        console.error('saveCameraConfig:', err);
        showNotification('âŒ Failed to save configuration', 'error');
    }
}

async function deleteCamera() {
    if (!currentConfigCamera || !confirm('Delete this camera?')) return;
    try {
        const id = sid(currentConfigCamera);
        if (cameraConfigs[id]?.stream_active) await stopCameraStream(id);
        const sb = getSupabaseClient();
        const { error } = await sb.from('cctv').delete().eq('camera_id', id);
        if (error) throw error;
        showNotification('ğŸ—‘ï¸ Camera deleted', 'success');
        closeConfigModal();
        await loadCamerasFromDatabase();
    } catch (err) {
        console.error('deleteCamera:', err);
        showNotification('âŒ Failed to delete camera', 'error');
    }
}

// â”€â”€â”€ Mock Test â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function runMockTest(cameraId) {
    const id  = sid(cameraId);
    const cfg = cameraConfigs[id];
    if (!cfg) return;

    // Confirm before sending
    const confirmed = confirm(
        `ğŸ§ª Mock Test for: ${cfg.location_name}\n\n` +
        `Camera ID : ${id}\n` +
        `IP Address: ${cfg.ip_address}\n` +
        `Status    : ${cfg.status}\n\n` +
        `This will send a FAKE crash alert to all admins.\nContinue?`
    );
    if (!confirmed) return;

    // Disable button to prevent spam
    const btn = event.currentTarget;
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-hourglass-split mr-1"></i>Sendingâ€¦';

    try {
        const res = await fetch('/mock-test-camera/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                camera_id:   id,
                camera_name: cfg.location_name,
                ip_address:  cfg.ip_address
            })
        });

        const data = await res.json();

        if (!res.ok) throw new Error(data.error || `Server returned ${res.status}`);

        showNotification(
            `ğŸ§ª Mock alert sent! Notified ${data.details.admins_notified} admin(s) for ${cfg.location_name}`,
            'success'
        );

    } catch (err) {
        console.error('runMockTest:', err);
        showNotification(`âŒ Mock test failed: ${err.message}`, 'error');
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-bug mr-1"></i>Mock Test';
    }
}

// â”€â”€â”€ Supabase Realtime â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function setupRealtimeUpdates() {
    const sb = getSupabaseClient();
    if (!sb) return;
    sb.channel('cctv-changes')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'cctv' }, () => {
          loadCamerasFromDatabase();
      })
      .subscribe();
}

// â”€â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

document.addEventListener('DOMContentLoaded', async () => {
    await loadCamerasFromDatabase();
    setupRealtimeUpdates();

    // Escape exits fullscreen
    document.addEventListener('keydown', e => {
        if (e.key === 'Escape' && currentFullscreenCamera) exitFullscreen();
    });

    // Click outside modal â†’ close
    document.getElementById('configModal').addEventListener('click', function(e) {
        if (e.target === this) closeConfigModal();
    });

    // On tab return, re-stamp fullscreen img so it doesn't go blank
    document.addEventListener('visibilitychange', () => {
        if (!document.hidden && currentFullscreenCamera) {
            const cfg = cameraConfigs[currentFullscreenCamera];
            if (cfg?.stream_active) {
                document.getElementById('fullscreen-img').src = buildStreamUrl(currentFullscreenCamera);
            }
        }
    });
});
</script>
{% endblock %}
