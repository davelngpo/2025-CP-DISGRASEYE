{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}CCTV Monitoring | DisgrasEye{% endblock %}

{% block extra_head %}
<style>
    .camera-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 20px;
    }
    .camera-feed {
        background: #000;
        border-radius: 12px;
        overflow: hidden;
        position: relative;
        border: 2px solid #334155;
        transition: all 0.3s ease;
    }
    .camera-feed:hover {
        border-color: #38BDF8;
        transform: translateY(-2px);
    }
    .camera-status {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        z-index: 10;
    }
    .ai-status {
        position: absolute;
        top: 10px;
        left: 10px;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        z-index: 10;
    }
    .ai-active {
        background: rgba(34, 197, 94, 0.8);
    }
    .ai-inactive {
        background: rgba(107, 114, 128, 0.8);
    }
    .status-active {
        background: rgba(34, 197, 94, 0.8);
    }
    .status-offline {
        background: rgba(239, 68, 68, 0.8);
    }
    .status-maintenance {
        background: rgba(251, 191, 36, 0.8);
    }
    
    /* Modal Styles */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        z-index: 1000;
        backdrop-filter: blur(5px);
    }
    .modal-content {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: #1E293B;
        border: 2px solid #334155;
        border-radius: 12px;
        padding: 2rem;
        width: 90%;
        max-width: 500px;
        max-height: 90vh;
        overflow-y: auto;
    }
    
    /* Fullscreen styles */
    #fullscreen-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: black;
        z-index: 9999;
        display: none;
    }
    #fullscreen-video {
        width: 100%;
        height: 100%;
        object-fit: contain;
    }
    #fullscreen-controls {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.8);
        padding: 10px 20px;
        border-radius: 25px;
        z-index: 10000;
        display: flex;
        gap: 10px;
        backdrop-filter: blur(10px);
    }
    
    /* Global controls */
    .global-controls {
        background: #1E293B;
        border: 2px solid #334155;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }
    
    /* Loading animation */
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
    .loading {
        animation: pulse 1.5s ease-in-out infinite;
    }
    
    /* Status indicators */
    .status-dot {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        margin-right: 6px;
    }
</style>
{% endblock %}

{% block content %}
<div class="mb-6">
    <h2 class="text-2xl font-bold flex items-center gap-2">
        <i class="bi bi-camera-video text-sky"></i> Live CCTV Monitoring
    </h2>
    <p class="text-gray-400 mt-2">Real-time surveillance feeds with individual and global AI controls</p>
</div>

<!-- Global Controls -->
<div class="global-controls">
    <div class="flex flex-wrap justify-between items-center gap-4">
        <div>
            <h3 class="text-lg font-bold flex items-center gap-2 text-white">
                <i class="bi bi-sliders text-sky"></i> Global Controls
            </h3>
            <p class="text-sm text-gray-400">Manage all cameras at once</p>
        </div>
        <div class="flex flex-wrap gap-4">
            <button onclick="startAllStreams()" class="bg-sky hover:bg-sky/80 text-white px-6 py-3 rounded-lg transition flex items-center gap-2 font-semibold">
                <i class="bi bi-play-circle"></i> Start All Streams
            </button>
            <button onclick="stopAllStreams()" class="bg-alert hover:bg-red-700 text-white px-6 py-3 rounded-lg transition flex items-center gap-2 font-semibold">
                <i class="bi bi-stop-circle"></i> Stop All Streams
            </button>
            <button onclick="startAllAI()" class="bg-greenlight hover:bg-green-600 text-white px-6 py-3 rounded-lg transition flex items-center gap-2 font-semibold">
                <i class="bi bi-cpu"></i> Start All AI
            </button>
            <button onclick="stopAllAI()" class="bg-gold hover:bg-yellow-600 text-gray-900 px-6 py-3 rounded-lg transition flex items-center gap-2 font-semibold">
                <i class="bi bi-pause-circle"></i> Stop All AI
            </button>
        </div>
    </div>
</div>

<!-- Camera Grid -->
<div class="camera-grid mb-8" id="camerasGrid">
    <!-- Cameras will be loaded dynamically from database -->
    <div class="text-center py-12">
        <div class="animate-spin h-8 w-8 border-2 border-sky border-t-transparent rounded-full mx-auto mb-4"></div>
        <p class="text-gray-400">Loading cameras from database...</p>
    </div>
</div>

<!-- Configuration Modal -->
<div id="configModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header mb-4">
            <h3 class="text-xl font-bold text-white" id="configTitle">Configure Camera</h3>
            <button onclick="closeConfigModal()" class="text-gray-400 hover:text-white text-2xl">
                &times;
            </button>
        </div>
        
        <div class="space-y-4">
            <div>
                <label class="block text-sm text-gray-400 mb-2">Location Name</label>
                <input type="text" id="configLocationName" 
                       class="w-full px-3 py-2 bg-darkbg rounded-lg border border-gray-600 text-white focus:border-sky focus:ring-1 focus:ring-sky transition"
                       placeholder="Enter location name">
            </div>
            
            <div>
                <label class="block text-sm text-gray-400 mb-2">IP Address / RTSP URL</label>
                <input type="text" id="configIpAddress" 
                       class="w-full px-3 py-2 bg-darkbg rounded-lg border border-gray-600 text-white focus:border-sky focus:ring-1 focus:ring-sky transition"
                       placeholder="rtsp://ip:port/stream">
                
                <div class="mt-3 p-3 bg-darkbg rounded-lg border border-gray-600">
                    <p class="text-sm text-gray-400 mb-2">Common RTSP Formats:</p>
                    <ul class="text-xs text-gray-500 space-y-1">
                        <li>‚Ä¢ <code class="bg-black px-1 rounded">rtsp://192.168.1.100:554/stream</code></li>
                        <li>‚Ä¢ <code class="bg-black px-1 rounded">http://192.168.1.100:8080/video</code></li>
                        <li>‚Ä¢ <code class="bg-black px-1 rounded">rtsp://username:password@ip:port/stream</code></li>
                    </ul>
                </div>
            </div>
            
            <div>
                <label class="block text-sm text-gray-400 mb-2">Status</label>
                <select id="configStatus" 
                        class="w-full px-3 py-2 bg-darkbg rounded-lg border border-gray-600 text-white focus:border-sky focus:ring-1 focus:ring-sky transition">
                    <option value="Active">Active</option>
                    <option value="Offline">Offline</option>
                    <option value="Maintenance">Maintenance</option>
                </select>
            </div>
            
            <div class="flex gap-3 mt-6">
                <button onclick="saveCameraConfig()" class="flex-1 bg-sky hover:bg-sky/80 text-white py-3 rounded-lg transition font-semibold">
                    <i class="bi bi-check-lg mr-2"></i> Save Configuration
                </button>
                <button onclick="deleteCamera()" id="deleteCameraBtn" class="flex-1 bg-alert hover:bg-red-700 text-white py-3 rounded-lg transition font-semibold hidden">
                    <i class="bi bi-trash mr-2"></i> Delete Camera
                </button>
                <button onclick="closeConfigModal()" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white py-3 rounded-lg transition font-semibold">
                    <i class="bi bi-x-lg mr-2"></i> Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add Camera Button -->
<div class="fixed bottom-6 right-6 z-50">
    <button onclick="openAddCameraModal()" class="bg-greenlight hover:bg-green-600 text-white p-4 rounded-full shadow-lg transition transform hover:scale-110">
        <i class="bi bi-plus-lg text-2xl"></i>
    </button>
</div>

<!-- Fullscreen Container -->
<div id="fullscreen-container">
    <img id="fullscreen-video" src="" alt="Fullscreen Video">
    <div id="fullscreen-controls">
        <button onclick="exitFullscreen()" class="bg-alert hover:bg-red-700 text-white px-4 py-2 rounded-lg transition flex items-center gap-2">
            <i class="bi bi-fullscreen-exit"></i> Exit Fullscreen
        </button>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Global variables
let cctvSupabase = null;
let cameraConfigs = {};
let currentConfigCamera = null;
let currentFullscreenCamera = null;
let isEditing = false;

// Initialize Supabase client
function getSupabaseClient() {
    if (!cctvSupabase) {
        // Try to get from window (set by base.html)
        if (window._supabase) {
            cctvSupabase = window._supabase;
        } else {
            // Initialize directly if needed
            const supabaseUrl = "{{ SUPABASE_URL|default:'https://ivigoibymrcvaftgayqv.supabase.co' }}";
            const supabaseAnonKey = "{{ SUPABASE_ANON_KEY|default:'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml2aWdvaWJ5bXJjdmFmdGdheXF2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5MDI2MDgsImV4cCI6MjA3OTQ3ODYwOH0.c3MoFVyNGXwZ3zqtgWz62Du0WfA7pranyAXDwRpy5sw' }}";
            
            cctvSupabase = supabase.createClient(supabaseUrl, supabaseAnonKey);
        }
    }
    return cctvSupabase;
}

// Load cameras from database
async function loadCamerasFromDatabase() {
    try {
        const supabase = getSupabaseClient();
        if (!supabase) {
            showNotification('‚ùå Supabase client not available', 'error');
            return;
        }

        const { data: cameras, error } = await supabase
            .from('cctv')
            .select('*')
            .order('camera_id', { ascending: true });

        if (error) {
            throw error;
        }

        // Reset camera configs
        cameraConfigs = {};
        
        // Update the cameras grid
        const camerasGrid = document.getElementById('camerasGrid');
        
        if (cameras && cameras.length > 0) {
            camerasGrid.innerHTML = cameras.map(camera => {
                const cameraId = `camera-${camera.camera_id}`;
                
                // Store in cameraConfigs
                cameraConfigs[camera.camera_id] = {
                    camera_id: camera.camera_id,
                    location_name: camera.location_name,
                    ip_address: camera.ip_address,
                    status: camera.status,
                    ai_enabled: false,
                    stream_active: false,
                    stream_url: '',
                    last_updated: camera.updated_at
                };

                // Determine status color
                let statusClass = 'status-active';
                let statusText = 'LIVE';
                let bgGradient = 'from-sky/20 to-alert/20';
                
                if (camera.status === 'Offline') {
                    statusClass = 'status-offline';
                    statusText = 'OFFLINE';
                    bgGradient = 'from-gray-600/20 to-gray-800/20';
                } else if (camera.status === 'Maintenance') {
                    statusClass = 'status-maintenance';
                    statusText = 'MAINTENANCE';
                    bgGradient = 'from-gold/20 to-yellow-600/20';
                }

                return `
                <div class="camera-feed" id="camera-${camera.camera_id}">
                    <div class="camera-status ${statusClass}">${statusText}</div>
                    <div id="aiStatus-${camera.camera_id}" class="ai-status ai-inactive">AI INACTIVE</div>
                    
                    <div class="aspect-video bg-gradient-to-br ${bgGradient} flex items-center justify-center">
                        <img id="video-${camera.camera_id}" src="" class="hidden w-full h-full object-cover camera-video">
                        <div id="placeholder-${camera.camera_id}" class="text-center text-white">
                            <i class="bi bi-camera-video text-4xl mb-2 opacity-50"></i>
                            <p class="font-semibold" id="cameraName-${camera.camera_id}">${camera.location_name}</p>
                            <p class="text-sm opacity-70">${camera.ip_address}</p>
                            <p class="text-xs opacity-50 mt-1">ID: ${camera.camera_id}</p>
                        </div>
                    </div>
                    
                    <div class="p-4 bg-[#1E293B]">
                        <div class="flex justify-between items-center gap-2">
                            <span class="text-sm text-gray-400" id="cameraLabel-${camera.camera_id}">${camera.location_name}</span>
                            <div class="flex gap-2">
                                <button onclick="openEditModal(${camera.camera_id})" class="bg-gold hover:bg-yellow-600 text-gray-900 px-3 py-1 rounded text-sm transition">
                                    <i class="bi bi-gear mr-1"></i> Edit
                                </button>
                                <button onclick="toggleStream(${camera.camera_id})" class="bg-sky hover:bg-sky/80 text-white px-3 py-1 rounded text-sm transition">
                                    <i class="bi bi-play-circle mr-1"></i> Start Stream
                                </button>
                                <button id="aiToggle-${camera.camera_id}" onclick="toggleAI(${camera.camera_id})" class="bg-greenlight hover:bg-green-600 text-white px-3 py-1 rounded text-sm transition" disabled>
                                    <i class="bi bi-cpu mr-1"></i> Start AI
                                </button>
                                <button onclick="toggleFullscreen(${camera.camera_id})" class="bg-purple-500 hover:bg-purple-600 text-white px-3 py-1 rounded text-sm transition">
                                    <i class="bi bi-arrows-fullscreen mr-1"></i> 
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        } else {
            camerasGrid.innerHTML = `
                <div class="col-span-full text-center py-12">
                    <i class="bi bi-camera-video-off text-4xl text-gray-500 mb-4"></i>
                    <p class="text-gray-400">No cameras configured</p>
                    <p class="text-sm text-gray-500 mt-2">Click the + button to add a camera</p>
                </div>
            `;
        }
    } catch (error) {
        console.error('Error loading cameras:', error);
        showNotification('‚ùå Failed to load cameras from database', 'error');
    }
}

// Open modal for adding new camera
function openAddCameraModal() {
    isEditing = false;
    currentConfigCamera = null;
    
    document.getElementById('configTitle').textContent = 'Add New Camera';
    document.getElementById('configLocationName').value = '';
    document.getElementById('configIpAddress').value = '';
    document.getElementById('configStatus').value = 'Active';
    document.getElementById('deleteCameraBtn').classList.add('hidden');
    document.getElementById('configModal').style.display = 'block';
}

// Open modal for editing camera
function openEditModal(cameraId) {
    isEditing = true;
    currentConfigCamera = cameraId;
    const config = cameraConfigs[cameraId];
    
    if (!config) return;
    
    document.getElementById('configTitle').textContent = `Edit Camera ${cameraId}`;
    document.getElementById('configLocationName').value = config.location_name;
    document.getElementById('configIpAddress').value = config.ip_address;
    document.getElementById('configStatus').value = config.status;
    document.getElementById('deleteCameraBtn').classList.remove('hidden');
    document.getElementById('configModal').style.display = 'block';
}

// Save camera configuration
async function saveCameraConfig() {
    const locationName = document.getElementById('configLocationName').value.trim();
    const ipAddress = document.getElementById('configIpAddress').value.trim();
    const status = document.getElementById('configStatus').value;

    if (!locationName || !ipAddress) {
        showNotification('‚ùå Please enter both location name and IP address', 'error');
        return;
    }

    try {
        const supabase = getSupabaseClient();
        
        if (isEditing && currentConfigCamera) {
            // Update existing camera
            const { error } = await supabase
                .from('cctv')
                .update({
                    location_name: locationName,
                    ip_address: ipAddress,
                    status: status,
                    updated_at: new Date().toISOString()
                })
                .eq('camera_id', currentConfigCamera);

            if (error) throw error;
            
            showNotification('‚úÖ Camera updated successfully!', 'success');
        } else {
            // Add new camera
            const { data, error } = await supabase
                .from('cctv')
                .insert([
                    {
                        location_name: locationName,
                        ip_address: ipAddress,
                        status: status
                    }
                ])
                .select();

            if (error) throw error;
            
            showNotification('‚úÖ Camera added successfully!', 'success');
        }

        closeConfigModal();
        await loadCamerasFromDatabase();
        
    } catch (error) {
        console.error('Error saving camera:', error);
        showNotification('‚ùå Failed to save camera configuration', 'error');
    }
}

// Delete camera
async function deleteCamera() {
    if (!currentConfigCamera || !confirm('Are you sure you want to delete this camera?')) {
        return;
    }

    try {
        const supabase = getSupabaseClient();
        
        const { error } = await supabase
            .from('cctv')
            .delete()
            .eq('camera_id', currentConfigCamera);

        if (error) throw error;
        
        // Stop stream if active
        if (cameraConfigs[currentConfigCamera]?.stream_active) {
            await stopCameraStream(currentConfigCamera);
        }
        
        showNotification('üóëÔ∏è Camera deleted successfully!', 'success');
        closeConfigModal();
        await loadCamerasFromDatabase();
        
    } catch (error) {
        console.error('Error deleting camera:', error);
        showNotification('‚ùå Failed to delete camera', 'error');
    }
}

// Global Control Functions
async function startAllStreams() {
    showNotification('üöÄ Starting all camera streams...', 'info');
    
    for (const cameraId of Object.keys(cameraConfigs)) {
        if (!cameraConfigs[cameraId].stream_active && cameraConfigs[cameraId].status === 'Active') {
            await startCameraStream(parseInt(cameraId));
            await new Promise(resolve => setTimeout(resolve, 1000));
        }
    }
}

async function stopAllStreams() {
    showNotification('‚èπÔ∏è Stopping all camera streams...', 'info');
    
    for (const cameraId of Object.keys(cameraConfigs)) {
        if (cameraConfigs[cameraId].stream_active) {
            await stopCameraStream(parseInt(cameraId));
        }
    }
}

async function startAllAI() {
    showNotification('ü§ñ Starting AI on all active streams...', 'info');
    
    for (const cameraId of Object.keys(cameraConfigs)) {
        if (cameraConfigs[cameraId].stream_active && !cameraConfigs[cameraId].ai_enabled) {
            await toggleAI(parseInt(cameraId));
            await new Promise(resolve => setTimeout(resolve, 500));
        }
    }
}

async function stopAllAI() {
    showNotification('‚èπÔ∏è Stopping AI on all cameras...', 'info');
    
    for (const cameraId of Object.keys(cameraConfigs)) {
        if (cameraConfigs[cameraId].ai_enabled) {
            await toggleAI(parseInt(cameraId));
        }
    }
}

// Individual Camera Functions
async function toggleStream(cameraId) {
    const config = cameraConfigs[cameraId];
    
    if (!config) {
        showNotification('‚ùå Camera configuration not found', 'error');
        return;
    }
    
    if (config.stream_active) {
        await stopCameraStream(cameraId);
    } else {
        await startCameraStream(cameraId);
    }
}

async function startCameraStream(cameraId) {
    const config = cameraConfigs[cameraId];
    
    if (!config || config.status !== 'Active') {
        showNotification('‚ùå Cannot start stream for offline or maintenance cameras', 'error');
        return;
    }

    try {
        const response = await fetch('/start-camera-stream/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                camera_id: cameraId,
                rtsp_url: config.ip_address,
                camera_name: config.location_name
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            config.stream_active = true;
            config.stream_url = `/camera-stream/${cameraId}/`;
            
            // Update UI
            const videoElement = document.getElementById(`video-${cameraId}`);
            const placeholder = document.getElementById(`placeholder-${cameraId}`);
            
            if (videoElement && placeholder) {
                videoElement.src = config.stream_url + '?t=' + new Date().getTime();
                videoElement.classList.remove('hidden');
                placeholder.classList.add('hidden');
                
                videoElement.onerror = function() {
                    console.error(`‚ùå Stream failed for ${config.location_name}`);
                    showNotification(`‚ùå Failed to connect to ${config.location_name}`, 'error');
                    stopCameraStream(cameraId);
                };
            }
            
            // Update camera status in database
            await updateCameraStatus(cameraId, 'Active');
            
            showNotification(`üé• Live stream started for ${config.location_name}`, 'success');
            updateCameraUI(cameraId);
            
        } else {
            throw new Error(data.error || 'Failed to start stream');
        }
    } catch (error) {
        console.error('Error starting stream:', error);
        showNotification(`‚ùå Failed to start stream for ${config.location_name}: ${error.message}`, 'error');
    }
}

async function stopCameraStream(cameraId) {
    const config = cameraConfigs[cameraId];
    
    if (!config) return;

    try {
        const response = await fetch('/stop-camera-stream/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                camera_id: cameraId
            })
        });
        
        if (response.ok) {
            config.stream_active = false;
            config.ai_enabled = false;
            config.stream_url = '';
            
            // Update UI
            const videoElement = document.getElementById(`video-${cameraId}`);
            const placeholder = document.getElementById(`placeholder-${cameraId}`);
            
            if (videoElement && placeholder) {
                videoElement.src = '';
                videoElement.classList.add('hidden');
                placeholder.classList.remove('hidden');
            }
            
            updateCameraUI(cameraId);
            showNotification(`‚èπÔ∏è Stream stopped for ${config.location_name}`, 'success');
        }
    } catch (error) {
        console.error('Error stopping stream:', error);
    }
}

async function toggleAI(cameraId) {
    const config = cameraConfigs[cameraId];
    
    if (!config) {
        showNotification('‚ùå Camera configuration not found', 'error');
        return;
    }
    
    if (!config.stream_active) {
        showNotification('‚ö†Ô∏è Please start the stream first before enabling AI', 'error');
        return;
    }
    
    try {
        const response = await fetch('/toggle-camera-ai/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                camera_id: cameraId,
                ai_enabled: !config.ai_enabled
            })
        });
        
        if (response.ok) {
            config.ai_enabled = !config.ai_enabled;
            updateCameraUI(cameraId);
            
            showNotification(
                config.ai_enabled ? 
                `ü§ñ AI enabled for ${config.location_name}` : 
                `‚èπÔ∏è AI disabled for ${config.location_name}`,
                'success'
            );
            
            // Start status updates if AI is enabled
            if (config.ai_enabled) {
                startStatusUpdates(cameraId);
            }
        }
    } catch (error) {
        console.error('Error toggling AI:', error);
        showNotification(`‚ùå Failed to toggle AI for ${config.location_name}`, 'error');
    }
}

// Update camera status in database
async function updateCameraStatus(cameraId, status) {
    try {
        const supabase = getSupabaseClient();
        const { error } = await supabase
            .from('cctv')
            .update({
                status: status,
                updated_at: new Date().toISOString()
            })
            .eq('camera_id', cameraId);

        if (error) {
            console.error('Error updating camera status:', error);
        } else {
            // Update local config
            if (cameraConfigs[cameraId]) {
                cameraConfigs[cameraId].status = status;
                cameraConfigs[cameraId].last_updated = new Date().toISOString();
                updateCameraUI(cameraId);
            }
        }
    } catch (error) {
        console.error('Error updating camera status:', error);
    }
}

// Update camera UI
function updateCameraUI(cameraId) {
    const config = cameraConfigs[cameraId];
    
    if (!config) return;
    
    // Update AI status
    const aiStatus = document.getElementById(`aiStatus-${cameraId}`);
    const aiToggle = document.getElementById(`aiToggle-${cameraId}`);
    
    if (aiStatus) {
        aiStatus.textContent = config.ai_enabled ? 'AI ACTIVE' : 'AI INACTIVE';
        aiStatus.className = `ai-status ${config.ai_enabled ? 'ai-active' : 'ai-inactive'}`;
    }
    
    if (aiToggle) {
        aiToggle.innerHTML = config.ai_enabled ? 
            '<i class="bi bi-pause-circle mr-1"></i> Stop AI' : 
            '<i class="bi bi-play-circle mr-1"></i> Start AI';
        aiToggle.className = config.ai_enabled ?
            'bg-alert hover:bg-red-700 text-white px-3 py-1 rounded text-sm transition' :
            'bg-greenlight hover:bg-green-600 text-white px-3 py-1 rounded text-sm transition';
            
        // Enable/disable AI button based on stream status
        aiToggle.disabled = !config.stream_active;
        if (!config.stream_active) {
            aiToggle.classList.add('opacity-50', 'cursor-not-allowed');
        } else {
            aiToggle.classList.remove('opacity-50', 'cursor-not-allowed');
        }
    }
    
    // Update stream control button
    const streamToggle = document.querySelector(`[onclick="toggleStream(${cameraId})"]`);
    if (streamToggle) {
        streamToggle.innerHTML = config.stream_active ? 
            '<i class="bi bi-stop-circle mr-1"></i> Stop Stream' : 
            '<i class="bi bi-play-circle mr-1"></i> Start Stream';
        streamToggle.className = config.stream_active ?
            'bg-alert hover:bg-red-700 text-white px-3 py-1 rounded text-sm transition' :
            'bg-sky hover:bg-sky/80 text-white px-3 py-1 rounded text-sm transition';
    }
    
    // Update camera status indicator
    const statusElement = document.querySelector(`#camera-${cameraId} .camera-status`);
    if (statusElement) {
        let statusClass = 'status-active';
        let statusText = 'LIVE';
        
        if (config.status === 'Offline') {
            statusClass = 'status-offline';
            statusText = 'OFFLINE';
        } else if (config.status === 'Maintenance') {
            statusClass = 'status-maintenance';
            statusText = 'MAINTENANCE';
        }
        
        statusElement.className = `camera-status ${statusClass}`;
        statusElement.textContent = statusText;
    }
}

// Modal functions
function closeConfigModal() {
    document.getElementById('configModal').style.display = 'none';
    currentConfigCamera = null;
    isEditing = false;
}

// Fullscreen functions
function toggleFullscreen(cameraId) {
    if (currentFullscreenCamera) {
        exitFullscreen();
    } else {
        enterFullscreen(cameraId);
    }
}

function enterFullscreen(cameraId) {
    const videoElement = document.getElementById(`video-${cameraId}`);
    const config = cameraConfigs[cameraId];
    
    if (videoElement && videoElement.src && config?.stream_active) {
        currentFullscreenCamera = cameraId;
        
        const fullscreenContainer = document.getElementById('fullscreen-container');
        const fullscreenVideo = document.getElementById('fullscreen-video');
        
        fullscreenVideo.src = videoElement.src;
        fullscreenContainer.style.display = 'block';
        
        document.querySelectorAll('.camera-feed').forEach(feed => {
            feed.style.opacity = '0.3';
        });
    } else {
        showNotification('‚ö†Ô∏è Please start the stream first before entering fullscreen', 'error');
    }
}

function exitFullscreen() {
    const fullscreenContainer = document.getElementById('fullscreen-container');
    const fullscreenVideo = document.getElementById('fullscreen-video');
    
    fullscreenContainer.style.display = 'none';
    fullscreenVideo.src = '';
    
    document.querySelectorAll('.camera-feed').forEach(feed => {
        feed.style.opacity = '1';
    });
    
    currentFullscreenCamera = null;
}

// Utility functions
function showNotification(message, type) {
    // Remove existing notifications
    document.querySelectorAll('.notification').forEach(n => n.remove());
    
    const notification = document.createElement('div');
    notification.className = `notification fixed top-4 right-4 p-4 rounded-lg ${
        type === 'success' ? 'bg-greenlight' : 
        type === 'error' ? 'bg-alert' : 
        type === 'info' ? 'bg-sky' : 'bg-gold'
    } text-white z-50 shadow-lg transition-all duration-300`;
    notification.innerHTML = `
        <div class="flex items-center gap-2">
            <i class="bi ${
                type === 'success' ? 'bi-check-circle' : 
                type === 'error' ? 'bi-exclamation-triangle' : 
                type === 'info' ? 'bi-info-circle' : 'bi-exclamation-circle'
            }"></i>
            <span>${message}</span>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => notification.remove(), 300);
    }, 4000);
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Setup real-time updates
function setupRealtimeUpdates() {
    const supabase = getSupabaseClient();
    if (!supabase) return;

    supabase
        .channel('cctv-changes')
        .on(
            'postgres_changes',
            {
                event: '*',
                schema: 'public',
                table: 'cctv'
            },
            (payload) => {
                console.log('CCTV data changed:', payload);
                loadCamerasFromDatabase();
            }
        )
        .subscribe();
}

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', async function() {
    // Load cameras from database
    await loadCamerasFromDatabase();
    
    // Setup real-time updates
    setupRealtimeUpdates();
    
    // Handle ESC key to exit fullscreen
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && currentFullscreenCamera) {
            exitFullscreen();
        }
    });
    
    // Close modal when clicking outside
    document.getElementById('configModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeConfigModal();
        }
    });
});
</script>
{% endblock %}