{% extends 'dashboard/base.html' %}

{% block title %}Live Detection | DisgrasEye{% endblock %}

{% block extra_head %}
<style>
    .alert-crash {
        background: linear-gradient(45deg, #EF4444, #DC2626);
        color: white;
        border: none;
        animation: pulse 1s infinite;
    }
    .alert-safe {
        background: linear-gradient(45deg, #22C55E, #16A34A);
        color: white;
        border: none;
    }
    .alert-error {
        background: linear-gradient(45deg, #F59E0B, #D97706);
        color: white;
        border: none;
    }
    .alert-warning {
        background: linear-gradient(45deg, #FCD34D, #FBBF24);
        color: black;
        border: none;
    }
    
    .connection-status {
        padding: 10px;
        border-radius: 5px;
        margin: 10px 0;
        font-weight: bold;
        text-align: center;
    }
    .connected { background: #22C55E; }
    .disconnected { background: #EF4444; }
    .connecting { background: #FCD34D; color: black; }
    
    .stats-panel {
        background: #1E293B;
        border-radius: 8px;
        padding: 15px;
        margin: 10px 0;
        border: 1px solid #334155;
    }
    .stat-value {
        font-size: 1.2em;
        font-weight: bold;
        color: #38BDF8;
    }
    
    .video-player {
        width: 100%;
        border-radius: 12px;
        background: #000;
        min-height: 400px;
        border: 2px solid #334155;
        object-fit: cover;
    }
    
    .url-input-container {
        background: #1E293B;
        border: 1px solid #334155;
        border-radius: 8px;
        padding: 15px;
    }
    
    .placeholder-stream {
        background: linear-gradient(45deg, #1E293B, #334155);
        display: flex;
        align-items: center;
        justify-content: center;
        color: #64748B;
        font-size: 1.1em;
    }
</style>
{% endblock %}

{% block content %}
<div class="mb-6">
    <h2 class="text-2xl font-bold flex items-center gap-2">
        <i class="bi bi-broadcast text-sky"></i> Live Crash Detection Monitor
    </h2>
    <p class="text-gray-400 mt-2">Real-time AI-powered crash detection from any RTSP stream</p>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Left Column - Video Stream -->
    <div class="lg:col-span-2">
        <div class="bg-cardbg rounded-xl p-6 border border-gray-600">
            <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                <i class="bi bi-play-circle text-sky"></i> Live Feed
            </h3>
            
            <div class="connection-status disconnected" id="connectionStatus">
                <i class="fas fa-times-circle mr-2"></i> No RTSP URL configured
            </div>
            
            <div class="mt-4">
                <img id="videoStream" class="video-player placeholder-stream" src="" alt="Live Stream">
            </div>
            
            <div class="grid grid-cols-3 gap-4 mt-6">
                <div class="stats-panel text-center">
                    <div class="text-gray-400 text-sm">Latency</div>
                    <div class="stat-value" id="latencyValue">-- ms</div>
                </div>
                <div class="stats-panel text-center">
                    <div class="text-gray-400 text-sm">Frames Processed</div>
                    <div class="stat-value" id="framesValue">0</div>
                </div>
                <div class="stats-panel text-center">
                    <div class="text-gray-400 text-sm">Status</div>
                    <div class="stat-value" id="statusValue">
                        <span class="text-alert">üî¥ Offline</span>
                    </div>
                </div>
            </div>
            
            <div id="streamError" class="mt-6 p-4 bg-alert/20 border border-alert rounded-lg" style="display: none;">
                <h5 class="text-alert font-bold mb-2 flex items-center gap-2">
                    <i class="fas fa-exclamation-triangle"></i> Stream Connection Error
                </h5>
                <p id="errorDetails" class="text-graylight mb-3"></p>
                <button class="bg-gold hover:bg-gold/80 text-gray-900 px-4 py-2 rounded transition flex items-center gap-2" onclick="retryConnection()">
                    <i class="fas fa-sync-alt"></i> Retry Connection
                </button>
            </div>
        </div>
    </div>
    
    <!-- Right Column - Controls and Configuration -->
    <div class="space-y-6">
        <!-- RTSP URL Input Section -->
        <div class="url-input-container">
            <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                <i class="bi bi-input-cursor-text text-sky"></i> Stream Configuration
            </h3>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-2">RTSP Stream URL</label>
                    <input type="text" 
                           id="rtspUrlInput" 
                           placeholder="rtsp://192.168.1.100:554/stream"
                           class="w-full px-4 py-3 bg-darkbg border border-gray-600 rounded-lg text-white placeholder-gray-500 focus:border-sky focus:ring-1 focus:ring-sky transition"
                           value="rtsp://192.168.1.183:8080/h264.sdp">
                    <p class="text-xs text-gray-500 mt-2">
                        Supported: RTSP, HTTP, HTTPS streams
                    </p>
                </div>
                
                <!-- Quick Presets -->
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-2">Quick Presets:</label>
                    <div class="flex flex-wrap gap-2">
                        <button class="text-xs bg-darkbg hover:bg-sky/20 text-gray-300 px-3 py-1 rounded border border-gray-600 transition hover:border-sky"
                                onclick="setPresetUrl('rtsp://192.168.1.100:554/stream')">
                            Local IP Cam
                        </button>
                        <button class="text-xs bg-darkbg hover:bg-sky/20 text-gray-300 px-3 py-1 rounded border border-gray-600 transition hover:border-sky"
                                onclick="setPresetUrl('http://localhost:8080/video')">
                            Local Webcam
                        </button>
                        <button class="text-xs bg-darkbg hover:bg-sky/20 text-gray-300 px-3 py-1 rounded border border-gray-600 transition hover:border-sky"
                                onclick="setPresetUrl('rtsp://192.168.1.183:8080/h264.sdp')">
                            IP Webcam
                        </button>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="grid grid-cols-2 gap-2">
                    <button id="testConnectionBtn" 
                            class="w-full bg-gold hover:bg-gold/80 text-gray-900 py-3 px-4 rounded-lg transition flex items-center justify-center gap-2 font-semibold"
                            onclick="testConnection()">
                        <i class="bi bi-plug"></i> Test
                    </button>
                    <button id="saveUrlBtn" 
                            class="w-full bg-sky hover:bg-sky/80 text-white py-3 px-4 rounded-lg transition flex items-center justify-center gap-2 font-semibold"
                            onclick="saveRtspUrl()">
                        <i class="bi bi-check-lg"></i> Save
                    </button>
                </div>
            </div>
        </div>

        <!-- Detection Status -->
        <div class="bg-cardbg rounded-xl p-6 border border-gray-600">
            <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                <i class="bi bi-activity text-sky"></i> Detection Status
            </h3>
            
            <div id="statusAlert" class="p-4 rounded-lg border-2 border-gray-600">
                <h5 id="statusText" class="text-xl font-bold text-gray-400">‚ö™ READY</h5>
                <p id="statusDetails" class="text-graylight mt-2">Configure RTSP URL to begin monitoring</p>
            </div>
            
            <div class="controls mt-6 space-y-3">
                <button id="startBtn" class="w-full bg-greenlight hover:bg-greenlight/80 text-white py-3 rounded-lg transition flex items-center justify-center gap-2 font-semibold" onclick="startMonitoring()" disabled>
                    <i class="fas fa-play"></i> Start Monitoring
                </button>
                <button id="stopBtn" class="w-full bg-alert hover:bg-alert/80 text-white py-3 rounded-lg transition flex items-center justify-center gap-2 font-semibold" onclick="stopMonitoring()" disabled>
                    <i class="fas fa-stop"></i> Stop Monitoring
                </button>
            </div>
        </div>
        
        <!-- Current Stream Info -->
        <div class="bg-cardbg rounded-xl p-6 border border-gray-600">
            <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                <i class="bi bi-info-circle text-sky"></i> Stream Information
            </h3>
            
            <div class="space-y-3 text-sm">
                <div class="flex justify-between">
                    <span class="text-gray-400">Current URL:</span>
                    <span id="currentUrlDisplay" class="text-graylight font-mono text-xs">Not set</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-400">Connection:</span>
                    <span id="streamStatus" class="text-alert">Disconnected</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-400">Last Update:</span>
                    <span id="lastUpdate" class="text-graylight">--</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- How It Works Section -->
<div class="mt-8 bg-cardbg rounded-xl p-6 border border-gray-600">
    <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
        <i class="bi bi-question-circle text-sky"></i> Connection Tips
    </h3>
    
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
            <ul class="space-y-3">
                <li class="flex items-start gap-3">
                    <span class="text-sky text-lg">üîó</span>
                    <div>
                        <strong class="text-graylight">Check Network</strong>
                        <p class="text-gray-400 text-sm">Ensure your device and camera are on the same network</p>
                    </div>
                </li>
                <li class="flex items-start gap-3">
                    <span class="text-sky text-lg">üì±</span>
                    <div>
                        <strong class="text-graylight">IP Webcam App</strong>
                        <p class="text-gray-400 text-sm">Use IP Webcam app on Android with RTSP server enabled</p>
                    </div>
                </li>
                <li class="flex items-start gap-3">
                    <span class="text-sky text-lg">üîß</span>
                    <div>
                        <strong class="text-graylight">Firewall Settings</strong>
                        <p class="text-gray-400 text-sm">Check if firewall is blocking the connection</p>
                    </div>
                </li>
            </ul>
        </div>
        <div>
            <ul class="space-y-3">
                <li class="flex items-start gap-3">
                    <span class="text-sky text-lg">üåê</span>
                    <div>
                        <strong class="text-graylight">Port Forwarding</strong>
                        <p class="text-gray-400 text-sm">For remote access, configure port forwarding on router</p>
                    </div>
                </li>
                <li class="flex items-start gap-3">
                    <span class="text-sky text-lg">üìπ</span>
                    <div>
                        <strong class="text-graylight">Camera Settings</strong>
                        <p class="text-gray-400 text-sm">Verify RTSP is enabled in camera settings</p>
                    </div>
                </li>
                <li class="flex items-start gap-3">
                    <span class="text-sky text-lg">üîÑ</span>
                    <div>
                        <strong class="text-graylight">Restart Services</strong>
                        <p class="text-gray-400 text-sm">Try restarting camera and app if connection fails</p>
                    </div>
                </li>
            </ul>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    let isMonitoring = false;
    let streamRetries = 0;
    const maxRetries = 5;
    let statusUpdateInterval;
    let timestampInterval;
    let currentRtspUrl = '';
    
    // Load saved RTSP URL on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadSavedRtspUrl();
        updateTimestamp();
        
        // Auto-load the preset URL for testing
        setTimeout(() => {
            if (!currentRtspUrl) {
                setPresetUrl('rtsp://192.168.1.183:8080/h264.sdp');
            }
        }, 1000);
    });
    
    function loadSavedRtspUrl() {
        fetch("{% url 'get_rtsp_status' %}")
            .then(response => response.json())
            .then(data => {
                if (data.rtsp_url) {
                    document.getElementById('rtspUrlInput').value = data.rtsp_url;
                    currentRtspUrl = data.rtsp_url;
                    document.getElementById('currentUrlDisplay').textContent = shortenUrl(data.rtsp_url);
                    document.getElementById('startBtn').disabled = false;
                    updateConnectionStatus('disconnected', 'RTSP URL loaded - Ready to connect');
                }
            })
            .catch(error => {
                console.error('Error loading RTSP URL:', error);
            });
    }
    
    function setPresetUrl(url) {
        document.getElementById('rtspUrlInput').value = url;
        // Auto-test the connection when preset is selected
        setTimeout(() => testConnection(), 500);
    }
    
    function shortenUrl(url) {
        if (url.length > 40) {
            return url.substring(0, 37) + '...';
        }
        return url;
    }
    
    function testConnection() {
        const url = document.getElementById('rtspUrlInput').value.trim();
        if (!url) {
            showError('Please enter an RTSP URL');
            return;
        }
        
        updateConnectionStatus('connecting', 'Testing connection...');
        document.getElementById('testConnectionBtn').disabled = true;
        document.getElementById('testConnectionBtn').innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Testing...';
        
        // Create a test image to check if the stream is accessible
        const testImg = new Image();
        let testTimeout = setTimeout(() => {
            testImg.onerror = null;
            testImg.onload = null;
            updateConnectionStatus('disconnected', 'Connection timeout');
            showError('Connection timeout. The stream might be slow to respond or unavailable.');
            document.getElementById('testConnectionBtn').disabled = false;
            document.getElementById('testConnectionBtn').innerHTML = '<i class="bi bi-plug"></i> Test';
        }, 10000);
        
        testImg.onload = function() {
            clearTimeout(testTimeout);
            updateConnectionStatus('connected', 'Connection test successful!');
            document.getElementById('startBtn').disabled = false;
            document.getElementById('testConnectionBtn').disabled = false;
            document.getElementById('testConnectionBtn').innerHTML = '<i class="bi bi-plug"></i> Test';
            hideError();
        };
        
        testImg.onerror = function() {
            clearTimeout(testTimeout);
            updateConnectionStatus('disconnected', 'Connection test failed');
            showError('Unable to connect to the stream. Please check:<br>‚Ä¢ URL is correct<br>‚Ä¢ Device is on same network<br>‚Ä¢ RTSP server is running<br>‚Ä¢ Firewall is not blocking');
            document.getElementById('testConnectionBtn').disabled = false;
            document.getElementById('testConnectionBtn').innerHTML = '<i class="bi bi-plug"></i> Test';
        };
        
        // Use a direct image request for testing
        testImg.src = url + '?t=' + new Date().getTime();
    }
    
    function saveRtspUrl() {
        const url = document.getElementById('rtspUrlInput').value.trim();
        if (!url) {
            showError('Please enter an RTSP URL');
            return;
        }
        
        // Basic URL validation
        if (!url.startsWith('rtsp://') && !url.startsWith('http://') && !url.startsWith('https://')) {
            showError('Please enter a valid URL starting with rtsp://, http://, or https://');
            return;
        }
        
        document.getElementById('saveUrlBtn').disabled = true;
        document.getElementById('saveUrlBtn').innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Saving...';
        
        fetch("{% url 'start_rtsp_monitoring' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({rtsp_url: url})
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Server responded with error: ' + response.status);
            }
            return response.json();
        })
        .then(data => {
            document.getElementById('saveUrlBtn').disabled = false;
            document.getElementById('saveUrlBtn').innerHTML = '<i class="bi bi-check-lg"></i> Save';
            
            if (data.status === 'success') {
                currentRtspUrl = url;
                document.getElementById('currentUrlDisplay').textContent = shortenUrl(url);
                document.getElementById('startBtn').disabled = false;
                updateConnectionStatus('disconnected', 'RTSP URL saved - Ready to connect');
                hideError();
                
                // Show success message
                const statusAlert = document.getElementById('statusAlert');
                statusAlert.className = "p-4 rounded-lg border-2 border-greenlight alert-safe";
                document.getElementById('statusText').innerHTML = "‚úÖ URL SAVED";
                document.getElementById('statusDetails').textContent = "URL saved successfully. Click Start Monitoring to begin.";
                
            } else {
                showError(data.error || 'Failed to save RTSP URL. Please check the URL format.');
            }
        })
        .catch(error => {
            console.error('Error saving RTSP URL:', error);
            document.getElementById('saveUrlBtn').disabled = false;
            document.getElementById('saveUrlBtn').innerHTML = '<i class="bi bi-check-lg"></i> Save';
            showError('Network error while saving URL: ' + error.message);
        });
    }
    
    function updateConnectionStatus(status, message) {
        const statusElement = document.getElementById('connectionStatus');
        const streamStatus = document.getElementById('streamStatus');
        const statusValue = document.getElementById('statusValue');
        
        statusElement.className = 'connection-status ' + status;
        statusElement.innerHTML = `<i class="fas ${status === 'connected' ? 'fa-check-circle' : status === 'connecting' ? 'fa-sync-alt animate-spin' : 'fa-times-circle'} mr-2"></i> ${message}`;
        streamStatus.textContent = status.charAt(0).toUpperCase() + status.slice(1);
        streamStatus.className = status === 'connected' ? 'text-greenlight' : status === 'connecting' ? 'text-gold' : 'text-alert';
        
        if (status === 'connected') {
            statusValue.innerHTML = '<span class="text-greenlight">üü¢ Online</span>';
        } else if (status === 'connecting') {
            statusValue.innerHTML = '<span class="text-gold">üü° Connecting</span>';
        } else {
            statusValue.innerHTML = '<span class="text-alert">üî¥ Offline</span>';
        }
    }
    
    function showError(message) {
        document.getElementById('errorDetails').innerHTML = message;
        document.getElementById('streamError').style.display = 'block';
    }
    
    function hideError() {
        document.getElementById('streamError').style.display = 'none';
    }
    
    function retryConnection() {
        if (streamRetries < maxRetries) {
            streamRetries++;
            hideError();
            startMonitoring();
        } else {
            updateConnectionStatus('disconnected', 'Max retries reached');
            showError('Maximum connection retries reached. Please:<br>‚Ä¢ Check your stream URL<br>‚Ä¢ Verify network connectivity<br>‚Ä¢ Restart the RTSP server');
        }
    }
    
    function startMonitoring() {
        if (!currentRtspUrl) {
            showError('No RTSP URL configured. Please save a URL first.');
            return;
        }
        
        console.log("Starting monitoring with URL:", currentRtspUrl);
        updateConnectionStatus('connecting', 'Starting RTSP monitoring...');
        
        fetch("{% url 'start_rtsp_monitoring' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({rtsp_url: currentRtspUrl})
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Server error: ' + response.status);
            }
            return response.json();
        })
        .then(data => {
            console.log("Monitoring started:", data);
            
            if (data.status !== 'success') {
                throw new Error(data.error || 'Failed to start monitoring');
            }
            
            // Set the stream source with cache busting
            const timestamp = new Date().getTime();
            const streamUrl = "{% url 'rtsp_stream' %}?t=" + timestamp;
            const videoElement = document.getElementById('videoStream');
            
            // Remove placeholder class when stream starts
            videoElement.classList.remove('placeholder-stream');
            
            videoElement.src = streamUrl;
            videoElement.onload = function() {
                console.log("Stream loaded successfully");
                updateConnectionStatus('connected', 'Live monitoring active');
                hideError();
                streamRetries = 0;
            };
            
            videoElement.onerror = function() {
                console.log("Stream loading error");
                updateConnectionStatus('disconnected', 'Stream connection failed');
                showError('Failed to load video stream. Possible issues:<br>‚Ä¢ Incorrect RTSP URL<br>‚Ä¢ Stream not available<br>‚Ä¢ Network connectivity issues<br>‚Ä¢ Server not responding');
            };
            
            document.getElementById('statusText').textContent = "üü¢ ACTIVE MONITORING";
            document.getElementById('statusDetails').textContent = "AI is analyzing live feed for crashes...";
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            
            isMonitoring = true;
            
            // Start status updates every 2 seconds
            clearInterval(statusUpdateInterval);
            statusUpdateInterval = setInterval(updateStatus, 2000);
            
            // Update timestamp continuously
            clearInterval(timestampInterval);
            timestampInterval = setInterval(updateTimestamp, 1000);
        })
        .catch(error => {
            console.error("Start monitoring error:", error);
            updateConnectionStatus('disconnected', 'Failed to start monitoring');
            showError('Failed to start monitoring: ' + error.message);
        });
    }
    
    function stopMonitoring() {
        console.log("Stopping monitoring...");
        
        fetch("{% url 'stop_rtsp_monitoring' %}")
            .then(response => response.text())
            .then(data => {
                console.log("Monitoring stopped:", data);
                
                // Clear the video stream and show placeholder
                const videoElement = document.getElementById('videoStream');
                videoElement.src = "";
                videoElement.classList.add('placeholder-stream');
                
                // Update UI
                document.getElementById('statusText').textContent = "‚èπ MONITORING STOPPED";
                document.getElementById('statusDetails').textContent = "Press start to begin monitoring";
                document.getElementById('startBtn').disabled = false;
                document.getElementById('stopBtn').disabled = true;
                
                updateConnectionStatus('disconnected', 'Monitoring stopped');
                isMonitoring = false;
                
                // Clear intervals
                clearInterval(statusUpdateInterval);
                clearInterval(timestampInterval);
                
                // Reset stats
                document.getElementById('latencyValue').textContent = "-- ms";
                document.getElementById('framesValue').textContent = "0";
                document.getElementById('statusValue').innerHTML = '<span class="text-alert">üî¥ Offline</span>';
            })
            .catch(error => {
                console.error("Stop monitoring error:", error);
            });
    }

    function updateStatus() {
        if (!isMonitoring) return;
        
        fetch("{% url 'get_detection_status' %}")
            .then(response => {
                if (!response.ok) throw new Error('Status fetch failed');
                return response.text();
            })
            .then(data => {
                console.log("Status response:", data);
                
                const statusAlert = document.getElementById('statusAlert');
                const statusText = document.getElementById('statusText');
                const statusDetails = document.getElementById('statusDetails');
                
                // Parse the response
                let crashDetected = false;
                let latency = "0";
                let frames = "0";
                
                if (data.includes("|")) {
                    const parts = data.split('|');
                    
                    parts.forEach(part => {
                        if (part.startsWith('Crash:')) {
                            crashDetected = part.split(':')[1] === "True";
                        } else if (part.startsWith('Latency:')) {
                            latency = part.split(':')[1];
                        } else if (part.startsWith('Frames:')) {
                            frames = part.split(':')[1];
                        }
                    });
                }
                
                // Update stats panel
                document.getElementById('latencyValue').textContent = latency + " ms";
                document.getElementById('framesValue').textContent = frames;
                
                // Update status alert
                if (crashDetected) {
                    statusAlert.className = "p-4 rounded-lg border-2 border-alert alert-crash";
                    statusText.innerHTML = "üö® CRASH DETECTED!";
                    statusDetails.textContent = `Emergency alert! Immediate attention required. Latency: ${latency}ms`;
                } else {
                    statusAlert.className = "p-4 rounded-lg border-2 border-greenlight alert-safe";
                    statusText.innerHTML = "‚úÖ ALL CLEAR";
                    statusDetails.textContent = `No crashes detected. System monitoring active. Latency: ${latency}ms`;
                }
            })
            .catch(error => {
                console.error("Status update error:", error);
                document.getElementById('latencyValue').textContent = "Error";
            });
    }
    
    function updateTimestamp() {
        const now = new Date();
        document.getElementById('lastUpdate').textContent = now.toLocaleTimeString();
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Clean up when page is closed
    window.addEventListener('beforeunload', function() {
        if (isMonitoring) {
            fetch("{% url 'stop_rtsp_monitoring' %}")
                .catch(error => console.error("Cleanup error:", error));
        }
    });
</script>
{% endblock %}